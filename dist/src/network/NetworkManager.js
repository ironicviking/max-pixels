import{NETWORK as e}from"../constants.js";export class NetworkManager{constructor(){this.socket=null,this.isConnected=!1,this.playerId=null,this.messageHandlers=new Map,this.connectionCallbacks=new Map,this.reconnectAttempts=0,this.maxReconnectAttempts=e.MAX_RECONNECT_ATTEMPTS,this.reconnectDelay=e.INITIAL_RECONNECT_DELAY,this.heartbeatInterval=null,this.lastHeartbeat=null,this.MessageTypes=e.MESSAGE_TYPES,console.log("NetworkManager initialized")}async connect(t=e.DEFAULT_SERVER_URL,s=null){return this.isConnected?(console.warn("Already connected to server"),!0):new Promise((n,a)=>{try{this.playerId=s||this.generatePlayerId(),this.socket=new WebSocket(t),this.socket.onopen=t=>{console.log("Connected to game server"),this.isConnected=!0,this.reconnectAttempts=0,this.reconnectDelay=e.INITIAL_RECONNECT_DELAY,this.startHeartbeat(),this.sendMessage(this.MessageTypes.PLAYER_JOIN,{playerId:this.playerId,timestamp:Date.now()}),this.triggerConnectionCallback("connected",t),n(!0)},this.socket.onmessage=e=>{this.handleMessage(e.data)},this.socket.onclose=e=>{console.log("Disconnected from game server:",e.code,e.reason),this.isConnected=!1,this.stopHeartbeat(),this.triggerConnectionCallback("disconnected",e),e.code!==WEBSOCKET_NORMAL_CLOSE&&this.reconnectAttempts<this.maxReconnectAttempts&&this.attemptReconnect(t)},this.socket.onerror=e=>{console.error("WebSocket error:",e),this.triggerConnectionCallback("error",e),this.isConnected||a(e)}}catch(e){console.error("Failed to create WebSocket connection:",e),a(e)}})}disconnect(){this.socket&&this.isConnected&&(this.sendMessage(this.MessageTypes.PLAYER_LEAVE,{playerId:this.playerId,timestamp:Date.now()}),this.socket.close(WEBSOCKET_NORMAL_CLOSE,"Client disconnect")),this.isConnected=!1,this.playerId=null,this.stopHeartbeat()}sendMessage(e,t={}){if(!this.isConnected||!this.socket)return console.warn("Cannot send message: not connected to server"),!1;const s={type:e,playerId:this.playerId,timestamp:Date.now(),data:t};try{return this.socket.send(JSON.stringify(s)),!0}catch(e){return console.error("Failed to send message:",e),!1}}handleMessage(e){try{const t=JSON.parse(e);if(t.type===this.MessageTypes.HEARTBEAT)return void(this.lastHeartbeat=Date.now());if(this.messageHandlers.has(t.type)){this.messageHandlers.get(t.type).forEach(e=>{try{e(t.data,t)}catch(e){console.error("Error in message handler:",e)}})}this.messageHandlers.has(t.type)||console.log("Unhandled message type:",t.type,t.data)}catch(e){console.error("Failed to parse message:",e)}}on(e,t){this.messageHandlers.has(e)||this.messageHandlers.set(e,[]),this.messageHandlers.get(e).push(t)}off(e,t){if(this.messageHandlers.has(e)){const s=this.messageHandlers.get(e),n=s.indexOf(t);n>-1&&s.splice(n,1)}}onConnection(e,t){this.connectionCallbacks.has(e)||this.connectionCallbacks.set(e,[]),this.connectionCallbacks.get(e).push(t)}sendPlayerMovement(e,t,s){return this.sendMessage(this.MessageTypes.PLAYER_MOVE,{position:e,velocity:t,rotation:s,timestamp:Date.now()})}sendPlayerFire(e,t,s="laser"){return this.sendMessage(this.MessageTypes.PLAYER_FIRE,{position:e,rotation:t,weaponType:s,timestamp:Date.now()})}sendChatMessage(e){return this.sendMessage(this.MessageTypes.CHAT_MESSAGE,{message:e,timestamp:Date.now()})}startHeartbeat(){this.lastHeartbeat=Date.now(),this.heartbeatInterval=setInterval(()=>{if(this.isConnected){this.sendMessage(this.MessageTypes.HEARTBEAT,{timestamp:Date.now()});Date.now()-this.lastHeartbeat>e.HEARTBEAT_TIMEOUT&&console.warn("Heartbeat timeout, connection may be lost")}},e.HEARTBEAT_INTERVAL)}stopHeartbeat(){this.heartbeatInterval&&(clearInterval(this.heartbeatInterval),this.heartbeatInterval=null)}attemptReconnect(t){this.reconnectAttempts++,console.log(`Attempting reconnection ${this.reconnectAttempts}/${this.maxReconnectAttempts}...`),setTimeout(async()=>{try{await this.connect(t,this.playerId)}catch(s){console.error("Reconnection failed:",s),this.reconnectAttempts<this.maxReconnectAttempts?(this.reconnectDelay=Math.min(this.reconnectDelay*e.RECONNECT_BACKOFF_MULTIPLIER,e.MAX_RECONNECT_DELAY),this.attemptReconnect(t)):(console.error("Max reconnection attempts reached"),this.triggerConnectionCallback("reconnectFailed",s))}},this.reconnectDelay)}triggerConnectionCallback(e,t){if(this.connectionCallbacks.has(e)){this.connectionCallbacks.get(e).forEach(e=>{try{e(t)}catch(e){console.error("Error in connection callback:",e)}})}}generatePlayerId(){return`player_${Date.now()}_${Math.random().toString(e.PLAYER_ID_RADIX).substr(e.PLAYER_ID_SUBSTR_START,e.PLAYER_ID_SUBSTR_LENGTH)}`}getStatus(){return{connected:this.isConnected,playerId:this.playerId,reconnectAttempts:this.reconnectAttempts,lastHeartbeat:this.lastHeartbeat,messageHandlers:Array.from(this.messageHandlers.keys())}}getNetworkStats(){return{connected:this.isConnected,playerId:this.playerId,reconnectAttempts:this.reconnectAttempts,maxReconnectAttempts:this.maxReconnectAttempts,lastHeartbeat:this.lastHeartbeat,handlerCount:this.messageHandlers.size,socketState:this.socket?this.socket.readyState:null,socketUrl:this.socket?this.socket.url:null}}}