import{GraphicsEngine as e}from"./graphics/GraphicsEngine.js";import{ParticleSystem as t}from"./graphics/ParticleSystem.js";import{InputManager as i}from"./input/InputManager.js";import{Camera as a}from"./graphics/Camera.js";import{AudioManager as n}from"./audio/AudioManager.js";import{AuthService as s}from"./auth/AuthService.js";import{AuthUI as o}from"./ui/AuthUI.js";import{TradingSystem as r}from"./trading/TradingSystem.js";import{TradingUI as h}from"./ui/TradingUI.js";import{SpaceNavigation as l}from"./navigation/SpaceNavigation.js";import{NetworkManager as d}from"./network/NetworkManager.js";import{RESOURCES as c,WEAPONS as p,PLAYER as y,UI as u,GRAPHICS as f}from"./constants.js";class MaxPixelsGame{constructor(){this.gameCanvas=document.getElementById("gameCanvas"),this.uiContainer=document.getElementById("ui"),this.graphics=new e(this.gameCanvas),this.particles=new t(this.graphics),this.input=new i,this.camera=new a(this.gameCanvas),this.audio=new n,this.auth=new s,this.authUI=null,this.trading=new r,this.tradingUI=new h(this.trading,this.auth),this.navigation=new l,this.network=new d,this.initializePlayerInventory(),this.initializeNetworking(),this.isInitialized=!1,this.player={x:960,y:540,velocity:{x:0,y:0},speed:200,radius:25,rotation:0,energy:p.MAX_ENERGY,lastEnergyRegenTime:Date.now(),health:y.MAX_HEALTH,lastHealthRegenTime:Date.now(),lastDamageTime:0,isInvincible:!1,invincibilityEndTime:0,isDead:!1,respawnTime:0},this.asteroids=[],this.stations=[],this.nearbyStation=null,this.nearbyJumpGate=null,this.interactionRange=80,this.otherPlayers=new Map,this.highlightedStation=null,this.highlightedJumpGate=null,this.activeThrusterSound=null,this.ambientSound=null,this.lastFireTime=0,this.lastEnergyRechargeSound=0,this.weaponChargeIndicator=null,this.lastServerUpdate=null,this.isPaused=!1,this.pauseMenuElement=null,console.log("Max-Pixels initializing..."),this.init()}async init(){try{await this.initializeGraphics(),await this.initializeUI(),this.initializeAudio(),this.startGameLoop(),this.isInitialized=!0,console.log("Max-Pixels initialized successfully"),await this.connectToMultiplayer(),this.hideLoadingScreen()}catch(e){console.error("Failed to initialize Max-Pixels:",e)}}async initializeGraphics(){console.log("Initializing graphics system...");this.graphics.createLayer("background",1),this.graphics.createLayer("game",5);this.loadCurrentSector();const e=this.graphics.createSpaceship(this.player.x,this.player.y,25,{id:"playerShip"});this.graphics.addToLayer("game",e),this.playerShip=e;const t=this.player.energy/p.MAX_ENERGY;this.weaponChargeIndicator=this.graphics.createWeaponChargeIndicator(this.player.x,this.player.y,t,{id:"weaponChargeIndicator"}),this.graphics.addToLayer("game",this.weaponChargeIndicator),this.camera.centerOn(this.player.x,this.player.y)}async initializeUI(){console.log("Initializing UI system..."),this.createHUD(),this.authUI=new o(this.auth,this.uiContainer)}initializeAudio(){console.log("Initializing audio system..."),this.ambientSound=this.audio.playAmbient(),document.addEventListener("click",()=>{this.audio.resumeAudioContext()},{once:!0})}startGameLoop(){console.log("Starting game loop...");const gameLoop=e=>{this.update(e),this.render(e),requestAnimationFrame(gameLoop)};requestAnimationFrame(gameLoop)}loadCurrentSector(){const e=this.navigation.getCurrentSector();if(!e)return;console.log(`Loading sector: ${e.name}`),this.clearSector();const t=this.graphics.getLayer("background");if(t&&(t.style.backgroundColor=e.backgroundColor),e.nebulaTypes&&e.nebulaTypes.length>0){const t=this.graphics.createNebulaBackground(e.bounds.width,e.bounds.height,e.nebulaTypes);this.graphics.addToLayer("background",t)}const i=this.graphics.createStarField(200);if(this.graphics.addToLayer("background",i),e.dustDensity&&e.dustDensity>0){const t=this.graphics.createCosmicDustField(e.bounds.width,e.bounds.height,{density:e.dustDensity,particleCount:120});this.graphics.addToLayer("background",t)}if(e.debrisDensity&&e.debrisDensity>0){const t=this.graphics.createSpaceDebrisField(e.bounds.width,e.bounds.height,{density:e.debrisDensity,debrisCount:10+Math.floor(e.bounds.width*e.bounds.height/2e5)});this.graphics.addToLayer("background",t)}this.createAsteroids(e.asteroids,e.bounds),e.planets.forEach(e=>{const t=this.graphics.createPlanet(e.x,e.y,e.radius,{surfaceColor:e.surfaceColor,coreColor:e.coreColor,atmosphereColor:e.atmosphereColor});this.graphics.addToLayer("game",t)}),this.stations=[],e.stations.forEach(e=>{const t=this.graphics.createSpaceStation(e.x,e.y,e.radius,{id:e.id});this.graphics.addToLayer("game",t),this.stations.push(e)}),e.jumpGates.forEach(e=>{const t=this.graphics.createJumpGate(e.x,e.y,e.radius,{id:e.id});this.graphics.addToLayer("game",t)})}clearSector(){this.highlightedStation=null,this.highlightedJumpGate=null,this.nearbyStation=null,this.nearbyJumpGate=null,this.asteroids=[],this.stations=[];const e=this.graphics.getLayer("background"),t=this.graphics.getLayer("game");if(e&&(e.innerHTML=""),t){const e=t.querySelector("#playerShip"),i=Array.from(t.querySelectorAll('[id^="otherPlayer_"]'));t.innerHTML="",e&&t.appendChild(e),i.forEach(e=>t.appendChild(e))}}createAsteroids(e,t){for(let i=0;i<e;i++){const e=Math.random()*t.width,i=Math.random()*t.height,a=30*Math.random()+10,n=`asteroid_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,s={id:n,x:e,y:i,size:a};this.asteroids.push(s);const o=this.graphics.createAsteroid(e,i,a,{id:n});this.graphics.addToLayer("background",o)}}checkCollisions(){for(let e=0;e<this.asteroids.length;e++){const t=this.asteroids[e];if(Math.sqrt(Math.pow(this.player.x-t.x,2)+Math.pow(this.player.y-t.y,2))<this.player.radius+t.size){this.handleCollision(t);break}}}handleCollision(e){this.takeDamage(y.ASTEROID_COLLISION_DAMAGE,"asteroid")&&(this.particles.createExplosionEffect(e.x,e.y,{particleCount:30,colors:["#ff4444","#ff8800","#ffff00","#ffffff","#ffaa44"],velocity:{min:60,max:120}}),this.particles.createSparksEffect(this.player.x,this.player.y),console.log("Collision with asteroid detected!"))}checkStationProximity(){let e=null,t=1/0;for(let i of this.stations){const a=Math.sqrt(Math.pow(this.player.x-i.x,2)+Math.pow(this.player.y-i.y,2));a<this.interactionRange&&a<t&&(t=a,e=i)}if(e!==this.highlightedStation){if(this.highlightedStation){const e=this.graphics.svg.querySelector(`#${this.highlightedStation.id}`);e&&this.graphics.removeProximityGlow(e)}if(e){const t=this.graphics.svg.querySelector(`#${e.id}`);t&&this.graphics.addProximityGlow(t,u.PROXIMITY_GLOW_COLOR)}this.highlightedStation=e}e!==this.nearbyStation&&(this.nearbyStation=e,this.updateInteractionPrompt())}interactWithStation(e){console.log(`Interacting with ${e.name}!`),"trading"===e.type&&this.openTradingInterface(e)}openTradingInterface(e){console.log(`Opening trading interface for ${e.name}`),this.tradingUI.openTradingInterface(e)}checkJumpGateProximity(){const e=this.navigation.checkJumpGateProximity(this.player.x,this.player.y,this.interactionRange);if(e!==this.highlightedJumpGate){if(this.highlightedJumpGate){const e=this.graphics.svg.querySelector(`#${this.highlightedJumpGate.id}`);e&&this.graphics.removeProximityGlow(e)}if(e){const t=this.graphics.svg.querySelector(`#${e.id}`);t&&this.graphics.addProximityGlow(t,u.PROXIMITY_GLOW_COLOR)}this.highlightedJumpGate=e}e!==this.nearbyJumpGate&&(this.nearbyJumpGate=e,this.updateInteractionPrompt())}async jumpThroughGate(e){if(!this.navigation.canJump())return void console.log("Jump on cooldown");console.log(`Jumping through ${e.name} to ${e.destination}`);await this.navigation.jumpToSector(e.destination,(e,t)=>{console.log(`Starting jump from ${e} to ${t}`),this.showJumpAnimation()},(e,t)=>{console.log(`Jump complete to ${e}`),this.onSectorChanged(e,t)})||console.error("Jump failed")}showJumpAnimation(){const e=document.createElement("div");e.style.cssText="\n            position: fixed;\n            top: 0; left: 0;\n            width: 100%; height: 100%;\n            background: white;\n            opacity: 0.8;\n            z-index: 1000;\n            pointer-events: none;\n        ",document.body.appendChild(e),setTimeout(()=>{e.style.transition="opacity 0.5s",e.style.opacity="0",setTimeout(()=>{document.body.removeChild(e)},500)},100)}onSectorChanged(e,t){const i=this.navigation.getPlayerSpawnPosition(e);this.player.x=i.x,this.player.y=i.y,this.player.velocity.x=0,this.player.velocity.y=0,this.updatePlayerBounds(),this.loadCurrentSector(),this.graphics.addToLayer("game",this.playerShip),this.playerShip.setAttribute("transform",`translate(${this.player.x}, ${this.player.y}) rotate(${this.player.rotation})`),this.camera.centerOn(this.player.x,this.player.y),console.log(`Now in ${t.name}`)}updateInteractionPrompt(){const e=document.getElementById("interaction-prompt"),t=document.getElementById("station-name"),i=document.getElementById("interaction-text");this.nearbyStation?(e.style.display="block",t.textContent=this.nearbyStation.name,i.textContent="Press F to Dock"):this.nearbyJumpGate?(e.style.display="block",t.textContent=this.nearbyJumpGate.name,i.textContent="Press F to Jump"):e.style.display="none"}update(e){this.handleInput(),this.isPaused||(this.updatePlayer(),this.updateEnergy(),this.updateHealth(),this.updateThrusterEffects(),this.updateCamera(),this.checkCollisions(),this.checkStationProximity(),this.checkJumpGateProximity(),this.input.update())}handleInput(){if(this.input.justPressed("menu"))return void this.togglePause();if(this.isPaused)return;const e=this.input.getMovementVector();this.player.velocity.x=e.x,this.player.velocity.y=e.y,this.input.isPressed("boost")&&(this.player.velocity.x*=2,this.player.velocity.y*=2),this.input.justPressed("KeyQ")&&this.camera.zoomOut(),this.input.justPressed("KeyE")&&this.camera.zoomIn(),this.input.justPressed("KeyF")&&(this.nearbyStation?this.interactWithStation(this.nearbyStation):this.nearbyJumpGate&&this.jumpThroughGate(this.nearbyJumpGate)),this.input.isPressed("action")&&this.fireLaser()}updatePlayer(){const e=y.DELTA_TIME;if(0!==this.player.velocity.x||0!==this.player.velocity.y){let e=180*Math.atan2(this.player.velocity.x,-this.player.velocity.y)/Math.PI-this.player.rotation;e>180&&(e-=360),e<-180&&(e+=360),this.player.rotation+=e*y.ROTATION_SMOOTHING,this.player.rotation>180&&(this.player.rotation-=360),this.player.rotation<-180&&(this.player.rotation+=360)}this.player.x+=this.player.velocity.x*this.player.speed*e,this.player.y+=this.player.velocity.y*this.player.speed*e;const t=this.navigation.getSectorBounds();this.player.x=Math.max(25,Math.min(t.width-25,this.player.x)),this.player.y=Math.max(25,Math.min(t.height-25,this.player.y)),this.playerShip.setAttribute("transform",`translate(${this.player.x}, ${this.player.y}) rotate(${this.player.rotation})`),this.weaponChargeIndicator&&this.weaponChargeIndicator.setAttribute("transform",`translate(${this.player.x}, ${this.player.y})`),this.sendPlayerUpdate()}updatePlayerBounds(){const e=this.navigation.getSectorBounds();this.player.x=Math.max(25,Math.min(e.width-25,this.player.x)),this.player.y=Math.max(25,Math.min(e.height-25,this.player.y))}updateEnergy(){const e=Date.now(),t=(e-this.player.lastEnergyRegenTime)/1e3,i=this.player.energy;if(this.player.energy<p.MAX_ENERGY&&(this.player.energy=Math.min(p.MAX_ENERGY,this.player.energy+p.ENERGY_REGEN_RATE*t),i<p.ENERGY_RECHARGE_SOUND_THRESHOLD&&this.player.energy>=p.ENERGY_RECHARGE_SOUND_THRESHOLD&&e-this.lastEnergyRechargeSound>2e3&&(this.audio.playWeaponRecharge(),this.lastEnergyRechargeSound=e,this.showEnergyRechargeEffect(),console.log("Weapon energy recharged!"))),this.player.lastEnergyRegenTime=e,this.weaponChargeIndicator){const e=this.player.energy/p.MAX_ENERGY;this.graphics.updateWeaponChargeIndicator(this.weaponChargeIndicator,e)}}updateHealth(){const e=Date.now();if(this.player.isInvincible&&e>this.player.invincibilityEndTime&&(this.player.isInvincible=!1,this.removeInvincibilityEffect()),this.player.isDead&&e>this.player.respawnTime)return void this.respawnPlayer();if(this.player.isDead||e-this.player.lastDamageTime<y.HEALTH_REGEN_DELAY)return;const t=(e-this.player.lastHealthRegenTime)/1e3,i=this.player.health;this.player.health<y.MAX_HEALTH&&(this.player.health=Math.min(y.MAX_HEALTH,this.player.health+y.HEALTH_REGEN_RATE*t),i<y.MAX_HEALTH&&this.player.health>=y.MAX_HEALTH&&(this.showHealthRegenEffect(),console.log("Health fully restored!"))),this.player.lastHealthRegenTime=e}takeDamage(e,t="unknown"){return!this.player.isInvincible&&!this.player.isDead&&(this.player.health-=e,this.player.lastDamageTime=Date.now(),this.showDamageEffect(),this.camera.shake(20,600),this.audio.playCollision(.9),console.log(`Player took ${e} damage from ${t}. Health: ${Math.round(this.player.health)}/${y.MAX_HEALTH}`),this.player.health<=0?(this.playerDeath(),!0):(this.player.isInvincible=!0,this.player.invincibilityEndTime=Date.now()+y.INVINCIBILITY_DURATION,this.showInvincibilityEffect(),!0))}playerDeath(){this.player.health=0,this.player.isDead=!0,this.player.respawnTime=Date.now()+y.DEATH_RESPAWN_DELAY,this.player.velocity.x=0,this.player.velocity.y=0,console.log("Player died! Respawning in",y.DEATH_RESPAWN_DELAY/1e3,"seconds..."),this.particles.createExplosionEffect(this.player.x,this.player.y,{particleCount:50,colors:["#ff0000","#ff4444","#ffaa00","#ffffff","#ff8800"],velocity:{min:100,max:200}}),this.playerShip.style.opacity="0",this.showDeathScreen()}respawnPlayer(){this.player.health=y.MAX_HEALTH,this.player.energy=p.MAX_ENERGY,this.player.isDead=!1,this.player.x=y.SPAWN_X,this.player.y=y.SPAWN_Y,this.player.velocity.x=0,this.player.velocity.y=0,this.player.rotation=0,this.player.isInvincible=!0,this.player.invincibilityEndTime=Date.now()+y.INVINCIBILITY_DURATION,this.playerShip.setAttribute("transform",`translate(${this.player.x}, ${this.player.y}) rotate(${this.player.rotation})`),this.playerShip.style.opacity="1",this.camera.centerOn(this.player.x,this.player.y),this.showRespawnEffect(),this.showInvincibilityEffect(),this.hideDeathScreen(),console.log("Player respawned!")}showDamageEffect(){const e=this.playerShip.querySelector("path");if(e){const t=e.getAttribute("fill")||"#4a90e2";e.setAttribute("fill","#ff4444"),setTimeout(()=>{e.setAttribute("fill",t)},200)}}showInvincibilityEffect(){let e=setInterval(()=>{if(!this.player.isInvincible)return clearInterval(e),void(this.playerShip.style.opacity="1");this.playerShip.style.opacity="0.4"===this.playerShip.style.opacity?"1":"0.4"},200)}removeInvincibilityEffect(){this.playerShip.style.opacity="1"}showHealthRegenEffect(){this.particles.createSparksEffect(this.player.x,this.player.y,{colors:["#00ff00","#44ff44","#88ff88"],particleCount:8})}showRespawnEffect(){this.particles.createSparksEffect(this.player.x,this.player.y,{colors:["#00ffff","#44ffff","#88ffff","#ffffff"],particleCount:20})}showDeathScreen(){let e=document.getElementById("death-screen");if(!e){e=document.createElement("div"),e.id="death-screen",e.innerHTML='\n                <div class="death-content">\n                    <h2>SHIP DESTROYED</h2>\n                    <p>Respawning...</p>\n                </div>\n            ',e.style.cssText="\n                position: fixed;\n                top: 0; left: 0;\n                width: 100%; height: 100%;\n                background: rgba(255, 0, 0, 0.3);\n                display: flex;\n                align-items: center;\n                justify-content: center;\n                z-index: 1000;\n                pointer-events: none;\n            ";const t=document.createElement("style");t.textContent="\n                .death-content {\n                    text-align: center;\n                    color: #ffffff;\n                    font-family: 'Courier New', monospace;\n                    text-shadow: 0 0 10px #ff0000;\n                }\n                .death-content h2 {\n                    font-size: 3em;\n                    margin: 0 0 20px 0;\n                    color: #ff4444;\n                }\n                .death-content p {\n                    font-size: 1.5em;\n                    margin: 0;\n                }\n            ",document.head.appendChild(t),document.body.appendChild(e)}e.style.display="flex"}hideDeathScreen(){const e=document.getElementById("death-screen");e&&(e.style.display="none")}showEnergyRechargeEffect(){const e=document.getElementById("energy-fill");if(e){const t=e.style.backgroundColor,i=e.style.boxShadow;e.style.backgroundColor="#00ffff",e.style.boxShadow="0 0 8px #00ffff",e.style.transition="all 0.1s ease-in-out",setTimeout(()=>{e.style.backgroundColor=t||"#44ff44",e.style.boxShadow=i||"",e.style.transition=""},150)}this.particles.createEnergyRechargeEffect(this.player.x,this.player.y,{colors:["#00ffff","#44ffff","#88ffff","#aaccff","#ffffff"],particleCount:12,particleLife:1200,velocity:{min:30,max:60},size:{min:2,max:5}})}updateThrusterEffects(){const e=this.input.getMovementVector(),t=this.input.isPressed("boost"),i=0!==e.x||0!==e.y;if(this.graphics.updateSpaceshipThrusters(this.playerShip,e,t),i){const i=t?1:.6;if(e.y>0){const e=this.player.x,t=this.player.y+30,a=this.player.rotation*Math.PI/180;this.particles.createThrusterTrail(e,t,a,i)}if(0!==e.x){const t=.7*i,a=this.player.rotation*Math.PI/180;if(e.x>0){const e=this.player.x-20*Math.cos(a+Math.PI/2),i=this.player.y-20*Math.sin(a+Math.PI/2);this.particles.createThrusterTrail(e,i,a-Math.PI/2,t)}if(e.x<0){const e=this.player.x+20*Math.cos(a+Math.PI/2),i=this.player.y+20*Math.sin(a+Math.PI/2);this.particles.createThrusterTrail(e,i,a+Math.PI/2,t)}}}if(i){const e=t?1:.6;this.activeThrusterSound?this.activeThrusterSound.setVolume(.6*e):this.activeThrusterSound=this.audio.playThruster(e)}else this.activeThrusterSound&&(this.activeThrusterSound.fadeOut(.3),this.activeThrusterSound=null)}updateCamera(){this.camera.follow(this.player.x,this.player.y),this.camera.update()}render(e){this.updateHUD()}createHUD(){const e=`\n            <div class="hud">\n                <div class="hud-section position">\n                    <h3>Position</h3>\n                    <div>X: <span id="player-x">0</span></div>\n                    <div>Y: <span id="player-y">0</span></div>\n                </div>\n                <div class="hud-section speed">\n                    <h3>Speed</h3>\n                    <div>Velocity: <span id="player-speed">0</span></div>\n                </div>\n                <div class="hud-section health">\n                    <h3>Health</h3>\n                    <div>HP: <span id="player-health">100</span>/100</div>\n                    <div class="health-bar">\n                        <div id="health-fill" class="health-fill"></div>\n                    </div>\n                </div>\n                <div class="hud-section energy">\n                    <h3>Energy</h3>\n                    <div>Level: <span id="player-energy">100</span>/100</div>\n                    <div class="energy-bar">\n                        <div id="energy-fill" class="energy-fill"></div>\n                    </div>\n                </div>\n                <div class="hud-section inventory">\n                    <h3>Inventory</h3>\n                    <div>Iron: <span id="inventory-iron">0</span></div>\n                    <div>Copper: <span id="inventory-copper">0</span></div>\n                </div>\n                <div class="hud-section controls">\n                    <h3>Controls</h3>\n                    <div>WASD / Arrow Keys: Move</div>\n                    <div>Shift: Boost</div>\n                    <div>Space: Fire Laser</div>\n                    <div>Q: Zoom Out | E: Zoom In</div>\n                </div>\n                <div class="hud-section camera">\n                    <h3>Camera</h3>\n                    <div>Zoom: <span id="camera-zoom">1.0</span>x</div>\n                </div>\n                <div class="hud-section particles">\n                    <h3>Particles</h3>\n                    <div>Active: <span id="particle-count">0</span></div>\n                </div>\n                <div class="hud-section radar">\n                    <h3>Local Radar</h3>\n                    <div class="radar-container">\n                        <svg id="radar-display" width="${f.RADAR_DEFAULT_SIZE}" height="${f.RADAR_DEFAULT_SIZE}"></svg>\n                    </div>\n                </div>\n                <div class="hud-section interaction" id="interaction-prompt" style="display: none;">\n                    <h3>Station Nearby</h3>\n                    <div id="interaction-text">Press F to Dock</div>\n                    <div id="station-name"></div>\n                </div>\n            </div>\n        `;this.uiContainer.insertAdjacentHTML("beforeend",e),this.initializeRadar()}initializeRadar(){const t=document.getElementById("radar-display");if(!t)return;this.radarEngine=new e(t);const i=f.RADAR_DEFAULT_SIZE/2,a=f.RADAR_DEFAULT_SIZE/2,n=f.RADAR_DEFAULT_SIZE/2-5;this.radar=this.radarEngine.createRadar(i,a,n,{id:"hud-radar",backgroundColor:"#001122",borderColor:"#00ff88",gridColor:"#004466",scanlineColor:"#00ff88"}),this.radarEngine.addToLayer("ui",this.radar)}updateRadar(){if(!this.radar)return;const e=this.radar.querySelector("#hud-radar_blips");if(!e)return;e.innerHTML="";const t=f.RADAR_DEFAULT_SIZE/2,i=f.RADAR_DEFAULT_SIZE/2,a=f.RADAR_DEFAULT_SIZE/2-5,n=f.RADAR_RANGE,s=this.radarEngine.createCircle(t,i,f.RADAR_PLAYER_BLIP_SIZE,{fill:"#00ff88",opacity:1,id:"player-blip"});e.appendChild(s),this.asteroids.forEach(s=>{if(Math.sqrt(Math.pow(s.x-this.player.x,2)+Math.pow(s.y-this.player.y,2))<=n){const o=(s.x-this.player.x)/n*a,r=(s.y-this.player.y)/n*a,h=t+o,l=i+r,d=this.radarEngine.createCircle(h,l,f.RADAR_ASTEROID_BLIP_SIZE,{fill:"#cc8800",opacity:.8});e.appendChild(d)}}),this.stations.forEach(s=>{if(Math.sqrt(Math.pow(s.x-this.player.x,2)+Math.pow(s.y-this.player.y,2))<=n){const o=(s.x-this.player.x)/n*a,r=(s.y-this.player.y)/n*a,h=t+o,l=i+r,d=this.radarEngine.createCircle(h,l,f.RADAR_STATION_BLIP_SIZE,{fill:"#00aaff",opacity:1});e.appendChild(d)}}),this.otherPlayers.forEach((s,o)=>{if(Math.sqrt(Math.pow(s.x-this.player.x,2)+Math.pow(s.y-this.player.y,2))<=n){const o=(s.x-this.player.x)/n*a,r=(s.y-this.player.y)/n*a,h=t+o,l=i+r,d=this.radarEngine.createCircle(h,l,f.RADAR_PLAYER_BLIP_SIZE,{fill:s.color||"#ff6b35",opacity:.9});e.appendChild(d)}})}updateHUD(){document.getElementById("player-x").textContent=Math.round(this.player.x),document.getElementById("player-y").textContent=Math.round(this.player.y);const e=Math.sqrt(this.player.velocity.x**2+this.player.velocity.y**2)*this.player.speed;document.getElementById("player-speed").textContent=Math.round(e);const t=Math.round(this.player.health),i=this.player.health/y.MAX_HEALTH*100;document.getElementById("player-health").textContent=t;const a=document.getElementById("health-fill");a&&(a.style.width=i+"%",this.player.health<=y.CRITICAL_HEALTH_THRESHOLD?(a.style.backgroundColor="#ff0000",a.style.boxShadow="0 0 8px #ff0000"):this.player.health<=y.LOW_HEALTH_THRESHOLD?(a.style.backgroundColor="#ff4444",a.style.boxShadow="0 0 4px #ff4444"):this.player.health<.5*y.MAX_HEALTH?(a.style.backgroundColor="#ffaa44",a.style.boxShadow=""):(a.style.backgroundColor="#44ff44",a.style.boxShadow=""));const n=Math.round(this.player.energy),s=this.player.energy/p.MAX_ENERGY*100;document.getElementById("player-energy").textContent=n;const o=document.getElementById("energy-fill");o&&(o.style.width=s+"%",this.player.energy<p.LOW_ENERGY_THRESHOLD?o.style.backgroundColor="#ff4444":this.player.energy<.5*p.MAX_ENERGY?o.style.backgroundColor="#ffaa44":o.style.backgroundColor="#44ff44"),document.getElementById("camera-zoom").textContent=this.camera.zoom.toFixed(1);const r=this.particles.getDebugInfo();document.getElementById("particle-count").textContent=r.activeParticles;const h=this.trading.getPlayerItemQuantity("ore-iron"),l=this.trading.getPlayerItemQuantity("ore-copper");document.getElementById("inventory-iron").textContent=h,document.getElementById("inventory-copper").textContent=l,this.updateRadar()}fireLaser(){const e=Date.now();if(e-this.lastFireTime<p.LASER_FIRE_RATE)return;if(this.player.energy<p.ENERGY_COST)return void console.log("Insufficient energy to fire laser!");this.player.energy-=p.ENERGY_COST,this.lastFireTime=e;const t=this.player.rotation*Math.PI/180,i=this.player.x+Math.sin(t)*this.player.radius,a=this.player.y-Math.cos(t)*this.player.radius,n=this.player.x+Math.sin(t)*p.LASER_RANGE,s=this.player.y-Math.cos(t)*p.LASER_RANGE,o=this.graphics.createLaserBeam(i,a,n,s,{color:p.LASER_COLOR,glowColor:p.LASER_GLOW_COLOR,width:p.LASER_WIDTH,duration:p.LASER_DURATION});if(this.graphics.addToLayer("game",o),this.checkLaserHits(i,a,n,s),this.audio.playLaser(.4),this.weaponChargeIndicator){const e=this.player.energy/p.MAX_ENERGY;this.graphics.updateWeaponChargeIndicator(this.weaponChargeIndicator,e)}this.sendFireAction(),console.log("Laser fired!")}checkLaserHits(e,t,i,a){for(let n=this.asteroids.length-1;n>=0;n--){const s=this.asteroids[n],o=Math.min(e,i)-s.size,r=Math.max(e,i)+s.size,h=Math.min(t,a)-s.size,l=Math.max(t,a)+s.size;if(s.x<o||s.x>r||s.y<h||s.y>l)continue;if(this.squaredDistanceFromPointToLineSegment(s.x,s.y,e,t,i,a)<s.size*s.size){const e=this.graphics.createLaserImpact(s.x,s.y,{size:p.IMPACT_SIZE,color:p.IMPACT_COLOR,ringColor:p.IMPACT_RING_COLOR,duration:p.IMPACT_DURATION});this.graphics.addToLayer("game",e);const t=this.graphics.createAsteroidDamageIndicator(s.x,s.y,s.size,{ringColor:"#ff6644",ringOpacity:.9,duration:"2.0s",ringWidth:2});this.graphics.addToLayer("game",t),this.particles.createExplosionEffect(s.x,s.y,{particleCount:p.HIT_PARTICLE_COUNT,colors:["#ff8800","#ffff00","#ff4444","#ffffff","#ffcc00","#ff6600"],velocity:{min:p.HIT_VELOCITY_MIN,max:p.HIT_VELOCITY_MAX}}),this.particles.createDebrisField(s.x,s.y,s.size),this.dropAsteroidResources(s),this.destroyAsteroid(s.id),console.log("Asteroid destroyed!");break}}}distanceFromPointToLine(e,t,i,a,n,s){const o=Math.sqrt(Math.pow(n-i,2)+Math.pow(s-a,2));if(0===o)return Math.sqrt(Math.pow(e-i,2)+Math.pow(t-a,2));const r=Math.max(0,Math.min(1,((e-i)*(n-i)+(t-a)*(s-a))/(o*o))),h=i+r*(n-i),l=a+r*(s-a);return Math.sqrt(Math.pow(e-h,2)+Math.pow(t-l,2))}squaredDistanceFromPointToLineSegment(e,t,i,a,n,s){const o=n-i,r=s-a,h=o*o+r*r;if(0===h){const n=e-i,s=t-a;return n*n+s*s}const l=Math.max(0,Math.min(1,((e-i)*o+(t-a)*r)/h)),d=e-(i+l*o),c=t-(a+l*r);return d*d+c*c}destroyAsteroid(e){const t=this.asteroids.findIndex(t=>t.id===e);-1!==t&&this.asteroids.splice(t,1);const i=this.graphics.getLayer("background");if(i){const t=i.querySelector(`#${e}`);t&&this.graphics.remove(t)}}dropAsteroidResources(e){const t=c.ASTEROID_RESOURCE_TYPES[Math.floor(Math.random()*c.ASTEROID_RESOURCE_TYPES.length)],i=Math.floor(e.size/c.RESOURCE_SIZE_DIVIDER)+c.RESOURCE_BASE_QUANTITY;this.trading.addPlayerItem(t,i),this.showResourcePickup(e.x,e.y,t,i),console.log(`Collected ${i}x ${t} from asteroid`)}showResourcePickup(e,t,i,a){const n=document.createElement("div");n.style.cssText=`\n            position: absolute;\n            left: ${e}px;\n            top: ${t}px;\n            color: #00ff00;\n            font-family: monospace;\n            font-size: 14px;\n            font-weight: bold;\n            pointer-events: none;\n            z-index: 1000;\n            text-shadow: 0 0 4px #000;\n            transform: translate(-50%, -50%);\n        `;const s="ore-iron"===i?"Iron":"Copper";n.textContent=`+${a} ${s}`,document.body.appendChild(n);let o=1,r=0;const animateResource=()=>{o-=c.PICKUP_OPACITY_DECAY,r-=c.PICKUP_FLOAT_SPEED,n.style.opacity=o,n.style.transform=`translate(-50%, -50%) translateY(${r}px)`,o>0?requestAnimationFrame(animateResource):document.body.removeChild(n)};requestAnimationFrame(animateResource)}initializePlayerInventory(){this.trading.addPlayerItem("ore-iron",10),this.trading.addPlayerItem("food-rations",5)}hideLoadingScreen(){const e=this.uiContainer.querySelector(".loading");e&&(e.style.opacity="0",setTimeout(()=>{e.style.display="none"},1e3))}initializeNetworking(){this.network.onConnection("connected",()=>{console.log("Connected to multiplayer server"),this.showNetworkStatus("Connected","success")}),this.network.onConnection("disconnected",()=>{console.log("Disconnected from multiplayer server"),this.showNetworkStatus("Disconnected","warning")}),this.network.onConnection("error",e=>{console.error("Network connection error:",e),this.showNetworkStatus("Connection Error","error")}),this.network.onConnection("reconnectFailed",()=>{console.error("Failed to reconnect to server"),this.showNetworkStatus("Offline Mode","info")}),this.network.on(this.network.MessageTypes.PLAYER_JOIN,e=>{this.handlePlayerJoin(e)}),this.network.on(this.network.MessageTypes.PLAYER_LEAVE,e=>{this.handlePlayerLeave(e)}),this.network.on(this.network.MessageTypes.PLAYER_MOVE,e=>{this.handlePlayerMove(e)}),this.network.on(this.network.MessageTypes.PLAYER_FIRE,e=>{this.handlePlayerFire(e)}),this.network.on(this.network.MessageTypes.CHAT_MESSAGE,e=>{this.handleChatMessage(e)}),this.network.on(this.network.MessageTypes.GAME_STATE,e=>{this.handleGameState(e)})}async connectToMultiplayer(e="ws://localhost:8080"){try{const t=this.auth.getCurrentUser()?.username||null;return await this.network.connect(e,t),!0}catch(e){return console.error("Failed to connect to multiplayer server:",e),this.showNetworkStatus("Failed to Connect","error"),!1}}disconnectFromMultiplayer(){this.network.disconnect()}sendPlayerUpdate(){this.network.isConnected&&this.network.sendPlayerMovement({x:this.player.x,y:this.player.y},this.player.velocity,this.player.rotation)}sendFireAction(){this.network.isConnected&&this.network.sendPlayerFire({x:this.player.x,y:this.player.y},this.player.rotation,"laser")}handlePlayerJoin(e){console.log(`Player ${e.playerId} joined the game`);const t=["#ff6b35","#f7931e","#ffd700","#32cd32","#00ced1","#9370db","#ff69b4"],i=t[Array.from(this.otherPlayers.keys()).length%t.length],a={id:e.playerId,x:e.position?.x||500,y:e.position?.y||500,rotation:e.rotation||0,color:i,lastUpdate:Date.now()},n=this.graphics.createOtherPlayerShip(a.x,a.y,e.playerId,i);this.graphics.addToLayer("game",n),this.otherPlayers.set(e.playerId,a),console.log(`Added visual representation for player ${e.playerId}`)}handlePlayerLeave(e){console.log(`Player ${e.playerId} left the game`);const t=this.graphics.svg.querySelector(`#otherPlayer_${e.playerId}`);t&&(this.graphics.remove(t),console.log(`Removed visual representation for player ${e.playerId}`)),this.otherPlayers.delete(e.playerId)}handlePlayerMove(e){const t=this.otherPlayers.get(e.playerId);if(!t)return;t.x=e.position.x,t.y=e.position.y,t.rotation=e.rotation||t.rotation,t.lastUpdate=Date.now();const i=this.graphics.svg.querySelector(`#otherPlayer_${e.playerId}`);i&&i.setAttribute("transform",`translate(${t.x}, ${t.y}) rotate(${t.rotation})`),console.log(`Updated player ${e.playerId} position to (${t.x}, ${t.y})`)}handlePlayerFire(e){const t=this.otherPlayers.get(e.playerId);if(!t)return;console.log(`Player ${e.playerId} fired weapon`);const i=t.rotation*Math.PI/180,a=t.x+20*Math.sin(i),n=t.y-20*Math.cos(i),s=t.x+400*Math.sin(i),o=t.y-400*Math.cos(i),r=this.graphics.createLaserBeam(a,n,s,o,{color:"#00ff88",glowColor:"#88ffaa",width:3,duration:300});this.graphics.addToLayer("game",r),this.audio.playLaser(.2)}handleChatMessage(e){console.log(`Chat from ${e.playerId}: ${e.message}`),this.displayChatMessage(e.playerId,e.message)}displayChatMessage(e,t){let i=document.getElementById("chat-container");i||(i=this.createChatContainer());const a=document.createElement("div");a.className="chat-message",a.innerHTML=`<span class="chat-player">${e}:</span> <span class="chat-text">${t}</span>`,i.appendChild(a),i.scrollTop=i.scrollHeight;const n=i.querySelectorAll(".chat-message");n.length>50&&n[0].remove(),setTimeout(()=>{a.classList.add("fade-out"),setTimeout(()=>{a.parentNode&&a.remove()},1e3)},1e4)}createChatContainer(){const e=document.createElement("div");e.id="chat-container",e.className="chat-container";const t=document.createElement("style");return t.textContent="\n            .chat-container {\n                position: absolute;\n                bottom: 20px;\n                left: 20px;\n                width: 350px;\n                height: 200px;\n                background: rgba(0, 50, 100, 0.9);\n                border: 1px solid #4488ff;\n                border-radius: 8px;\n                padding: 10px;\n                overflow-y: auto;\n                backdrop-filter: blur(5px);\n                z-index: 100;\n                font-family: 'Courier New', monospace;\n                font-size: 13px;\n            }\n            \n            .chat-message {\n                margin-bottom: 8px;\n                padding: 4px 8px;\n                background: rgba(255, 255, 255, 0.05);\n                border-radius: 4px;\n                border-left: 3px solid #4488ff;\n                opacity: 1;\n                transition: opacity 1s ease-out;\n            }\n            \n            .chat-message.fade-out {\n                opacity: 0;\n            }\n            \n            .chat-player {\n                color: #88ccff;\n                font-weight: bold;\n            }\n            \n            .chat-text {\n                color: #ffffff;\n                word-wrap: break-word;\n            }\n            \n            .chat-container::-webkit-scrollbar {\n                width: 6px;\n            }\n            \n            .chat-container::-webkit-scrollbar-track {\n                background: rgba(255, 255, 255, 0.1);\n                border-radius: 3px;\n            }\n            \n            .chat-container::-webkit-scrollbar-thumb {\n                background: #4488ff;\n                border-radius: 3px;\n            }\n            \n            .chat-container::-webkit-scrollbar-thumb:hover {\n                background: #88ccff;\n            }\n        ",document.head.appendChild(t),document.getElementById("ui").appendChild(e),e}handleGameState(e){e&&"object"==typeof e?(console.log("Received game state update:",e),e.players&&"object"==typeof e.players&&this.updateOtherPlayersFromState(e.players),e.gameObjects&&Array.isArray(e.gameObjects)&&this.updateGameObjectsFromState(e.gameObjects),e.lastUpdate&&(this.lastServerUpdate=e.lastUpdate,console.log(`Game state synced with server (timestamp: ${e.lastUpdate})`))):console.warn("Invalid game state data received:",e)}updateOtherPlayersFromState(e){let t;if(e instanceof Map)t=e;else{if("object"!=typeof e)return void console.warn("Invalid players data format:",e);t=new Map(Object.entries(e))}for(const[e,i]of this.otherPlayers.entries())t.has(e)||this.handlePlayerLeave({playerId:e});for(const[e,i]of t.entries()){if(e===this.network.playerId)continue;this.otherPlayers.get(e)?this.handlePlayerMove({playerId:e,position:i.position||{x:i.x,y:i.y},rotation:i.rotation||0}):this.handlePlayerJoin({playerId:e,position:i.position||{x:i.x,y:i.y},rotation:i.rotation||0})}}updateGameObjectsFromState(e){if(console.log(`Received ${e.length} game objects from server:`,e),!Array.isArray(e))return void console.warn("Invalid gameObjects data received");const t=e.filter(e=>"asteroid"===e.type),i=e.filter(e=>"station"===e.type);this.synchronizeAsteroids(t),this.synchronizeStations(i)}synchronizeAsteroids(e){const t=this.graphics.getLayer("background");if(!t)return;const i=new Set(e.map(e=>e.id));this.asteroids=this.asteroids.filter(e=>{if(!i.has(e.id)){const i=t.querySelector(`#${e.id}`);return i&&t.removeChild(i),console.log(`Removed asteroid ${e.id} (deleted on server)`),!1}return!0}),e.forEach(e=>{const i=this.asteroids.findIndex(t=>t.id===e.id);if(i>=0){const a=this.asteroids[i];if(a.x!==e.x||a.y!==e.y||a.size!==e.size){this.asteroids[i]={...e};const a=t.querySelector(`#${e.id}`);a&&a.setAttribute("transform",`translate(${e.x}, ${e.y})`)}}else{this.asteroids.push({...e});const t=this.graphics.createAsteroid(e.x,e.y,e.size,{id:e.id});this.graphics.addToLayer("background",t),console.log(`Added new asteroid ${e.id} from server`)}})}synchronizeStations(e){const t=this.graphics.getLayer("game");if(!t)return;const i=new Set(e.map(e=>e.id));this.stations=this.stations.filter(e=>{if(!i.has(e.id)){const i=t.querySelector(`#${e.id}`);return i&&t.removeChild(i),console.log(`Removed station ${e.id} (deleted on server)`),!1}return!0}),e.forEach(e=>{const i=this.stations.findIndex(t=>t.id===e.id);if(i>=0){const a=this.stations[i];if(a.x!==e.x||a.y!==e.y){this.stations[i]={...e};const a=t.querySelector(`#${e.id}`);a&&a.setAttribute("transform",`translate(${e.x}, ${e.y})`)}}else{this.stations.push({...e});const t=this.graphics.createSpaceStation(e.x,e.y,e.radius||40,{id:e.id});this.graphics.addToLayer("game",t),console.log(`Added new station ${e.id} from server`)}})}showNetworkStatus(e,t="info"){let i=document.getElementById("network-status");i||(i=document.createElement("div"),i.id="network-status",i.style.cssText="\n                position: fixed;\n                top: 10px;\n                right: 10px;\n                padding: 8px 12px;\n                border-radius: 4px;\n                font-size: 12px;\n                font-family: monospace;\n                z-index: 1000;\n                transition: opacity 0.3s ease;\n            ",document.body.appendChild(i));const a={success:{bg:"#4CAF50",text:"#ffffff"},warning:{bg:"#FF9800",text:"#ffffff"},error:{bg:"#F44336",text:"#ffffff"},info:{bg:"#2196F3",text:"#ffffff"}},n=a[t]||a.info;i.style.backgroundColor=n.bg,i.style.color=n.text,i.textContent=e,i.style.opacity="1","success"===t&&setTimeout(()=>{i.style.opacity="0.7"},3e3)}togglePause(){this.isPaused=!this.isPaused,this.isPaused?(this.showPauseMenu(),console.log("Game paused")):(this.hidePauseMenu(),console.log("Game resumed"))}showPauseMenu(){if(this.pauseMenuElement)return void(this.pauseMenuElement.style.display="flex");this.pauseMenuElement=document.createElement("div"),this.pauseMenuElement.id="pause-menu",this.pauseMenuElement.innerHTML=`\n            <div class="pause-menu-content">\n                <h2>GAME PAUSED</h2>\n                <div class="pause-menu-section">\n                    <h3>Controls</h3>\n                    <div class="controls-list">\n                        <div><span class="key">WASD / Arrow Keys</span> Move</div>\n                        <div><span class="key">Shift</span> Boost</div>\n                        <div><span class="key">Space</span> Fire Laser</div>\n                        <div><span class="key">F</span> Interact / Dock / Jump</div>\n                        <div><span class="key">Q / E</span> Zoom Out / In</div>\n                        <div><span class="key">Escape</span> Pause Menu</div>\n                    </div>\n                </div>\n                <div class="pause-menu-section">\n                    <h3>Options</h3>\n                    <div class="options-list">\n                        <button id="toggle-audio" class="menu-button">\n                            Audio: ${this.audio&&this.audio.enabled?"ON":"OFF"}\n                        </button>\n                        <button id="resume-game" class="menu-button primary">Resume Game</button>\n                    </div>\n                </div>\n                <div class="pause-menu-section">\n                    <h3>Status</h3>\n                    <div class="status-info">\n                        <div>Health: <span class="status-value">${Math.round(this.player.health)}/${y.MAX_HEALTH}</span></div>\n                        <div>Energy: <span class="status-value">${Math.round(this.player.energy)}/${p.MAX_ENERGY}</span></div>\n                        <div>Sector: <span class="status-value">${this.navigation.getCurrentSector()?.name||"Unknown"}</span></div>\n                        <div>Network: <span class="status-value">${this.network.isConnected?"Connected":"Offline"}</span></div>\n                    </div>\n                </div>\n                <div class="pause-footer">\n                    <p>Press <span class="key">Escape</span> to resume</p>\n                </div>\n            </div>\n        `,this.pauseMenuElement.style.cssText="\n            position: fixed;\n            top: 0; left: 0;\n            width: 100%; height: 100%;\n            background: rgba(0, 20, 40, 0.95);\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            z-index: 2000;\n            font-family: 'Courier New', monospace;\n            backdrop-filter: blur(10px);\n        ";const e=document.createElement("style");e.textContent="\n            .pause-menu-content {\n                background: rgba(0, 50, 100, 0.9);\n                border: 2px solid #4488ff;\n                border-radius: 12px;\n                padding: 30px;\n                max-width: 500px;\n                width: 90%;\n                max-height: 80%;\n                overflow-y: auto;\n                text-align: center;\n                box-shadow: 0 0 30px rgba(68, 136, 255, 0.3);\n            }\n            \n            .pause-menu-content h2 {\n                color: #ffffff;\n                font-size: 2.5em;\n                margin: 0 0 30px 0;\n                text-shadow: 0 0 10px #4488ff;\n            }\n            \n            .pause-menu-section {\n                margin-bottom: 25px;\n                text-align: left;\n            }\n            \n            .pause-menu-section h3 {\n                color: #88ccff;\n                font-size: 1.4em;\n                margin: 0 0 15px 0;\n                border-bottom: 1px solid #4488ff;\n                padding-bottom: 5px;\n            }\n            \n            .controls-list > div, .status-info > div {\n                color: #ffffff;\n                margin: 8px 0;\n                padding: 5px 0;\n                font-size: 1.1em;\n                display: flex;\n                justify-content: space-between;\n                align-items: center;\n            }\n            \n            .key {\n                background: #4488ff;\n                color: #ffffff;\n                padding: 3px 8px;\n                border-radius: 4px;\n                font-weight: bold;\n                min-width: 120px;\n                text-align: center;\n                display: inline-block;\n                margin-right: 10px;\n            }\n            \n            .status-value {\n                color: #88ccff;\n                font-weight: bold;\n            }\n            \n            .menu-button {\n                background: rgba(68, 136, 255, 0.3);\n                border: 1px solid #4488ff;\n                color: #ffffff;\n                padding: 10px 20px;\n                margin: 5px;\n                border-radius: 6px;\n                font-family: 'Courier New', monospace;\n                font-size: 1em;\n                cursor: pointer;\n                transition: all 0.2s ease;\n                min-width: 150px;\n            }\n            \n            .menu-button:hover {\n                background: rgba(68, 136, 255, 0.5);\n                box-shadow: 0 0 8px rgba(68, 136, 255, 0.4);\n            }\n            \n            .menu-button.primary {\n                background: #4488ff;\n            }\n            \n            .menu-button.primary:hover {\n                background: #88ccff;\n                color: #002244;\n            }\n            \n            .options-list {\n                text-align: center;\n            }\n            \n            .pause-footer {\n                margin-top: 20px;\n                padding-top: 15px;\n                border-top: 1px solid #4488ff;\n                color: #88ccff;\n                font-size: 0.9em;\n            }\n        ",document.querySelector("#pause-menu-styles")||(e.id="pause-menu-styles",document.head.appendChild(e)),document.body.appendChild(this.pauseMenuElement);const t=this.pauseMenuElement.querySelector("#resume-game"),i=this.pauseMenuElement.querySelector("#toggle-audio");t.addEventListener("click",()=>{this.togglePause()}),i.addEventListener("click",()=>{this.audio.enabled?(this.audio.disable(),i.textContent="Audio: OFF"):(this.audio.enable(),i.textContent="Audio: ON")})}hidePauseMenu(){this.pauseMenuElement&&(this.pauseMenuElement.style.display="none")}}document.addEventListener("DOMContentLoaded",()=>{window.maxPixelsGame=new MaxPixelsGame});