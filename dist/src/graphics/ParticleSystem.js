import{PARTICLES as t,GRAPHICS as e}from"../constants.js";const i={COUNT:20,LIFE:2e3,EMISSION_RATE:10,SPREAD:e.PI_TIMES_2,SIZE_MIN:2,SIZE_MAX:6,OPACITY_START:1,OPACITY_END:0,GRAVITY:{x:0,y:0},WIND:{x:0,y:0},VELOCITY_MIN:50,VELOCITY_MAX:100,OFFSET:10};export class ParticleSystem{constructor(t){this.graphics=t,this.particles=new Map,this.activeEmitters=new Map,this.idCounter=0,this.updateInterval=null,this.startUpdateLoop()}createEmitter(t,e,r={}){const a="emitter_"+ ++this.idCounter,s={particleCount:i.COUNT,particleLife:i.LIFE,emissionRate:i.EMISSION_RATE,spread:i.SPREAD,velocity:{min:i.VELOCITY_MIN,max:i.VELOCITY_MAX},size:{min:i.SIZE_MIN,max:i.SIZE_MAX},color:"#ffffff",opacity:{start:i.OPACITY_START,end:i.OPACITY_END},gravity:i.GRAVITY,wind:i.WIND,fadeOut:!0,shrink:!1,burst:!1,duration:-1,...r},c={id:a,x:t,y:e,config:s,particles:[],lastEmission:0,startTime:Date.now(),active:!0};return this.activeEmitters.set(a,c),s.burst&&this.burstEmit(c),a}createExplosionEffect(i,r,a={}){const s={particleCount:t.EXPLOSION_PARTICLE_COUNT,particleLife:t.EXPLOSION_LIFE,spread:e.PI_TIMES_2,velocity:{min:t.EXPLOSION_VELOCITY_MIN,max:t.EXPLOSION_VELOCITY_MAX},size:{min:t.EXPLOSION_SIZE_MIN,max:t.EXPLOSION_SIZE_MAX},color:"#ff6600",opacity:{start:t.EXPLOSION_OPACITY_START,end:0},gravity:{x:0,y:t.EXPLOSION_GRAVITY_Y},fadeOut:!0,shrink:!0,burst:!0,duration:0,...a};return this.createEmitter(i,r,s)}createThrusterTrail(e,i,r,a=1){const s={particleCount:Math.floor(t.THRUSTER_BASE_PARTICLES*a),particleLife:t.THRUSTER_LIFE,emissionRate:t.THRUSTER_BASE_EMISSION_RATE*a,spread:Math.PI*t.THRUSTER_SPREAD,velocity:{min:t.THRUSTER_VELOCITY_BASE*a,max:t.THRUSTER_VELOCITY_RANGE*a},size:{min:t.THRUSTER_SIZE_MIN,max:t.THRUSTER_SIZE_MAX},color:a>t.THRUSTER_HIGH_INTENSITY?"#00aaff":"#0066ff",opacity:{start:t.THRUSTER_OPACITY_START,end:0},direction:r+Math.PI,fadeOut:!0,shrink:!0,burst:!1,duration:t.THRUSTER_DURATION};return this.createEmitter(e,i,s)}createDebrisField(i,r,a){const s={particleCount:Math.floor(a/t.DEBRIS_SIZE_DIVISOR),particleLife:t.DEBRIS_LIFE,spread:e.PI_TIMES_2,velocity:{min:t.DEBRIS_VELOCITY_MIN,max:t.DEBRIS_VELOCITY_MAX},size:{min:t.DEBRIS_SIZE_MIN,max:t.DEBRIS_SIZE_MAX},color:"#8b7355",opacity:{start:t.DEBRIS_OPACITY_START,end:0},gravity:{x:0,y:t.DEBRIS_GRAVITY_Y},fadeOut:!0,burst:!0,duration:0};return this.createEmitter(i,r,s)}createSparksEffect(e,i,r=0){const a={particleCount:t.SPARKS_COUNT,particleLife:t.SPARKS_LIFE,spread:Math.PI*t.SPARKS_SPREAD,velocity:{min:t.SPARKS_VELOCITY_MIN,max:t.SPARKS_VELOCITY_MAX},size:{min:t.SPARKS_SIZE_MIN,max:t.SPARKS_SIZE_MAX},color:"#ffff00",opacity:{start:1,end:0},direction:r,gravity:{x:0,y:t.SPARKS_GRAVITY_Y},fadeOut:!0,burst:!0,duration:0};return this.createEmitter(e,i,a)}burstEmit(t){for(let e=0;e<t.config.particleCount;e++)this.createParticle(t)}createParticle(e){const i=e.config,r="particle_"+ ++this.idCounter,a=(i.direction||0)+(Math.random()-t.RANDOM_OFFSET_RANGE)*i.spread,s=i.velocity.min+Math.random()*(i.velocity.max-i.velocity.min),c=Math.cos(a)*s,o=Math.sin(a)*s,n=i.size.min+Math.random()*(i.size.max-i.size.min),E={id:r,x:e.x+(Math.random()-t.RANDOM_OFFSET_RANGE)*t.POSITION_OFFSET,y:e.y+(Math.random()-t.RANDOM_OFFSET_RANGE)*t.POSITION_OFFSET,velX:c,velY:o,size:n,originalSize:n,color:i.color,opacity:i.opacity.start,life:i.particleLife,maxLife:i.particleLife,startTime:Date.now()},l=this.graphics.createCircle(E.x,E.y,E.size,{id:r,fill:E.color,opacity:E.opacity});return this.graphics.addToLayer("game",l),E.element=l,this.particles.set(r,E),e.particles.push(E),E}update(){const e=Date.now(),i=t.DELTA_TIME_60FPS;for(const[,i]of this.activeEmitters)if(i.active)if(i.config.duration>0&&e-i.startTime>i.config.duration)i.active=!1;else if(!i.config.burst&&i.active){e-i.lastEmission>=t.EMISSION_TIME_MS/i.config.emissionRate&&(this.createParticle(i),i.lastEmission=e)}for(const[e,r]of this.particles){r.x+=r.velX*i,r.y+=r.velY*i;const a=this.getParticleEmitter(r);a&&(r.velX+=a.config.gravity.x*i,r.velY+=a.config.gravity.y*i,r.velX+=a.config.wind.x*i,r.velY+=a.config.wind.y*i),r.life-=t.FRAME_TIME;const s=r.life/r.maxLife;if(a&&a.config.fadeOut){const t=a.config.opacity.start-a.config.opacity.end;r.opacity=a.config.opacity.end+s*t}a&&a.config.shrink&&(r.size=r.originalSize*s),r.element&&(r.element.setAttribute("cx",r.x),r.element.setAttribute("cy",r.y),r.element.setAttribute("r",Math.max(t.SIZE_MIN_RENDER,r.size)),r.element.setAttribute("opacity",Math.max(0,r.opacity))),r.life<=0&&this.removeParticle(e)}for(const[t,e]of this.activeEmitters)e.active||0!==e.particles.length||this.activeEmitters.delete(t)}getParticleEmitter(t){for(const e of this.activeEmitters.values())if(e.particles.includes(t))return e;return null}removeParticle(t){const e=this.particles.get(t);if(!e)return;e.element&&this.graphics.remove(e.element);const i=this.getParticleEmitter(e);if(i){const t=i.particles.indexOf(e);t>-1&&i.particles.splice(t,1)}this.particles.delete(t)}removeEmitter(t){const e=this.activeEmitters.get(t);if(e){for(const t of[...e.particles])this.removeParticle(t.id);this.activeEmitters.delete(t)}}startUpdateLoop(){this.updateInterval||(this.updateInterval=setInterval(()=>{this.update()},t.FRAME_TIME))}stopUpdateLoop(){this.updateInterval&&(clearInterval(this.updateInterval),this.updateInterval=null)}clear(){for(const t of this.particles.keys())this.removeParticle(t);this.activeEmitters.clear(),this.idCounter=0}getDebugInfo(){return{activeEmitters:this.activeEmitters.size,activeParticles:this.particles.size,totalCreatedParticles:this.idCounter}}}