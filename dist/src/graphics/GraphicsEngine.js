import{GRAPHICS as t,WEAPONS as e,ASTEROID_DAMAGE as r}from"../constants.js";export class GraphicsEngine{constructor(t){this.svg=t,this.layers=new Map,this.defs=this.svg.querySelector("defs")||this.createDefs(),this.idCounter=0}createDefs(){const t=this.createElement("defs");return this.svg.appendChild(t),this.defs=t,this.createProximityGlowFilter(),t}createProximityGlowFilter(){const t=this.createElement("filter");t.setAttribute("id","proximityGlow"),t.setAttribute("x","-50%"),t.setAttribute("y","-50%"),t.setAttribute("width","200%"),t.setAttribute("height","200%");const e=this.createElement("feGaussianBlur");e.setAttribute("stdDeviation","4"),e.setAttribute("result","coloredBlur");const r=this.createElement("feMerge"),i=this.createElement("feMergeNode");i.setAttribute("in","coloredBlur");const a=this.createElement("feMergeNode");a.setAttribute("in","SourceGraphic"),r.appendChild(i),r.appendChild(a),t.appendChild(e),t.appendChild(r),this.defs.appendChild(t)}createNebulaPattern(e={}){const{id:r=this.generateId("nebula"),colors:i=["#663399","#9966cc","#cc66cc","#6633cc"],baseSize:a=t.NEBULA_BASE_SIZE,opacity:_=t.NEBULA_BASE_OPACITY}=e,s=this.createElement("pattern");s.setAttribute("id",r),s.setAttribute("x","0"),s.setAttribute("y","0"),s.setAttribute("width",a),s.setAttribute("height",a),s.setAttribute("patternUnits","userSpaceOnUse");const A=t.NEBULA_CLOUD_COUNT_MIN+Math.floor(Math.random()*(t.NEBULA_CLOUD_COUNT_MAX-t.NEBULA_CLOUD_COUNT_MIN));for(let e=0;e<A;e++){const e=this.createElement("ellipse"),r=Math.random()*a,A=Math.random()*a,n=t.NEBULA_CLOUD_RX_MIN+Math.random()*(t.NEBULA_CLOUD_RX_MAX-t.NEBULA_CLOUD_RX_MIN),o=t.NEBULA_CLOUD_RY_MIN+Math.random()*(t.NEBULA_CLOUD_RY_MAX-t.NEBULA_CLOUD_RY_MIN),E=i[Math.floor(Math.random()*i.length)],I=_*(t.NEBULA_CLOUD_OPACITY_MIN+Math.random()*(t.NEBULA_CLOUD_OPACITY_MAX-t.NEBULA_CLOUD_OPACITY_MIN));e.setAttribute("cx",r),e.setAttribute("cy",A),e.setAttribute("rx",n),e.setAttribute("ry",o),e.setAttribute("fill",E),e.setAttribute("opacity",I),e.setAttribute("filter","blur(15px)");const T=Math.random()*t.NEBULA_ROTATION_MAX;e.setAttribute("transform",`rotate(${T} ${r} ${A})`),s.appendChild(e)}return this.defs.appendChild(s),r}createNebulaBackground(e,r,i=["purple","blue","red"]){const a=this.createGroup({id:"nebulaBackground"}),_={purple:{colors:["#663399","#9966cc","#cc66cc","#6633cc"],opacity:.25},blue:{colors:["#336699","#6699cc","#66ccff","#3366cc"],opacity:.2},red:{colors:["#994433","#cc6666","#ff6666","#cc3366"],opacity:.3},green:{colors:["#339966","#66cc99","#66ff99","#33cc66"],opacity:.15}},s=t.NEBULA_COUNT_MIN+Math.floor(Math.random()*(t.NEBULA_COUNT_MAX-t.NEBULA_COUNT_MIN+1));for(let A=0;A<s;A++){const s=_[i[Math.floor(Math.random()*i.length)]];if(!s)continue;const A=this.createNebulaPattern({colors:s.colors,opacity:s.opacity,baseSize:t.NEBULA_PATTERN_SIZE_MIN+Math.random()*(t.NEBULA_PATTERN_SIZE_MAX-t.NEBULA_PATTERN_SIZE_MIN)}),n=this.createElement("rect"),o=e*(t.NEBULA_REGION_WIDTH_MIN+Math.random()*(t.NEBULA_REGION_WIDTH_MAX-t.NEBULA_REGION_WIDTH_MIN)),E=r*(t.NEBULA_REGION_HEIGHT_MIN+Math.random()*(t.NEBULA_REGION_HEIGHT_MAX-t.NEBULA_REGION_HEIGHT_MIN)),I=Math.random()*(e-o),T=Math.random()*(r-E);n.setAttribute("x",I),n.setAttribute("y",T),n.setAttribute("width",o),n.setAttribute("height",E),n.setAttribute("fill",`url(#${A})`),n.setAttribute("opacity",t.NEBULA_REGION_OPACITY),a.appendChild(n)}return a}createCosmicDustField(e,r,i={}){const{particleCount:a=t.DUST_PARTICLE_COUNT_MIN+Math.floor(Math.random()*(t.DUST_PARTICLE_COUNT_MAX-t.DUST_PARTICLE_COUNT_MIN)),minSize:_=t.DUST_SIZE_MIN,maxSize:s=t.DUST_SIZE_MAX,minOpacity:A=t.DUST_OPACITY_MIN,maxOpacity:n=t.DUST_OPACITY_MAX,colors:o=["#888899","#aabbcc","#667788","#99aacc"],density:E=t.DUST_DENSITY_NORMAL}=i,I=this.createGroup({id:"cosmicDustField"}),T=Math.floor(a*E),c=this.generateId("dustPattern"),R=this.createElement("pattern");R.setAttribute("id",c),R.setAttribute("x","0"),R.setAttribute("y","0"),R.setAttribute("width",t.NEBULA_BASE_SIZE),R.setAttribute("height",t.NEBULA_BASE_SIZE),R.setAttribute("patternUnits","userSpaceOnUse");const l=Math.floor(t.DUST_CLOUD_COUNT_MIN*t.COUNT_MEDIUM);for(let e=0;e<l;e++){const e=this.createElement("circle"),r=Math.random()*t.NEBULA_BASE_SIZE,i=Math.random()*t.NEBULA_BASE_SIZE,a=_+Math.random()*(s-_),E=A+Math.random()*(n-A),I=o[Math.floor(Math.random()*o.length)];e.setAttribute("cx",r),e.setAttribute("cy",i),e.setAttribute("r",a),e.setAttribute("fill",I),e.setAttribute("opacity",E),R.appendChild(e)}this.defs.appendChild(R);const h=Math.max(t.DUST_CLOUD_COUNT_MIN,T/(t.DUST_CLOUD_COUNT_MAX*t.COUNT_MEDIUM/t.COUNT_MINIMUM));for(let i=0;i<h;i++){const i=this.createElement("rect"),a=t.SIZE_LARGE*t.COUNT_LARGE+Math.random()*(t.SIZE_LARGE*t.COUNT_MAXIMUM),_=t.NEBULA_BASE_SIZE+Math.random()*(t.SIZE_LARGE*t.COUNT_LARGE),s=Math.random()*(e-a),A=Math.random()*(r-_),n=Math.random()*t.FULL_ROTATION*t.FULL_CIRCLE;i.setAttribute("x",s),i.setAttribute("y",A),i.setAttribute("width",a),i.setAttribute("height",_),i.setAttribute("fill",`url(#${c})`),i.setAttribute("opacity",t.RATIO_OPACITY_LOW+Math.random()*t.RATIO_SIZE_SMALL),i.setAttribute("transform",`rotate(${n} ${s+a/t.FULL_CIRCLE} ${A+_/t.FULL_CIRCLE})`),I.appendChild(i)}const O=Math.floor(T*t.RATIO_OPACITY_LOW);for(let i=0;i<O;i++){const i=this.createElement("circle"),a=Math.random()*e,E=Math.random()*r,T=t.RATIO_SIZE_LARGE+Math.random()*(s*(t.GLOW_INTENSITY+t.RATIO_SIZE_SMALL)-_*t.RATIO_SIZE_LARGE),c=_*t.RATIO_SIZE_LARGE+Math.random()*T,R=n*t.RATIO_SIZE_LARGE-A*t.RATIO_OPACITY_MID,l=A*t.RATIO_OPACITY_MID+Math.random()*R,h=o[Math.floor(Math.random()*o.length)];if(i.setAttribute("cx",a),i.setAttribute("cy",E),i.setAttribute("r",c),i.setAttribute("fill",h),i.setAttribute("opacity",l),Math.random()<t.DUST_ANIMATION_CHANCE){const e=this.createElement("animate");e.setAttribute("attributeName","opacity"),e.setAttribute("values",`${l};${l*t.RATIO_OPACITY_LOW};${l}`),e.setAttribute("dur",`${t.DUST_ANIMATION_DURATION_MIN+Math.random()*(t.DUST_ANIMATION_DURATION_MAX-t.DUST_ANIMATION_DURATION_MIN)}s`),e.setAttribute("repeatCount","indefinite"),e.setAttribute("begin",`${Math.random()*t.COUNT_LARGE+t.FULL_CIRCLE}s`),i.appendChild(e)}I.appendChild(i)}return I}createSpaceDebrisField(e,r,i={}){const{debrisCount:a=t.DEBRIS_FIELD_COUNT_MIN+Math.floor(Math.random()*(t.DEBRIS_FIELD_COUNT_MAX-t.DEBRIS_FIELD_COUNT_MIN)),density:_=t.DEBRIS_DENSITY_NORMAL,minSize:s=t.DEBRIS_SIZE_MIN,maxSize:A=t.DEBRIS_SIZE_MAX,types:n=t.DEBRIS_TYPES}=i,o=this.createGroup({id:"spaceDebrisField"}),E=Math.floor(a*_),I=t.DEBRIS_CLUSTER_COUNT_MIN+Math.floor(Math.random()*(t.DEBRIS_CLUSTER_COUNT_MAX-t.DEBRIS_CLUSTER_COUNT_MIN));for(let i=0;i<I;i++){const i=Math.random()*e,a=Math.random()*r,_=Math.floor(E/I);for(let E=0;E<_;E++){const _=Math.random()*t.FULL_ROTATION*t.FULL_CIRCLE,E=Math.random()*t.DEBRIS_CLUSTER_SPREAD,I=i+Math.cos(_*Math.PI/t.ANGLE_180)*E,T=a+Math.sin(_*Math.PI/t.ANGLE_180)*E;if(I<0||I>e||T<0||T>r)continue;const c=n[Math.floor(Math.random()*n.length)],R=s+Math.random()*(A-s),l=Math.random()*t.DEBRIS_ROTATION_MAX,h=t.DEBRIS_OPACITY_MIN+Math.random()*(t.DEBRIS_OPACITY_MAX-t.DEBRIS_OPACITY_MIN),O=this.createDebrisPiece(I,T,R,c,l,h);o.appendChild(O)}}return o}createDebrisPiece(e,r,i,a,_,s){const A=this.createGroup({transform:`translate(${e}, ${r}) rotate(${_})`,id:this.generateId(`debris_${a}`)});let n;const o="#666666",E="#999999";switch(a){case"hull_fragment":n=this.createPath(`M ${-i} ${-i*t.RATIO_SIZE_SMALL} L ${i*t.RATIO_SIZE_LARGE} ${-i} L ${i} ${i*t.RATIO_SIZE_SMALL} L ${-i*t.RATIO_SIZE_SMALL} ${i} Z`,{fill:o,stroke:E,"stroke-width":t.RATIO_SIZE_SMALL,opacity:s});break;case"engine_part":n=this.createGroup();const e=this.createRect(-i*t.RATIO_SIZE_SMALL,-i,i,i*t.FULL_CIRCLE,{fill:"#444444",stroke:"#777777","stroke-width":1,opacity:s}),r=this.createPath(`M ${-i*t.RATIO_SIZE_MID} ${i} L ${i*t.RATIO_SIZE_MID} ${i} L ${i*t.RATIO_SIZE_LARGE} ${i*t.GLOW_INTENSITY} L ${-i*t.RATIO_SIZE_LARGE} ${i*t.GLOW_INTENSITY} Z`,{fill:"#222222",stroke:"#555555","stroke-width":1,opacity:s});n.appendChild(e),n.appendChild(r);break;case"solar_panel":n=this.createGroup();const a=this.createRect(-i,-i*t.RATIO_SIZE_SMALL,i*t.FULL_CIRCLE,i,{fill:"#1a1a3a",stroke:"#4444aa","stroke-width":1,opacity:s});for(let e=0;e<t.COUNT_MEDIUM;e++){const r=this.createLine(-i+e*i*t.RATIO_SIZE_SMALL,-i*t.RATIO_SIZE_SMALL,-i+e*i*t.RATIO_SIZE_SMALL,i*t.RATIO_SIZE_LARGE,{stroke:"#333366","stroke-width":.5,opacity:s*t.RATIO_OPACITY_MID});n.appendChild(r)}n.appendChild(a);break;case"antenna":n=this.createGroup();const _=this.createCircle(0,0,i*t.RATIO_SIZE_SMALL,{fill:o,stroke:E,"stroke-width":1,opacity:s}),A=this.createLine(0,0,0,-i*t.FULL_CIRCLE,{stroke:"#888888","stroke-width":t.FULL_CIRCLE,opacity:s}),I=this.createCircle(0,-i*t.FULL_CIRCLE,i*t.RATIO_SIZE_SMALL*t.RATIO_SIZE_SMALL,{fill:"#ff4444",opacity:s});n.appendChild(A),n.appendChild(_),n.appendChild(I);break;case"fuel_tank":n=this.createGroup();const T=this.createElement("ellipse");T.setAttribute("cx",0),T.setAttribute("cy",0),T.setAttribute("rx",i),T.setAttribute("ry",i*t.RATIO_SIZE_MID),T.setAttribute("fill","#333333"),T.setAttribute("stroke","#666666"),T.setAttribute("stroke-width","1"),T.setAttribute("opacity",s);const c=this.createElement("ellipse");c.setAttribute("cx",0),c.setAttribute("cy",0),c.setAttribute("rx",i*t.RATIO_OPACITY_HIGH),c.setAttribute("ry",i*t.RATIO_SIZE_MID*t.RATIO_OPACITY_HIGH),c.setAttribute("fill","none"),c.setAttribute("stroke","#888888"),c.setAttribute("stroke-width","0.5"),c.setAttribute("opacity",s),n.appendChild(T),n.appendChild(c);break;default:n=this.createPath(`M ${-i} 0 L ${-i*t.RATIO_SIZE_SMALL} ${-i} L ${i*t.RATIO_SIZE_MID} ${-i*t.RATIO_SIZE_SMALL} L ${i} ${i*t.RATIO_SIZE_SMALL} L 0 ${i} Z`,{fill:o,stroke:E,"stroke-width":1,opacity:s})}if(A.appendChild(n),Math.random()<t.DEBRIS_DRIFT_CHANCE){const e=this.createElement("animateTransform");e.setAttribute("attributeName","transform"),e.setAttribute("type","rotate"),e.setAttribute("values",`${_};${_+t.ANGLE_90};${_}`),e.setAttribute("dur",`${t.DEBRIS_DRIFT_DURATION_MIN+Math.random()*(t.DEBRIS_DRIFT_DURATION_MAX-t.DEBRIS_DRIFT_DURATION_MIN)}s`),e.setAttribute("repeatCount","indefinite"),e.setAttribute("begin",Math.random()*t.COUNT_LARGE+"s"),A.appendChild(e)}return A}createElement(t){return document.createElementNS("http://www.w3.org/2000/svg",t)}generateId(t="element"){return`${t}_${++this.idCounter}`}setAttributes(t,e){return Object.entries(e).forEach(([e,r])=>{t.setAttribute(e,r)}),t}createLayer(t,e=0){const r=this.createElement("g");return r.setAttribute("id",`layer_${t}`),r.setAttribute("data-layer",t),r.style.zIndex=e,this.layers.set(t,r),this.svg.appendChild(r),r}getLayer(t){return this.layers.has(t)?this.layers.get(t):this.createLayer(t)}createCircle(t,e,r,i={}){if("number"!=typeof t||!isFinite(t))throw new Error("GraphicsEngine.createCircle: cx must be a finite number");if("number"!=typeof e||!isFinite(e))throw new Error("GraphicsEngine.createCircle: cy must be a finite number");if("number"!=typeof r||!isFinite(r)||r<0)throw new Error("GraphicsEngine.createCircle: r must be a non-negative finite number");if("object"!=typeof i||null===i)throw new Error("GraphicsEngine.createCircle: attributes must be an object");const a=this.createElement("circle");return a.setAttribute("cx",t),a.setAttribute("cy",e),a.setAttribute("r",r),this.setAttributes(a,i)}createRect(t,e,r,i,a={}){if("number"!=typeof t||!isFinite(t))throw new Error("GraphicsEngine.createRect: x must be a finite number");if("number"!=typeof e||!isFinite(e))throw new Error("GraphicsEngine.createRect: y must be a finite number");if("number"!=typeof r||!isFinite(r)||r<0)throw new Error("GraphicsEngine.createRect: width must be a non-negative finite number");if("number"!=typeof i||!isFinite(i)||i<0)throw new Error("GraphicsEngine.createRect: height must be a non-negative finite number");if("object"!=typeof a||null===a)throw new Error("GraphicsEngine.createRect: attributes must be an object");const _=this.createElement("rect");return _.setAttribute("x",t),_.setAttribute("y",e),_.setAttribute("width",r),_.setAttribute("height",i),this.setAttributes(_,a)}createLine(t,e,r,i,a={}){if("number"!=typeof t||!Number.isFinite(t))throw new Error("Invalid x1 parameter: must be a finite number");if("number"!=typeof e||!Number.isFinite(e))throw new Error("Invalid y1 parameter: must be a finite number");if("number"!=typeof r||!Number.isFinite(r))throw new Error("Invalid x2 parameter: must be a finite number");if("number"!=typeof i||!Number.isFinite(i))throw new Error("Invalid y2 parameter: must be a finite number");if(null!==a&&("object"!=typeof a||Array.isArray(a)))throw new Error("Invalid attributes parameter: must be an object");const _=this.createElement("line");return _.setAttribute("x1",t.toString()),_.setAttribute("y1",e.toString()),_.setAttribute("x2",r.toString()),_.setAttribute("y2",i.toString()),this.setAttributes(_,a)}createPath(t,e={}){if("string"!=typeof t||""===t.trim())throw new Error("Invalid d parameter: must be a non-empty string");if(null!==e&&("object"!=typeof e||Array.isArray(e)))throw new Error("Invalid attributes parameter: must be an object");const r=this.createElement("path");return r.setAttribute("d",t),this.setAttributes(r,e)}createGroup(t={}){const e=this.createElement("g");return this.setAttributes(e,t)}createText(t,e=0,r=0,i={}){if("string"!=typeof t)throw new Error("GraphicsEngine.createText: content must be a string");if("number"!=typeof e||!isFinite(e))throw new Error("GraphicsEngine.createText: x must be a finite number");if("number"!=typeof r||!isFinite(r))throw new Error("GraphicsEngine.createText: y must be a finite number");if("object"!=typeof i||null===i)throw new Error("GraphicsEngine.createText: attributes must be an object");const a=this.createElement("text");return a.setAttribute("x",e),a.setAttribute("y",r),a.textContent=t,this.setAttributes(a,i)}createGradient(t,e,r={}){const i=this.generateId("gradient"),a=this.createElement("radial"===t?"radialGradient":"linearGradient");return a.setAttribute("id",i),this.setAttributes(a,r),e.forEach(t=>{const e=this.createElement("stop");e.setAttribute("offset",t.offset),e.setAttribute("stop-color",t.color),void 0!==t.opacity&&e.setAttribute("stop-opacity",t.opacity),a.appendChild(e)}),this.defs.appendChild(a),i}createStarField(e,r={width:t.DEFAULT_CANVAS_WIDTH,height:t.DEFAULT_CANVAS_HEIGHT},i={}){if("number"!=typeof e||!isFinite(e)||e<0)throw new Error("GraphicsEngine.createStarField: count must be a non-negative finite number");if("object"!=typeof r||null===r)throw new Error("GraphicsEngine.createStarField: bounds must be an object");if("number"!=typeof r.width||!isFinite(r.width)||r.width<=0)throw new Error("GraphicsEngine.createStarField: bounds.width must be a positive finite number");if("number"!=typeof r.height||!isFinite(r.height)||r.height<=0)throw new Error("GraphicsEngine.createStarField: bounds.height must be a positive finite number");const{includeNebulae:a=!0,nebulaTypes:_=["purple","blue","red"]}=i,s=this.createGroup({id:"starField"});if(a&&Math.random()<t.NEBULA_CHANCE){const t=this.createNebulaBackground(r.width,r.height,_);s.appendChild(t)}for(let i=0;i<e;i++){const e=Math.random()*r.width,i=Math.random()*r.height,a=this.selectStarType(),_=t.STAR_TYPES[a],A=Math.random()*(t.STAR_SIZE_MAX-t.STAR_SIZE_MIN)+t.STAR_SIZE_MIN,n=A*_.sizeMultiplier,o=this.createStar(e,i,n,_.color,a);if(s.appendChild(o),Math.random()<t.STAR_BINARY_CHANCE){const r=this.selectStarType(),a=t.STAR_TYPES[r],_=A*t.STAR_COMPANION_SIZE_RATIO*a.sizeMultiplier,n=Math.random()*Math.PI*t.FULL_CIRCLE,o=e+Math.cos(n)*t.STAR_BINARY_SEPARATION,E=i+Math.sin(n)*t.STAR_BINARY_SEPARATION,I=this.createStar(o,E,_,a.color,r);s.appendChild(I)}}return s}selectStarType(){const e=Math.random()*t.STAR_CUMULATIVE_RARITY;let r=0;for(const[i,a]of Object.entries(t.STAR_TYPES))if(r+=a.rarity,e<=r)return i;return"M"}createStar(e,r,i,a,_){const s=Math.random()*(t.STAR_OPACITY_MAX-t.STAR_OPACITY_MIN)+t.STAR_OPACITY_MIN,A=this.createGroup({transform:`translate(${e}, ${r})`}),n=this.createCircle(0,0,i,{fill:a,opacity:s,"data-star-type":_});if(i>t.MATH_PI_MULTIPLIER||"O"===_||"B"===_){const e=this.createCircle(0,0,i*t.RATIO_BINARY_SEPARATION,{fill:a,opacity:s*t.RATIO_SIZE_SMALL,filter:"blur(1px)"});A.appendChild(e)}A.appendChild(n);const o=this.createSolarCorona(i,a,_);return o&&A.insertBefore(o,n),Math.random()<t.STAR_TWINKLE_CHANCE&&this.addTwinkleAnimation(n),A}addTwinkleAnimation(e){const r=this.createElement("animate");r.setAttribute("attributeName","opacity"),r.setAttribute("values",`${e.getAttribute("opacity")};${parseFloat(e.getAttribute("opacity"))*(1-t.STAR_TWINKLE_INTENSITY)};${e.getAttribute("opacity")}`),r.setAttribute("dur",`${t.STAR_TWINKLE_MIN_DURATION+Math.random()*t.STAR_TWINKLE_MAX_DURATION}s`),r.setAttribute("repeatCount","indefinite"),e.appendChild(r)}createSolarCorona(e,r,i){if(e<t.STAR_CORONA_MIN_SIZE_THRESHOLD)return null;if(Math.random()>t.STAR_CORONA_CHANCE)return null;const a=e*t.STAR_CORONA_SIZE_MULTIPLIER,_=t.STAR_CORONA_OPACITY_BASE+Math.random()*t.STAR_CORONA_OPACITY_VARIATION,s=this.createGroup({"data-corona":"true"});for(let i=0;i<t.STAR_CORONA_LAYER_COUNT;i++){const A=a+i*e*t.STAR_CORONA_LAYER_SIZE_INCREMENT,n=_*(1-i*t.STAR_CORONA_LAYER_OPACITY_DECAY),o=this.createCircle(0,0,A,{fill:"none",stroke:r,"stroke-width":e*t.STAR_CORONA_STROKE_WIDTH_RATIO,opacity:n,filter:`blur(${t.BLUR_BASE_RADIUS+i}px)`}),E=this.createElement("animate");E.setAttribute("attributeName","opacity");const I=n*(1-t.STAR_CORONA_PULSE_INTENSITY),T=n*(1+t.STAR_CORONA_PULSE_INTENSITY);E.setAttribute("values",`${n};${I};${T};${n}`);const c=t.STAR_CORONA_ANIMATION_DURATION_MIN+Math.random()*(t.STAR_CORONA_ANIMATION_DURATION_MAX-t.STAR_CORONA_ANIMATION_DURATION_MIN)+i*t.STAR_CORONA_DURATION_OFFSET;E.setAttribute("dur",`${c}s`),E.setAttribute("repeatCount","indefinite"),E.setAttribute("begin",i*t.STAR_CORONA_ANIMATION_DELAY+"s"),o.appendChild(E),s.appendChild(o)}return s}createAsteroidField(e,r={width:t.DEFAULT_CANVAS_WIDTH,height:t.DEFAULT_CANVAS_HEIGHT}){const i=this.createGroup({id:"asteroidField"});for(let a=0;a<e;a++){const e=Math.random()*r.width,a=Math.random()*r.height,_=Math.random()*t.ASTEROID_SIZE_RANGE+t.ASTEROID_SIZE_MIN,s=this.createAsteroid(e,a,_);i.appendChild(s)}return i}createAsteroidBelt(e,r,i,a,_,s={}){if("number"!=typeof e||!isFinite(e))throw new Error("GraphicsEngine.createAsteroidBelt: centerX must be a finite number");if("number"!=typeof r||!isFinite(r))throw new Error("GraphicsEngine.createAsteroidBelt: centerY must be a finite number");if("number"!=typeof i||!isFinite(i)||i<0)throw new Error("GraphicsEngine.createAsteroidBelt: innerRadius must be a non-negative finite number");if("number"!=typeof a||!isFinite(a)||a<=i)throw new Error("GraphicsEngine.createAsteroidBelt: outerRadius must be a finite number greater than innerRadius");if("number"!=typeof _||!isFinite(_)||_<0)throw new Error("GraphicsEngine.createAsteroidBelt: count must be a non-negative finite number");if("object"!=typeof s||null===s)throw new Error("GraphicsEngine.createAsteroidBelt: attributes must be an object");const A=this.createGroup({id:s.id||`asteroidBelt_${this.generateId()}`,...s});for(let s=0;s<_;s++){const _=2*Math.random()*Math.PI,s=i+Math.random()*(a-i),n=e+Math.cos(_)*s,o=r+Math.sin(_)*s,E=1-(s-i)/(a-i)*t.ASTEROID_BELT_SIZE_REDUCTION,I=(Math.random()*t.ASTEROID_SIZE_RANGE+t.ASTEROID_SIZE_MIN)*E,T=this.createAsteroid(n,o,I,{id:`asteroid_${this.generateId()}`,opacity:t.ASTEROID_BELT_OPACITY_BASE+Math.random()*t.ASTEROID_BELT_OPACITY_VARIATION});A.appendChild(T)}return A}createAsteroid(e,r,i,a={}){if("number"!=typeof e||!isFinite(e))throw new Error("GraphicsEngine.createAsteroid: x must be a finite number");if("number"!=typeof r||!isFinite(r))throw new Error("GraphicsEngine.createAsteroid: y must be a finite number");if("number"!=typeof i||!isFinite(i)||i<=0)throw new Error("GraphicsEngine.createAsteroid: size must be a positive finite number");if("object"!=typeof a||null===a)throw new Error("GraphicsEngine.createAsteroid: attributes must be an object");const _=this.createGroup({transform:`translate(${e}, ${r})`,...a}),s=t.ASTEROID_VERTICES+Math.floor(Math.random()*t.ASTEROID_VERTEX_VARIANCE);let A="";for(let e=0;e<s;e++){const r=e/s*t.PI_TIMES_2,a=i*(t.ASTEROID_RADIUS_MIN+Math.random()*t.ASTEROID_RADIUS_MAX),_=Math.cos(r)*a,n=Math.sin(r)*a;A+=0===e?`M ${_} ${n}`:` L ${_} ${n}`}A+=" Z";const n=this.createPath(A,{fill:"#8b7355",stroke:"#654321","stroke-width":t.ASTEROID_STROKE_WIDTH,opacity:t.ASTEROID_OPACITY}),o=this.createPath(A,{fill:"none",stroke:"#a0926b","stroke-width":t.ASTEROID_HIGHLIGHT_WIDTH,opacity:t.ASTEROID_HIGHLIGHT_OPACITY,transform:`translate(-${i*t.ASTEROID_HIGHLIGHT_OFFSET}, -${i*t.ASTEROID_HIGHLIGHT_OFFSET})`});return _.appendChild(n),_.appendChild(o),_}createSpaceship(e,r,i=t.SPACESHIP_DEFAULT_SIZE,a={}){if("number"!=typeof e||!isFinite(e))throw new Error("GraphicsEngine.createSpaceship: x must be a finite number");if("number"!=typeof r||!isFinite(r))throw new Error("GraphicsEngine.createSpaceship: y must be a finite number");if("number"!=typeof i||!isFinite(i)||i<=0)throw new Error("GraphicsEngine.createSpaceship: size must be a positive finite number");if("object"!=typeof a||null===a)throw new Error("GraphicsEngine.createSpaceship: attributes must be an object");const _=this.createGroup({transform:`translate(${e}, ${r})`,...a}),s=this.createPath(`M 0 -${i} L ${i*t.SPACESHIP_HULL_WING_RATIO} ${i} L 0 ${i*t.SPACESHIP_HULL_BODY_RATIO} L -${i*t.SPACESHIP_HULL_WING_RATIO} ${i} Z`,{fill:"#4a90e2",stroke:"#ffffff","stroke-width":t.SPACESHIP_STROKE_WIDTH}),A=this.createCircle(0,i*t.SPACESHIP_ENGINE_RATIO,i*t.SPACESHIP_ENGINE_SIZE_RATIO,{fill:"#ff4444",opacity:.8}),n=this.createGroup({id:"mainThruster",opacity:0}),o=this.createPath(`M -${i*t.SPACESHIP_THRUSTER_MAIN_WIDTH} ${i*t.SPACESHIP_THRUSTER_OPACITY} L 0 ${i*t.SPACESHIP_THRUSTER_MAIN_HEIGHT} L ${i*t.SPACESHIP_THRUSTER_MAIN_WIDTH} ${i*t.SPACESHIP_THRUSTER_OPACITY} Z`,{fill:"#ff6600",opacity:t.SPACESHIP_THRUSTER_FLAME_OPACITY}),E=this.createPath(`M -${i*t.SPACESHIP_THRUSTER_CORE_WIDTH} ${i*t.SPACESHIP_THRUSTER_INNER_OPACITY} L 0 ${i*t.SPACESHIP_THRUSTER_CORE_HEIGHT} L ${i*t.SPACESHIP_THRUSTER_CORE_WIDTH} ${i*t.SPACESHIP_THRUSTER_INNER_OPACITY} Z`,{fill:"#ffaa00",opacity:t.SPACESHIP_THRUSTER_INNER_OPACITY}),I=this.createPath(`M -${Number(i)*t.SPACESHIP_THRUSTER_INNER_WIDTH} ${Number(i)*t.SPACESHIP_THRUSTER_CORE_HEIGHT_OFFSET} L 0 ${Number(i)*t.SPACESHIP_THRUSTER_INNER_HEIGHT} L ${Number(i)*t.SPACESHIP_THRUSTER_INNER_WIDTH} ${Number(i)*t.SPACESHIP_THRUSTER_CORE_HEIGHT_OFFSET} Z`,{fill:"#ffffff",opacity:t.SPACESHIP_THRUSTER_FLAME_OPACITY});n.appendChild(o),n.appendChild(E),n.appendChild(I);const T=this.createGroup({id:"leftThruster",opacity:0}),c=this.createPath(`M -${i*t.SPACESHIP_THRUSTER_SIDE_WIDTH} -${i*t.SPACESHIP_THRUSTER_SIDE_HEIGHT} L -${i*t.SPACESHIP_THRUSTER_SIDE_LENGTH} 0 L -${i*t.SPACESHIP_THRUSTER_SIDE_WIDTH} ${i*t.SPACESHIP_THRUSTER_SIDE_HEIGHT} Z`,{fill:"#0088ff",opacity:t.SPACESHIP_THRUSTER_SIDE_OPACITY});T.appendChild(c);const R=this.createGroup({id:"rightThruster",opacity:0}),l=this.createPath(`M ${i*t.SPACESHIP_THRUSTER_SIDE_WIDTH} -${i*t.SPACESHIP_THRUSTER_SIDE_HEIGHT} L ${i*t.SPACESHIP_THRUSTER_SIDE_LENGTH} 0 L ${i*t.SPACESHIP_THRUSTER_SIDE_WIDTH} ${i*t.SPACESHIP_THRUSTER_SIDE_HEIGHT} Z`,{fill:"#0088ff",opacity:t.SPACESHIP_THRUSTER_SIDE_OPACITY});return R.appendChild(l),_.appendChild(s),_.appendChild(A),_.appendChild(n),_.appendChild(T),_.appendChild(R),_}createOtherPlayerShip(e,r,i,a="#ff6b35",_=t.PLAYER_SHIP_DEFAULT_SIZE){if("number"!=typeof e||!isFinite(e))throw new Error("GraphicsEngine.createOtherPlayerShip: x must be a finite number");if("number"!=typeof r||!isFinite(r))throw new Error("GraphicsEngine.createOtherPlayerShip: y must be a finite number");if("string"!=typeof i||0===i.length)throw new Error("GraphicsEngine.createOtherPlayerShip: playerId must be a non-empty string");if("number"!=typeof _||!isFinite(_)||_<=0)throw new Error("GraphicsEngine.createOtherPlayerShip: size must be a positive finite number");if("string"!=typeof a||0===a.length)throw new Error("GraphicsEngine.createOtherPlayerShip: playerColor must be a non-empty string");const s=this.createGroup({id:`otherPlayer_${i}`,transform:`translate(${e}, ${r})`}),A=this.createPath(`M 0 -${_} L ${_*t.SPACESHIP_HULL_WING_RATIO} ${_} L 0 ${_*t.SPACESHIP_HULL_BODY_RATIO} L -${_*t.SPACESHIP_HULL_WING_RATIO} ${_} Z`,{fill:a,stroke:"#ffffff","stroke-width":t.SPACESHIP_STROKE_WIDTH,opacity:.8}),n=this.createCircle(0,_*t.SPACESHIP_ENGINE_RATIO,_*t.SPACESHIP_ENGINE_SIZE_RATIO,{fill:"#00ff88",opacity:.6}),o=this.createText(i,0,-_-t.PLAYER_NAME_LABEL_OFFSET,{"text-anchor":"middle",fill:"#ffffff","font-family":"monospace","font-size":"12px","font-weight":"bold","text-shadow":"0 0 2px #000000"});return s.appendChild(A),s.appendChild(n),s.appendChild(o),s}updateSpaceshipThrusters(e,r,i=!1){const a=e.querySelector("#mainThruster"),_=e.querySelector("#leftThruster"),s=e.querySelector("#rightThruster");if(!a||!_||!s)return;const A=i?t.SPACESHIP_THRUSTER_BOOST_OPACITY:t.SPACESHIP_THRUSTER_BASE_OPACITY,n=t.SPACESHIP_THRUSTER_FADE_SPEED;if(r.y>0)a.setAttribute("opacity",A);else{const t=parseFloat(a.getAttribute("opacity"))||0,e=Math.max(0,t-n);a.setAttribute("opacity",e)}if(r.x>0)_.setAttribute("opacity",A*t.SPACESHIP_THRUSTER_SIDE_OPACITY);else{const t=parseFloat(_.getAttribute("opacity"))||0,e=Math.max(0,t-n);_.setAttribute("opacity",e)}if(r.x<0)s.setAttribute("opacity",A*t.SPACESHIP_THRUSTER_SIDE_OPACITY);else{const t=parseFloat(s.getAttribute("opacity"))||0,e=Math.max(0,t-n);s.setAttribute("opacity",e)}}createPlanet(e,r,i,a={}){const _=this.createGroup({transform:`translate(${e}, ${r})`,...a}),s=a.surfaceColor||"#8b4513",A=a.coreColor||"#654321",n=a.atmosphereColor||"#4444ff",o=this.createGradient("radial",[{offset:"0%",color:s},{offset:"70%",color:A},{offset:"100%",color:"#2c1810"}],{cx:"30%",cy:"30%"}),E=this.createCircle(0,0,i,{fill:`url(#${o})`,stroke:n,"stroke-width":2,opacity:t.RATIO_OPACITY_HIGH});return _.appendChild(E),this.addPlanetCraters(_,i,s),this.addPlanetContinents(_,i,s),this.addPlanetAtmosphere(_,i,n),_}addPlanetCraters(e,r,i){const a=t.PLANET_CRATER_MIN+Math.floor(Math.random()*t.PLANET_CRATER_MAX);for(let _=0;_<a;_++){const a=Math.random()*Math.PI*t.FULL_CIRCLE,_=Math.random()*r*t.PLANET_CRATER_DISTANCE_MAX,s=Math.cos(a)*_,A=Math.sin(a)*_,n=Math.random()*r*t.PLANET_CRATER_SIZE_MAX+r*t.PLANET_CRATER_SIZE_MIN,o=this.createCircle(s,A,n,{fill:this.darkenColor(i,t.PLANET_DARKEN_FACTOR),opacity:.8}),E=this.createCircle(s,A,n*t.PLANET_CRATER_RIM_RATIO,{fill:"none",stroke:this.lightenColor(i,t.PLANET_LIGHTEN_FACTOR),"stroke-width":1,opacity:.6});e.appendChild(o),e.appendChild(E)}}addPlanetContinents(e,r,i){const a=t.PLANET_CONTINENT_MIN+Math.floor(Math.random()*t.PLANET_CONTINENT_MAX);for(let _=0;_<a;_++){const a=Math.random()*Math.PI*t.FULL_CIRCLE,_=Math.random()*r*t.PLANET_CONTINENT_DISTANCE_MAX,s=Math.cos(a)*_,A=Math.sin(a)*_,n=t.PLANET_CONTINENT_POINTS_MIN+Math.floor(Math.random()*t.PLANET_CONTINENT_POINTS_MAX);let o="";for(let e=0;e<n;e++){const i=e/n*t.PI_TIMES_2,a=r*(t.PLANET_CONTINENT_RADIUS_MIN+Math.random()*t.PLANET_CONTINENT_RADIUS_MAX),_=s+Math.cos(i)*a,E=A+Math.sin(i)*a;o+=0===e?`M ${_} ${E}`:` L ${_} ${E}`}o+=" Z";const E=this.createPath(o,{fill:this.lightenColor(i,t.PLANET_LIGHTEN_FACTOR),opacity:t.PLANET_CONTINENT_OPACITY,"clip-path":`circle(${r}px at 0px 0px)`});e.appendChild(E)}}addPlanetAtmosphere(e,r,i){const a=this.createGradient("radial",[{offset:"85%",color:i,opacity:0},{offset:"100%",color:i,opacity:.3}],{cx:"50%",cy:"50%"}),_=this.createCircle(0,0,r*t.GLOW_INTENSITY,{fill:`url(#${a})`,opacity:.6});e.appendChild(_)}darkenColor(e,r){if(e.startsWith("#")){const i=e.slice(1);return`rgb(${Math.floor(parseInt(i.slice(t.HEX_RED_START,t.HEX_RED_END),16)*(1-r))}, ${Math.floor(parseInt(i.slice(t.HEX_GREEN_START,t.HEX_GREEN_END),16)*(1-r))}, ${Math.floor(parseInt(i.slice(t.HEX_BLUE_START,t.HEX_BLUE_END),16)*(1-r))})`}return e}lightenColor(e,r){if(e.startsWith("#")){const i=e.slice(1);return`rgb(${Math.min(t.COLOR_MAX,Math.floor(parseInt(i.slice(t.HEX_RED_START,t.HEX_RED_END),16)*(1+r)))}, ${Math.min(t.COLOR_MAX,Math.floor(parseInt(i.slice(t.HEX_GREEN_START,t.HEX_GREEN_END),16)*(1+r)))}, ${Math.min(t.COLOR_MAX,Math.floor(parseInt(i.slice(t.HEX_BLUE_START,t.HEX_BLUE_END),16)*(1+r)))})`}return e}createSpaceStation(e,r,i=t.STATION_DEFAULT_SIZE,a={}){const _=this.createGroup({transform:`translate(${e}, ${r})`,...a}),s=this.createCircle(0,0,i*t.STATION_HUB_RATIO,{fill:"#666666",stroke:"#aaaaaa","stroke-width":2}),A=this.createCircle(0,0,i*t.STATION_RING_RATIO,{fill:"none",stroke:"#888888","stroke-width":i*t.STATION_RING_WIDTH,opacity:t.STATION_RING_OPACITY});for(let e=0;e<t.STATION_DOCKING_PORTS;e++){const r=e*t.ANGLE_90*Math.PI/t.ANGLE_180,a=Math.cos(r)*i,s=Math.sin(r)*i,A=this.createRect(a-i*t.STATION_PORT_WIDTH,s-i*t.STATION_PORT_HEIGHT,i*t.STATION_PORT_LENGTH,i*t.STATION_PORT_WIDTH,{fill:"#4a90e2",stroke:"#ffffff","stroke-width":1,transform:`rotate(${e*t.ANGLE_90}, ${a}, ${s})`});_.appendChild(A)}for(let e=0;e<t.STATION_SOLAR_PANELS;e++){const r=e*t.ANGLE_60*Math.PI/t.ANGLE_180,a=Math.cos(r)*i*t.STATION_PANEL_DISTANCE,s=Math.sin(r)*i*t.STATION_PANEL_DISTANCE,A=this.createRect(a-i*t.STATION_PANEL_WIDTH,s-i*t.STATION_PANEL_HEIGHT,i*t.STATION_PANEL_LENGTH,i*t.STATION_PANEL_WIDTH,{fill:"#1a1a3a",stroke:"#4444ff","stroke-width":1,opacity:t.STATION_PANEL_OPACITY,transform:`rotate(${e*t.ANGLE_60}, ${a}, ${s})`});_.appendChild(A)}const n=this.createRect(-i*t.STATION_COMM_WIDTH,-i*t.STATION_COMM_HEIGHT,i*t.STATION_COMM_LENGTH,i*t.STATION_COMM_WIDTH_RATIO,{fill:"#cccccc",stroke:"#ffffff","stroke-width":1});_.appendChild(s),_.appendChild(A),_.appendChild(n);const o=this.createCircle(-i*t.STATION_NAV_LIGHT_RATIO,0,i*t.STATION_NAV_LIGHT_SIZE,{fill:"#ff4444",opacity:t.STATION_NAV_LIGHT_OPACITY}),E=this.createCircle(i*t.STATION_NAV_LIGHT_RATIO,0,i*t.STATION_NAV_LIGHT_SIZE,{fill:"#44ff44",opacity:t.STATION_NAV_LIGHT_OPACITY});return _.appendChild(o),_.appendChild(E),_}createJumpGate(e,r,i=t.GATE_DEFAULT_SIZE,a={}){const _=this.createGroup({transform:`translate(${e}, ${r})`,...a}),s=this.createCircle(0,0,i,{fill:"none",stroke:"#00ffff","stroke-width":i*t.GATE_OUTER_STROKE_RATIO,opacity:t.GATE_OUTER_OPACITY,"stroke-dasharray":`${i*t.GATE_DASH_ARRAY_LONG} ${i*t.GATE_DASH_ARRAY_SHORT}`}),A=this.createCircle(0,0,i*t.GATE_INNER_RATIO,{fill:"none",stroke:"#ffffff","stroke-width":i*t.GATE_INNER_STROKE_RATIO,opacity:t.GATE_INNER_OPACITY}),n=this.createCircle(0,0,i*t.GATE_CORE_RATIO,{fill:"#00ffff",opacity:t.GATE_CORE_OPACITY,"fill-rule":"evenodd"});for(let e=0;e<t.GATE_STRUT_COUNT;e++){const r=e*t.ANGLE_90*Math.PI/t.ANGLE_180,a=Math.cos(r)*i*t.GATE_STRUT_INNER_RATIO,s=Math.sin(r)*i*t.GATE_STRUT_INNER_RATIO,A=Math.cos(r)*i*t.GATE_STRUT_OUTER_RATIO,n=Math.sin(r)*i*t.GATE_STRUT_OUTER_RATIO,o=this.createElement("line");o.setAttribute("x1",a),o.setAttribute("y1",s),o.setAttribute("x2",A),o.setAttribute("y2",n),o.setAttribute("stroke","#aaaaaa"),o.setAttribute("stroke-width",i*t.GATE_STRUT_WIDTH),_.appendChild(o)}const o=this.createGroup({id:`particles_${this.generateId("gate")}`});for(let e=0;e<t.GATE_PARTICLES;e++){const r=e*t.ANGLE_45*Math.PI/t.ANGLE_180,a=Math.cos(r)*i*t.GATE_PARTICLE_DISTANCE,_=Math.sin(r)*i*t.GATE_PARTICLE_DISTANCE,s=this.createCircle(a,_,i*t.GATE_PARTICLE_SIZE,{fill:"#00ffff",opacity:t.GATE_PARTICLE_OPACITY});o.appendChild(s)}const E=this.createElement("animateTransform");E.setAttribute("attributeName","transform"),E.setAttribute("type","rotate"),E.setAttribute("values","0 0 0;360 0 0"),E.setAttribute("dur",t.GATE_ANIMATION_DURATION_ROTATE),E.setAttribute("repeatCount","indefinite"),o.appendChild(E),_.appendChild(o),_.appendChild(n),_.appendChild(A),_.appendChild(s);const I=this.createElement("animate");I.setAttribute("attributeName","opacity"),I.setAttribute("values",`${t.GATE_PULSE_MIN};${t.GATE_PULSE_MAX};${t.GATE_PULSE_MIN}`),I.setAttribute("dur",t.GATE_ANIMATION_DURATION_PULSE),I.setAttribute("repeatCount","indefinite"),s.appendChild(I);const T=this.createElement("animate");return T.setAttribute("attributeName","opacity"),T.setAttribute("values",`${t.GATE_CORE_PULSE_MIN};${t.GATE_CORE_PULSE_MAX};${t.GATE_CORE_PULSE_MIN}`),T.setAttribute("dur",t.GATE_ANIMATION_DURATION_CORE),T.setAttribute("repeatCount","indefinite"),n.appendChild(T),_}addToLayer(t,e){return this.getLayer(t).appendChild(e),e}clear(){this.svg.innerHTML="",this.layers.clear(),this.defs=this.createDefs(),this.idCounter=0}remove(t){t.parentNode&&t.parentNode.removeChild(t)}createLaserBeam(e,r,i,a,_={}){const s=this.createGroup({id:this.generateId("laser"),..._}),A=this.createElement("line");A.setAttribute("x1",e),A.setAttribute("y1",r),A.setAttribute("x2",i),A.setAttribute("y2",a),A.setAttribute("stroke",_.color||"#ff0000"),A.setAttribute("stroke-width",_.width||t.LASER_DEFAULT_WIDTH),A.setAttribute("opacity",t.LASER_BEAM_OPACITY),A.setAttribute("stroke-linecap","round");const n=this.createElement("line");n.setAttribute("x1",e),n.setAttribute("y1",r),n.setAttribute("x2",i),n.setAttribute("y2",a),n.setAttribute("stroke",_.glowColor||"#ffaaaa"),n.setAttribute("stroke-width",(_.width||t.LASER_DEFAULT_WIDTH)*t.LASER_GLOW_MULTIPLIER),n.setAttribute("opacity",t.LASER_GLOW_OPACITY),n.setAttribute("stroke-linecap","round");const o=this.createElement("line");o.setAttribute("x1",e),o.setAttribute("y1",r),o.setAttribute("x2",i),o.setAttribute("y2",a),o.setAttribute("stroke","#ffffff"),o.setAttribute("stroke-width",1),o.setAttribute("opacity",t.LASER_CORE_OPACITY),o.setAttribute("stroke-linecap","round"),s.appendChild(n),s.appendChild(A),s.appendChild(o);const E=this.createElement("animate");return E.setAttribute("attributeName","opacity"),E.setAttribute("values","0;1;1;0"),E.setAttribute("dur",_.duration||"0.3s"),E.setAttribute("fill","freeze"),s.appendChild(E),setTimeout(()=>{this.remove(s)},parseFloat(_.duration||t.LASER_DEFAULT_DURATION)*t.SECONDS_TO_MS+t.LASER_CLEANUP_DELAY),s}createLaserImpact(e,r,i={}){const a=this.createGroup({id:this.generateId("impact"),transform:`translate(${e}, ${r})`}),_=this.createCircle(0,0,i.size||t.IMPACT_DEFAULT_SIZE,{fill:i.color||"#ffff00",opacity:t.RATIO_OPACITY_HIGH}),s=this.createCircle(0,0,(i.size||t.IMPACT_DEFAULT_SIZE)*t.IMPACT_RING_MULTIPLIER,{fill:"none",stroke:i.ringColor||"#ff8800","stroke-width":2,opacity:.7});for(let e=0;e<t.IMPACT_SPARKS;e++){const r=e*t.ANGLE_60*Math.PI/t.ANGLE_180,_=(i.size||t.IMPACT_DEFAULT_SIZE)*t.IMPACT_SPARK_DISTANCE,s=Math.cos(r)*_,A=Math.sin(r)*_,n=this.createElement("line");n.setAttribute("x1",0),n.setAttribute("y1",0),n.setAttribute("x2",s),n.setAttribute("y2",A),n.setAttribute("stroke","#ffffff"),n.setAttribute("stroke-width",1),n.setAttribute("opacity",t.IMPACT_SPARK_OPACITY),n.setAttribute("stroke-linecap","round"),a.appendChild(n)}a.appendChild(s),a.appendChild(_);const A=this.createElement("animateTransform");A.setAttribute("attributeName","transform"),A.setAttribute("type","scale"),A.setAttribute("values","0 0;1.5 1.5;0.5 0.5"),A.setAttribute("dur",i.duration||"0.4s"),A.setAttribute("fill","freeze"),A.setAttribute("additive","sum");const n=this.createElement("animate");return n.setAttribute("attributeName","opacity"),n.setAttribute("values","0;1;0"),n.setAttribute("dur",i.duration||"0.4s"),n.setAttribute("fill","freeze"),a.appendChild(A),a.appendChild(n),setTimeout(()=>{this.remove(a)},parseFloat(i.duration||t.IMPACT_DEFAULT_DURATION)*t.SECONDS_TO_MS+t.IMPACT_CLEANUP_DELAY),a}createAsteroidDamageIndicator(t,e,i,a={}){const{ringColor:_="#ff4444",ringOpacity:s=r.DEFAULT_RING_OPACITY,duration:A="1.5s",ringWidth:n=r.DEFAULT_RING_WIDTH,id:o=this.generateId("damage-ring")}=a,E=this.createGroup({id:o,transform:`translate(${t}, ${e})`}),I=this.createCircle(0,0,i+r.RING_RADIUS_OFFSET,{fill:"none",stroke:_,"stroke-width":n,opacity:s,"stroke-linecap":"round"}),T=this.createElement("animate");T.setAttribute("attributeName","opacity"),T.setAttribute("values",`${s};0.3;${s};0.3;0`),T.setAttribute("dur",A),T.setAttribute("fill","freeze"),T.setAttribute("repeatCount","1");const c=this.createElement("animateTransform");return c.setAttribute("attributeName","transform"),c.setAttribute("type","scale"),c.setAttribute("values","0.8;1.2;1.0;1.1;0.9"),c.setAttribute("dur",A),c.setAttribute("fill","freeze"),c.setAttribute("additive","sum"),I.appendChild(T),E.appendChild(c),E.appendChild(I),setTimeout(()=>{this.remove(E)},parseFloat(A)*r.ANIMATION_DELAY_MULTIPLIER+r.CLEANUP_DELAY_MS),E}createWeaponChargeIndicator(t,r,i,a={}){const{maxRadius:_=e.CHARGE_INDICATOR_MAX_RADIUS,color:s=this.getChargeIndicatorColor(i),glowColor:A=this.getChargeIndicatorGlowColor(i),id:n=this.generateId("weapon-charge")}=a,o=this.createGroup({id:n,transform:`translate(${t}, ${r})`}),E=Math.max(e.CHARGE_INDICATOR_MIN_RADIUS,_*i),I=Math.max(e.CHARGE_INDICATOR_MIN_OPACITY,i),T=this.createCircle(0,0,E+e.CHARGE_INDICATOR_GLOW_OFFSET,{fill:"none",stroke:A,"stroke-width":2,opacity:I*e.CHARGE_INDICATOR_GLOW_OPACITY,filter:"blur(2px)"}),c=this.createCircle(0,0,E,{fill:"none",stroke:s,"stroke-width":1.5,opacity:I,"stroke-dasharray":i<e.CHARGE_INDICATOR_DASH_THRESHOLD?"2,4":"none"});if(i>e.CHARGE_CORE_THRESHOLD){const t=this.createCircle(0,0,e.CHARGE_INDICATOR_MIN_RADIUS,{fill:"#ffffff",opacity:(i-e.CHARGE_CORE_THRESHOLD)/e.CHARGE_CORE_OPACITY_DIVISOR});o.appendChild(t)}if(i>e.CHARGE_PULSE_THRESHOLD){const t=this.createCircle(0,0,E,{fill:"none",stroke:"#ffffff","stroke-width":.5,opacity:0}),e=this.createElement("animate");e.setAttribute("attributeName","opacity"),e.setAttribute("values","0;0.8;0"),e.setAttribute("dur","1.5s"),e.setAttribute("repeatCount","indefinite"),t.appendChild(e),o.appendChild(t)}if(i<=e.LOW_ENERGY_WARNING_THRESHOLD){const t=this.createCircle(0,0,_+e.CHARGE_INDICATOR_GLOW_OFFSET,{id:"warning-pulse-ring",fill:"none",stroke:"#ff0000","stroke-width":2,opacity:e.LOW_ENERGY_PULSE_OPACITY_MIN}),r=this.createElement("animate");r.setAttribute("attributeName","opacity"),r.setAttribute("values",`${e.LOW_ENERGY_PULSE_OPACITY_MIN};${e.LOW_ENERGY_PULSE_OPACITY_MAX};${e.LOW_ENERGY_PULSE_OPACITY_MIN}`),r.setAttribute("dur",e.LOW_ENERGY_PULSE_DURATION),r.setAttribute("repeatCount","indefinite"),t.appendChild(r),o.appendChild(t)}return o.appendChild(T),o.appendChild(c),o}updateWeaponChargeIndicator(t,r){if(!t)return;const i=e.CHARGE_INDICATOR_MAX_RADIUS,a=Math.max(e.CHARGE_INDICATOR_MIN_RADIUS,i*r),_=Math.max(e.CHARGE_INDICATOR_MIN_OPACITY,r),s=this.getChargeIndicatorColor(r),A=this.getChargeIndicatorGlowColor(r),n=t.querySelector('circle[filter="blur(2px)"]');n&&(n.setAttribute("r",a+e.CHARGE_INDICATOR_GLOW_OFFSET),n.setAttribute("opacity",_*e.CHARGE_INDICATOR_GLOW_OPACITY),n.setAttribute("stroke",A));const o=t.querySelector('circle[stroke-width="1.5"]');o&&(o.setAttribute("r",a),o.setAttribute("opacity",_),o.setAttribute("stroke",s),o.setAttribute("stroke-dasharray",r<e.CHARGE_INDICATOR_DASH_THRESHOLD?"2,4":"none")),this.updateLowEnergyWarning(t,r);const E=t.querySelector('circle[fill="#ffffff"]'),I=null!==E;if(r>e.CHARGE_CORE_THRESHOLD&&!I){const i=this.createCircle(0,0,e.CHARGE_INDICATOR_MIN_RADIUS,{fill:"#ffffff",opacity:(r-e.CHARGE_CORE_THRESHOLD)/e.CHARGE_CORE_OPACITY_DIVISOR});t.appendChild(i)}else r<=e.CHARGE_CORE_THRESHOLD&&I?E.parentNode&&E.parentNode.removeChild(E):I&&E.setAttribute("opacity",(r-e.CHARGE_CORE_THRESHOLD)/e.CHARGE_CORE_OPACITY_DIVISOR)}getChargeIndicatorColor(t){if(t<=e.CHARGE_COLOR_LOW_THRESHOLD){const r=t/e.CHARGE_COLOR_LOW_THRESHOLD;return`rgb(${e.CHARGE_COLOR_RED_FULL}, ${Math.floor(e.CHARGE_COLOR_GREEN_DIM+e.CHARGE_COLOR_RANGE*r)}, ${0})`}if(t<=e.CHARGE_COLOR_MEDIUM_THRESHOLD){const r=(t-e.CHARGE_COLOR_LOW_THRESHOLD)/e.CHARGE_COLOR_LOW_THRESHOLD;return`rgb(${e.CHARGE_COLOR_RED_FULL}, ${e.CHARGE_COLOR_GREEN_FULL}, ${Math.floor(e.CHARGE_COLOR_BLUE_DIM*r)})`}{const r=(t-e.CHARGE_COLOR_MEDIUM_THRESHOLD)/e.CHARGE_COLOR_HIGH_ENERGY_FRACTION;return`rgb(${Math.floor(e.CHARGE_COLOR_RED_FULL-e.CHARGE_COLOR_RANGE*r)}, ${e.CHARGE_COLOR_GREEN_FULL}, ${Math.floor(e.CHARGE_COLOR_BLUE_DIM+e.CHARGE_COLOR_RANGE*r)})`}}getChargeIndicatorGlowColor(t){if(t<=e.CHARGE_COLOR_LOW_THRESHOLD){const r=t/e.CHARGE_COLOR_LOW_THRESHOLD;return`rgb(${e.CHARGE_COLOR_RED_FULL}, ${Math.floor(e.CHARGE_COLOR_GLOW_DIM+e.CHARGE_COLOR_GREEN_DIM*r)}, ${Math.floor(e.CHARGE_COLOR_GLOW_DIM*r)})`}if(t<=e.CHARGE_COLOR_MEDIUM_THRESHOLD){const r=(t-e.CHARGE_COLOR_LOW_THRESHOLD)/e.CHARGE_COLOR_LOW_THRESHOLD;return`rgb(${e.CHARGE_COLOR_RED_FULL}, ${Math.floor(e.CHARGE_COLOR_GLOW_MED+e.CHARGE_COLOR_GLOW_RANGE_LARGE*r)}, ${Math.floor(e.CHARGE_COLOR_GLOW_DIM+e.CHARGE_COLOR_GLOW_RANGE_SMALL*r)})`}{const r=(t-e.CHARGE_COLOR_MEDIUM_THRESHOLD)/e.CHARGE_COLOR_HIGH_ENERGY_FRACTION;return`rgb(${Math.floor(e.CHARGE_COLOR_RED_FULL-e.CHARGE_COLOR_RANGE*r)}, ${e.CHARGE_COLOR_GREEN_FULL}, ${Math.floor(e.CHARGE_COLOR_BLUE_DIM+e.CHARGE_COLOR_RANGE*r)})`}}updateLowEnergyWarning(t,r){if(!t)return;const i=r<=e.LOW_ENERGY_WARNING_THRESHOLD,a="warning-pulse-ring",_=t.querySelector(`#${a}`);if(i&&!_){const r=e.CHARGE_INDICATOR_MAX_RADIUS,i=this.createCircle(0,0,r+e.CHARGE_INDICATOR_GLOW_OFFSET,{id:a,fill:"none",stroke:"#ff0000","stroke-width":2,opacity:e.LOW_ENERGY_PULSE_OPACITY_MIN}),_=this.createElement("animate");_.setAttribute("attributeName","opacity"),_.setAttribute("values",`${e.LOW_ENERGY_PULSE_OPACITY_MIN};${e.LOW_ENERGY_PULSE_OPACITY_MAX};${e.LOW_ENERGY_PULSE_OPACITY_MIN}`),_.setAttribute("dur",e.LOW_ENERGY_PULSE_DURATION),_.setAttribute("repeatCount","indefinite"),i.appendChild(_),t.appendChild(i)}else!i&&_&&_.parentNode&&_.parentNode.removeChild(_)}createWeaponHeatIndicator(t,r,i,a={}){const{id:_=this.generateId("weapon-heat")}=a,s=this.createGroup({id:_,transform:`translate(${t}, ${r})`}),A=this.createRect(-e.HEAT_BAR_WIDTH/2,0,e.HEAT_BAR_WIDTH,e.HEAT_BAR_HEIGHT,{fill:"rgba(0, 0, 0, 0.3)",stroke:"#666666","stroke-width":1}),n=Math.max(0,e.HEAT_BAR_WIDTH*i),o=this.createRect(-e.HEAT_BAR_WIDTH/2,0,n,e.HEAT_BAR_HEIGHT,{fill:this.getHeatIndicatorColor(i),id:"heat-fill"});return s.appendChild(A),s.appendChild(o),this.updateHeatWarning(s,i),s}updateWeaponHeatIndicator(t,r){if(!t)return;const i=t.querySelector("#heat-fill");if(i){const t=Math.max(0,e.HEAT_BAR_WIDTH*r);i.setAttribute("width",t),i.setAttribute("fill",this.getHeatIndicatorColor(r))}this.updateHeatWarning(t,r)}getHeatIndicatorColor(t){if(t<e.HEAT_COLOR_TRANSITION_MID){const r=2*t;return`rgb(${Math.floor(e.HEAT_COLOR_MAX*r)}, ${e.HEAT_COLOR_MAX}, ${0})`}{const r=2*(t-e.HEAT_COLOR_TRANSITION_MID);return`rgb(${e.HEAT_COLOR_MAX}, ${Math.floor(e.HEAT_COLOR_MAX*(1-r))}, ${0})`}}updateHeatWarning(t,r){if(!t)return;const i=r>=e.HEAT_WARNING_THRESHOLD/e.MAX_HEAT,a="heat-warning-pulse",_=t.querySelector(`#${a}`);if(i&&!_){const r=this.createRect(-e.HEAT_BAR_WIDTH/2-e.HEAT_WARNING_BORDER_OFFSET,-e.HEAT_WARNING_BORDER_OFFSET,e.HEAT_BAR_WIDTH+e.HEAT_WARNING_BORDER_EXTRA,e.HEAT_BAR_HEIGHT+e.HEAT_WARNING_BORDER_EXTRA,{id:a,fill:"none",stroke:"#ff0000","stroke-width":2,opacity:.3}),i=this.createElement("animate");i.setAttribute("attributeName","opacity"),i.setAttribute("values","0.3;1.0;0.3"),i.setAttribute("dur",e.HEAT_WARNING_PULSE_DURATION),i.setAttribute("repeatCount","indefinite"),r.appendChild(i),t.appendChild(r)}else!i&&_&&_.remove()}createProjectile(e,r,i="plasma",a={}){const _=this.createGroup({id:this.generateId("projectile"),transform:`translate(${e}, ${r})`,...a});if("plasma"===i){const e=this.createCircle(0,0,t.PROJECTILE_PLASMA_CORE,{fill:"#00ffff",opacity:t.RATIO_OPACITY_HIGH}),r=this.createCircle(0,0,t.PROJECTILE_PLASMA_GLOW,{fill:"#00aaff",opacity:t.PROJECTILE_PLASMA_GLOW_OPACITY}),i=this.createCircle(0,0,t.PROJECTILE_PLASMA_TRAIL,{fill:"none",stroke:"#0088ff","stroke-width":t.PROJECTILE_PLASMA_TRAIL_WIDTH,opacity:t.PROJECTILE_PLASMA_TRAIL_OPACITY});_.appendChild(i),_.appendChild(r),_.appendChild(e)}else if("missile"===i){const e=this.createPath("M -8 0 L 8 -2 L 10 0 L 8 2 Z",{fill:"#666666",stroke:"#aaaaaa","stroke-width":t.PROJECTILE_MISSILE_STROKE_WIDTH}),r=this.createCircle(t.PROJECTILE_MISSILE_WIDTH,0,t.PROJECTILE_MISSILE_WARHEAD,{fill:"#ff4444",opacity:t.PROJECTILE_MISSILE_WARHEAD_OPACITY}),i=this.createPath("M -8 0 L -15 -1 L -12 0 L -15 1 Z",{fill:"#ff8800",opacity:t.PROJECTILE_MISSILE_EXHAUST_OPACITY});_.appendChild(i),_.appendChild(e),_.appendChild(r)}else if("railgun"===i){const e=this.createRect(-t.PROJECTILE_RAILGUN_WIDTH/2,-t.PROJECTILE_RAILGUN_HEIGHT/2,t.PROJECTILE_RAILGUN_WIDTH,t.PROJECTILE_RAILGUN_HEIGHT,{fill:"#ffff00",opacity:t.RATIO_OPACITY_HIGH}),r=this.createRect(-t.PROJECTILE_RAILGUN_FIELD_WIDTH/2,-t.PROJECTILE_RAILGUN_FIELD_HEIGHT/2,t.PROJECTILE_RAILGUN_FIELD_WIDTH,t.PROJECTILE_RAILGUN_FIELD_HEIGHT,{fill:"none",stroke:"#ffff88","stroke-width":t.PROJECTILE_RAILGUN_FIELD_WIDTH_STROKE,opacity:t.PROJECTILE_RAILGUN_FIELD_OPACITY});_.appendChild(r),_.appendChild(e)}return _}createExplosion(e,r,i=t.EXPLOSION_DEFAULT_SIZE,a={}){const _=this.createGroup({id:this.generateId("explosion"),transform:`translate(${e}, ${r})`}),s=a.colors||["#ff4444","#ff8800","#ffff00","#ffffff"],A=t.EXPLOSION_RINGS;for(let e=0;e<A;e++){const r=this.createCircle(0,0,i*(t.EXPLOSION_RING_BASE+e*t.EXPLOSION_RING_INCREMENT),{fill:"none",stroke:s[e]||s[s.length-1],"stroke-width":i*t.EXPLOSION_STROKE_WIDTH,opacity:t.EXPLOSION_RING_OPACITY_BASE-e*t.EXPLOSION_RING_OPACITY_DECREMENT});_.appendChild(r)}const n=this.createCircle(0,0,i*t.EXPLOSION_FLASH_RATIO,{fill:"#ffffff",opacity:t.EXPLOSION_FLASH_OPACITY});for(let e=0;e<t.EXPLOSION_PARTICLES;e++){const r=e*t.ANGLE_30*Math.PI/t.ANGLE_180,a=i*t.EXPLOSION_PARTICLE_DISTANCE,s=Math.cos(r)*a,A=Math.sin(r)*a,n=this.createCircle(s,A,t.EXPLOSION_PARTICLE_SIZE,{fill:"#ffaa00",opacity:t.EXPLOSION_PARTICLE_OPACITY});_.appendChild(n)}_.appendChild(n);const o=this.createElement("animateTransform");o.setAttribute("attributeName","transform"),o.setAttribute("type","scale"),o.setAttribute("values","0 0;2 2;1 1"),o.setAttribute("dur",a.duration||t.EXPLOSION_DEFAULT_DURATION),o.setAttribute("fill","freeze"),o.setAttribute("additive","sum");const E=this.createElement("animate");return E.setAttribute("attributeName","opacity"),E.setAttribute("values","0;1;0"),E.setAttribute("dur",a.duration||t.EXPLOSION_DEFAULT_DURATION),E.setAttribute("fill","freeze"),_.appendChild(o),_.appendChild(E),setTimeout(()=>{this.remove(_)},parseFloat(a.duration||t.EXPLOSION_DEFAULT_DURATION)*t.SECONDS_TO_MS+t.EXPLOSION_CLEANUP_DELAY),_}createShieldEffect(e,r,i=t.SHIELD_DEFAULT_RADIUS,a={}){const _=this.createGroup({id:this.generateId("shield"),transform:`translate(${e}, ${r})`}),s=a.color||"#00aaff",A=this.createPath(`M ${i} 0 L ${i*t.SHIELD_HEX_RATIO} ${i*t.SHIELD_HEX_RATIO_LONG} L ${-i*t.SHIELD_HEX_RATIO} ${i*t.SHIELD_HEX_RATIO_LONG} \n             L ${-i} 0 L ${-i*t.SHIELD_HEX_RATIO} ${-i*t.SHIELD_HEX_RATIO_LONG} L ${i*t.SHIELD_HEX_RATIO} ${-i*t.SHIELD_HEX_RATIO_LONG} Z`,{fill:"none",stroke:s,"stroke-width":t.SHIELD_STROKE_WIDTH,opacity:t.SHIELD_HEX_OPACITY}),n=this.createCircle(0,0,i*t.SHIELD_FIELD_RATIO,{fill:s,opacity:t.SHIELD_FIELD_OPACITY});for(let e=0;e<t.SHIELD_LINES;e++){const r=e*t.ANGLE_60*Math.PI/t.ANGLE_180,a=Math.cos(r)*i*t.SHIELD_LINE_LENGTH,A=Math.sin(r)*i*t.SHIELD_LINE_LENGTH,n=this.createElement("line");n.setAttribute("x1",0),n.setAttribute("y1",0),n.setAttribute("x2",a),n.setAttribute("y2",A),n.setAttribute("stroke",s),n.setAttribute("stroke-width",t.SHIELD_LINE_WIDTH),n.setAttribute("opacity",t.SHIELD_LINE_OPACITY),_.appendChild(n)}_.appendChild(n),_.appendChild(A);const o=this.createElement("animate");return o.setAttribute("attributeName","opacity"),o.setAttribute("values",`${t.SHIELD_PULSE_MIN};${t.SHIELD_PULSE_MAX};${t.SHIELD_PULSE_MIN}`),o.setAttribute("dur",t.SHIELD_PULSE_DURATION),o.setAttribute("repeatCount","indefinite"),_.appendChild(o),_}animate(e,r,i=t.CLEANUP_DELAY_MS,a="ease-in-out"){const _=this.createElement("animateTransform");return _.setAttribute("attributeName","transform"),_.setAttribute("dur",`${i}ms`),_.setAttribute("fill","freeze"),r.transform&&(_.setAttribute("type",r.transform.type||"translate"),_.setAttribute("values",r.transform.values)),e.appendChild(_),new Promise(t=>{setTimeout(t,i)})}addProximityGlow(t,e="#00ffff"){if(!t)return;t.style.filter="url(#proximityGlow)",t.setAttribute("data-proximity-glow","true");const r=this.createElement("animate");if(r.setAttribute("attributeName","opacity"),r.setAttribute("values","0.4;0.8;0.4"),r.setAttribute("dur","1.5s"),r.setAttribute("repeatCount","indefinite"),r.setAttribute("id","proximityPulse"),t.appendChild(r),"g"===t.tagName){t.querySelectorAll("circle, path, rect, line").forEach(t=>{const r=t.getAttribute("stroke");t.setAttribute("data-original-stroke",r||"none"),t.setAttribute("stroke",e),t.setAttribute("stroke-width","2")})}}removeProximityGlow(t){if(!t)return;t.style.filter="",t.removeAttribute("data-proximity-glow");const e=t.querySelector("#proximityPulse");if(e&&t.removeChild(e),"g"===t.tagName){t.querySelectorAll("[data-original-stroke]").forEach(t=>{const e=t.getAttribute("data-original-stroke");"none"===e?t.removeAttribute("stroke"):t.setAttribute("stroke",e),t.removeAttribute("data-original-stroke")})}}createRadar(e,r,i,a={}){if("number"!=typeof e||!isFinite(e))throw new Error("GraphicsEngine.createRadar: cx must be a finite number");if("number"!=typeof r||!isFinite(r))throw new Error("GraphicsEngine.createRadar: cy must be a finite number");if("number"!=typeof i||!isFinite(i)||i<=0)throw new Error("GraphicsEngine.createRadar: radius must be a positive finite number");if("object"!=typeof a||null===a)throw new Error("GraphicsEngine.createRadar: options must be an object");const{backgroundColor:_="#001122",borderColor:s="#00ff88",gridColor:A="#004466",scanlineColor:n="#00ffaa",borderWidth:o=t.RADAR_BORDER_WIDTH,gridLines:E=t.RADAR_GRID_LINES,sweepAnimation:I=!0,id:T=this.generateId("radar")}=a,c=this.createElement("g");c.setAttribute("id",T),c.setAttribute("transform",`translate(${e}, ${r})`);const R=this.createCircle(0,0,i,{fill:_,stroke:s,"stroke-width":o,opacity:.8});c.appendChild(R);for(let t=1;t<=E;t++){const e=i/E*t,r=this.createCircle(0,0,e,{fill:"none",stroke:A,"stroke-width":1,opacity:.5});c.appendChild(r)}const l=this.createLine(-i,0,i,0,{stroke:A,"stroke-width":1,opacity:.5});c.appendChild(l);const h=this.createLine(0,-i,0,i,{stroke:A,"stroke-width":1,opacity:.5});if(c.appendChild(h),I){const e=this.createLine(0,0,0,-i,{stroke:n,"stroke-width":2,opacity:.8,id:`${T}_sweep`}),r=this.createElement("animateTransform");r.setAttribute("attributeName","transform"),r.setAttribute("type","rotate"),r.setAttribute("values","0;360;0"),r.setAttribute("dur","4s"),r.setAttribute("repeatCount","indefinite"),e.appendChild(r),c.appendChild(e);const a=t.RADAR_TRAIL_ARC_DEGREES,_=a*t.DEGREES_TO_RADIANS_FACTOR,s=i*Math.sin(_),A=-i*Math.cos(_),o=a>t.LARGE_ARC_THRESHOLD_DEGREES?1:0,E=this.createPath(`M 0,0 L 0,${-i} A ${i},${i} 0 ${o},1 ${s},${A}`,{fill:n,opacity:t.RADAR_TRAIL_OPACITY,id:`${T}_trail`}),I=this.createElement("animateTransform");I.setAttribute("attributeName","transform"),I.setAttribute("type","rotate"),I.setAttribute("values","0;360;0"),I.setAttribute("dur",t.RADAR_SWEEP_DURATION),I.setAttribute("begin",`${t.RADAR_TRAIL_ANIMATION_DELAY}s`),I.setAttribute("repeatCount","indefinite"),E.appendChild(I),c.appendChild(E)}const O=this.createElement("g");return O.setAttribute("id",`${T}_blips`),c.appendChild(O),c}createWormhole(e,r,i=t.WORMHOLE_DEFAULT_SIZE,a={}){const _=this.createGroup({transform:`translate(${e}, ${r})`,...a}),s=this.createCircle(0,0,i,{fill:"none",stroke:"#220066","stroke-width":i*t.WORMHOLE_EVENT_HORIZON_WIDTH_RATIO,opacity:.8}),A=`wormhole-gradient-${this.generateId()}`,n=this.createElement("radialGradient");n.setAttribute("id",A),n.setAttribute("cx","50%"),n.setAttribute("cy","50%"),n.setAttribute("r","50%");const o=this.createElement("stop");o.setAttribute("offset","0%"),o.setAttribute("stop-color","#000000"),o.setAttribute("stop-opacity","1");const E=this.createElement("stop");E.setAttribute("offset",`${t.WORMHOLE_GRADIENT_STOP_30}%`),E.setAttribute("stop-color","#110033"),E.setAttribute("stop-opacity","0.9");const I=this.createElement("stop");I.setAttribute("offset",`${t.WORMHOLE_GRADIENT_STOP_70}%`),I.setAttribute("stop-color","#330066"),I.setAttribute("stop-opacity","0.6");const T=this.createElement("stop");T.setAttribute("offset","100%"),T.setAttribute("stop-color","#660099"),T.setAttribute("stop-opacity","0.2"),n.appendChild(o),n.appendChild(E),n.appendChild(I),n.appendChild(T),this.defs.appendChild(n);const c=this.createCircle(0,0,i*t.WORMHOLE_CORE_SIZE_RATIO,{fill:`url(#${A})`,opacity:.9}),R=this.createGroup({id:`spiral-${this.generateId()}`});for(let e=0;e<t.WORMHOLE_SPIRAL_COUNT;e++){const r=i*(t.WORMHOLE_SPIRAL_BASE_RADIUS+e*t.WORMHOLE_SPIRAL_RADIUS_INCREMENT),a=e*t.WORMHOLE_SPIRAL_ROTATION_INCREMENT,_=this.createPath(`M ${r},0 A ${r},${r} 0 1,1 ${-r*t.WORMHOLE_SPIRAL_ARC_FIRST},${r*t.WORMHOLE_SPIRAL_ARC_FIRST} A ${r*t.WORMHOLE_SPIRAL_ARC_SECOND},${r*t.WORMHOLE_SPIRAL_ARC_SECOND} 0 1,1 0,${-r*t.WORMHOLE_SPIRAL_END_RADIUS}`,{fill:"none",stroke:`hsl(${t.WORMHOLE_SPIRAL_HUE_BASE+e*t.WORMHOLE_SPIRAL_HUE_INCREMENT}, 80%, ${t.WORMHOLE_SPIRAL_LIGHTNESS_BASE-e*t.WORMHOLE_SPIRAL_LIGHTNESS_DECREMENT}%)`,"stroke-width":i*t.WORMHOLE_SPIRAL_STROKE_WIDTH,opacity:t.WORMHOLE_SPIRAL_OPACITY_BASE-e*t.WORMHOLE_SPIRAL_OPACITY_DECREMENT,"stroke-linecap":"round",transform:`rotate(${a})`}),s=this.createElement("animateTransform");s.setAttribute("attributeName","transform"),s.setAttribute("type","rotate"),s.setAttribute("values",`${a} 0 0;${a+t.WORMHOLE_FULL_ROTATION} 0 0`),s.setAttribute("dur",`${t.WORMHOLE_SPIRAL_ANIMATION_BASE_DURATION+e*t.WORMHOLE_SPIRAL_ANIMATION_DURATION_INCREMENT}s`),s.setAttribute("repeatCount","indefinite"),_.appendChild(s),R.appendChild(_)}const l=this.createGroup({id:`particles-${this.generateId()}`});for(let e=0;e<t.WORMHOLE_PARTICLES_COUNT;e++){const r=e/t.WORMHOLE_PARTICLES_COUNT*t.WORMHOLE_FULL_ROTATION,a=i*(t.WORMHOLE_PARTICLE_DISTANCE_BASE+Math.random()*t.WORMHOLE_PARTICLE_DISTANCE_VARIATION),_=Math.cos(r*Math.PI/t.WORMHOLE_ANGLE_TO_RADIANS)*a,s=Math.sin(r*Math.PI/t.WORMHOLE_ANGLE_TO_RADIANS)*a,A=this.createCircle(_,s,i*t.WORMHOLE_PARTICLE_SIZE,{fill:"#ffffff",opacity:.8});l.appendChild(A)}const h=this.createElement("animateTransform");h.setAttribute("attributeName","transform"),h.setAttribute("type","rotate"),h.setAttribute("values",`0 0 0;${t.WORMHOLE_FULL_ROTATION} 0 0`),h.setAttribute("dur",`${t.WORMHOLE_PARTICLE_ORBIT_DURATION}s`),h.setAttribute("repeatCount","indefinite"),l.appendChild(h);const O=this.createGroup();for(let e=0;e<t.WORMHOLE_DISTORTION_RINGS_COUNT;e++){const r=i*(t.WORMHOLE_DISTORTION_RING_BASE_RADIUS+e*t.WORMHOLE_DISTORTION_RING_RADIUS_INCREMENT),a=this.createCircle(0,0,r,{fill:"none",stroke:"#4400aa","stroke-width":1,opacity:.3,"stroke-dasharray":"5,10"}),_=this.createElement("animate");_.setAttribute("attributeName","opacity"),_.setAttribute("values","0.1;0.4;0.1"),_.setAttribute("dur",`${t.WORMHOLE_DISTORTION_PULSE_BASE_DURATION+e}s`),_.setAttribute("repeatCount","indefinite"),_.setAttribute("begin",e*t.WORMHOLE_DISTORTION_PULSE_DELAY+"s"),a.appendChild(_),O.appendChild(a)}return _.appendChild(O),_.appendChild(c),_.appendChild(R),_.appendChild(l),_.appendChild(s),_}}