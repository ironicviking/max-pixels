import{GRAPHICS as t,WEAPONS as e}from"../constants.js";export class GraphicsEngine{constructor(t){this.svg=t,this.layers=new Map,this.defs=this.svg.querySelector("defs")||this.createDefs(),this.idCounter=0}createDefs(){const t=this.createElement("defs");return this.svg.appendChild(t),this.defs=t,this.createProximityGlowFilter(),t}createProximityGlowFilter(){const t=this.createElement("filter");t.setAttribute("id","proximityGlow"),t.setAttribute("x","-50%"),t.setAttribute("y","-50%"),t.setAttribute("width","200%"),t.setAttribute("height","200%");const e=this.createElement("feGaussianBlur");e.setAttribute("stdDeviation","4"),e.setAttribute("result","coloredBlur");const r=this.createElement("feMerge"),i=this.createElement("feMergeNode");i.setAttribute("in","coloredBlur");const a=this.createElement("feMergeNode");a.setAttribute("in","SourceGraphic"),r.appendChild(i),r.appendChild(a),t.appendChild(e),t.appendChild(r),this.defs.appendChild(t)}createNebulaPattern(e={}){const{id:r=this.generateId("nebula"),colors:i=["#663399","#9966cc","#cc66cc","#6633cc"],baseSize:a=t.NEBULA_BASE_SIZE,opacity:s=t.NEBULA_BASE_OPACITY}=e,n=this.createElement("pattern");n.setAttribute("id",r),n.setAttribute("x","0"),n.setAttribute("y","0"),n.setAttribute("width",a),n.setAttribute("height",a),n.setAttribute("patternUnits","userSpaceOnUse");const A=t.NEBULA_CLOUD_COUNT_MIN+Math.floor(Math.random()*(t.NEBULA_CLOUD_COUNT_MAX-t.NEBULA_CLOUD_COUNT_MIN));for(let e=0;e<A;e++){const e=this.createElement("ellipse"),r=Math.random()*a,A=Math.random()*a,_=t.NEBULA_CLOUD_RX_MIN+Math.random()*(t.NEBULA_CLOUD_RX_MAX-t.NEBULA_CLOUD_RX_MIN),o=t.NEBULA_CLOUD_RY_MIN+Math.random()*(t.NEBULA_CLOUD_RY_MAX-t.NEBULA_CLOUD_RY_MIN),E=i[Math.floor(Math.random()*i.length)],I=s*(t.NEBULA_CLOUD_OPACITY_MIN+Math.random()*(t.NEBULA_CLOUD_OPACITY_MAX-t.NEBULA_CLOUD_OPACITY_MIN));e.setAttribute("cx",r),e.setAttribute("cy",A),e.setAttribute("rx",_),e.setAttribute("ry",o),e.setAttribute("fill",E),e.setAttribute("opacity",I),e.setAttribute("filter","blur(15px)");const T=Math.random()*t.NEBULA_ROTATION_MAX;e.setAttribute("transform",`rotate(${T} ${r} ${A})`),n.appendChild(e)}return this.defs.appendChild(n),r}createNebulaBackground(e,r,i=["purple","blue","red"]){const a=this.createGroup({id:"nebulaBackground"}),s={purple:{colors:["#663399","#9966cc","#cc66cc","#6633cc"],opacity:.25},blue:{colors:["#336699","#6699cc","#66ccff","#3366cc"],opacity:.2},red:{colors:["#994433","#cc6666","#ff6666","#cc3366"],opacity:.3},green:{colors:["#339966","#66cc99","#66ff99","#33cc66"],opacity:.15}},n=t.NEBULA_COUNT_MIN+Math.floor(Math.random()*(t.NEBULA_COUNT_MAX-t.NEBULA_COUNT_MIN+1));for(let A=0;A<n;A++){const n=s[i[Math.floor(Math.random()*i.length)]];if(!n)continue;const A=this.createNebulaPattern({colors:n.colors,opacity:n.opacity,baseSize:t.NEBULA_PATTERN_SIZE_MIN+Math.random()*(t.NEBULA_PATTERN_SIZE_MAX-t.NEBULA_PATTERN_SIZE_MIN)}),_=this.createElement("rect"),o=e*(t.NEBULA_REGION_WIDTH_MIN+Math.random()*(t.NEBULA_REGION_WIDTH_MAX-t.NEBULA_REGION_WIDTH_MIN)),E=r*(t.NEBULA_REGION_HEIGHT_MIN+Math.random()*(t.NEBULA_REGION_HEIGHT_MAX-t.NEBULA_REGION_HEIGHT_MIN)),I=Math.random()*(e-o),T=Math.random()*(r-E);_.setAttribute("x",I),_.setAttribute("y",T),_.setAttribute("width",o),_.setAttribute("height",E),_.setAttribute("fill",`url(#${A})`),_.setAttribute("opacity",t.NEBULA_REGION_OPACITY),a.appendChild(_)}return a}createCosmicDustField(e,r,i={}){const{particleCount:a=t.DUST_PARTICLE_COUNT_MIN+Math.floor(Math.random()*(t.DUST_PARTICLE_COUNT_MAX-t.DUST_PARTICLE_COUNT_MIN)),minSize:s=t.DUST_SIZE_MIN,maxSize:n=t.DUST_SIZE_MAX,minOpacity:A=t.DUST_OPACITY_MIN,maxOpacity:_=t.DUST_OPACITY_MAX,colors:o=["#888899","#aabbcc","#667788","#99aacc"],density:E=t.DUST_DENSITY_NORMAL}=i,I=this.createGroup({id:"cosmicDustField"}),T=Math.floor(a*E),c=this.generateId("dustPattern"),h=this.createElement("pattern");h.setAttribute("id",c),h.setAttribute("x","0"),h.setAttribute("y","0"),h.setAttribute("width",t.NEBULA_BASE_SIZE),h.setAttribute("height",t.NEBULA_BASE_SIZE),h.setAttribute("patternUnits","userSpaceOnUse");const l=Math.floor(t.DUST_CLOUD_COUNT_MIN*t.COUNT_MEDIUM);for(let e=0;e<l;e++){const e=this.createElement("circle"),r=Math.random()*t.NEBULA_BASE_SIZE,i=Math.random()*t.NEBULA_BASE_SIZE,a=s+Math.random()*(n-s),E=A+Math.random()*(_-A),I=o[Math.floor(Math.random()*o.length)];e.setAttribute("cx",r),e.setAttribute("cy",i),e.setAttribute("r",a),e.setAttribute("fill",I),e.setAttribute("opacity",E),h.appendChild(e)}this.defs.appendChild(h);const u=Math.max(t.DUST_CLOUD_COUNT_MIN,T/(t.DUST_CLOUD_COUNT_MAX*t.COUNT_MEDIUM/t.COUNT_MINIMUM));for(let i=0;i<u;i++){const i=this.createElement("rect"),a=t.SIZE_LARGE*t.COUNT_LARGE+Math.random()*(t.SIZE_LARGE*t.COUNT_MAXIMUM),s=t.NEBULA_BASE_SIZE+Math.random()*(t.SIZE_LARGE*t.COUNT_LARGE),n=Math.random()*(e-a),A=Math.random()*(r-s),_=Math.random()*t.FULL_ROTATION*t.FULL_CIRCLE;i.setAttribute("x",n),i.setAttribute("y",A),i.setAttribute("width",a),i.setAttribute("height",s),i.setAttribute("fill",`url(#${c})`),i.setAttribute("opacity",t.RATIO_OPACITY_LOW+Math.random()*t.RATIO_SIZE_SMALL),i.setAttribute("transform",`rotate(${_} ${n+a/t.FULL_CIRCLE} ${A+s/t.FULL_CIRCLE})`),I.appendChild(i)}const d=Math.floor(T*t.RATIO_OPACITY_LOW);for(let i=0;i<d;i++){const i=this.createElement("circle"),a=Math.random()*e,E=Math.random()*r,T=t.RATIO_SIZE_LARGE+Math.random()*(n*(t.GLOW_INTENSITY+t.RATIO_SIZE_SMALL)-s*t.RATIO_SIZE_LARGE),c=s*t.RATIO_SIZE_LARGE+Math.random()*T,h=_*t.RATIO_SIZE_LARGE-A*t.RATIO_OPACITY_MID,l=A*t.RATIO_OPACITY_MID+Math.random()*h,u=o[Math.floor(Math.random()*o.length)];if(i.setAttribute("cx",a),i.setAttribute("cy",E),i.setAttribute("r",c),i.setAttribute("fill",u),i.setAttribute("opacity",l),Math.random()<t.DUST_ANIMATION_CHANCE){const e=this.createElement("animate");e.setAttribute("attributeName","opacity"),e.setAttribute("values",`${l};${l*t.RATIO_OPACITY_LOW};${l}`),e.setAttribute("dur",`${t.DUST_ANIMATION_DURATION_MIN+Math.random()*(t.DUST_ANIMATION_DURATION_MAX-t.DUST_ANIMATION_DURATION_MIN)}s`),e.setAttribute("repeatCount","indefinite"),e.setAttribute("begin",`${Math.random()*t.COUNT_LARGE+t.FULL_CIRCLE}s`),i.appendChild(e)}I.appendChild(i)}return I}createSpaceDebrisField(e,r,i={}){const{debrisCount:a=t.DEBRIS_FIELD_COUNT_MIN+Math.floor(Math.random()*(t.DEBRIS_FIELD_COUNT_MAX-t.DEBRIS_FIELD_COUNT_MIN)),density:s=t.DEBRIS_DENSITY_NORMAL,minSize:n=t.DEBRIS_SIZE_MIN,maxSize:A=t.DEBRIS_SIZE_MAX,types:_=t.DEBRIS_TYPES}=i,o=this.createGroup({id:"spaceDebrisField"}),E=Math.floor(a*s),I=t.DEBRIS_CLUSTER_COUNT_MIN+Math.floor(Math.random()*(t.DEBRIS_CLUSTER_COUNT_MAX-t.DEBRIS_CLUSTER_COUNT_MIN));for(let i=0;i<I;i++){const i=Math.random()*e,a=Math.random()*r,s=Math.floor(E/I);for(let E=0;E<s;E++){const s=Math.random()*t.FULL_ROTATION*t.FULL_CIRCLE,E=Math.random()*t.DEBRIS_CLUSTER_SPREAD,I=i+Math.cos(s*Math.PI/t.ANGLE_180)*E,T=a+Math.sin(s*Math.PI/t.ANGLE_180)*E;if(I<0||I>e||T<0||T>r)continue;const c=_[Math.floor(Math.random()*_.length)],h=n+Math.random()*(A-n),l=Math.random()*t.DEBRIS_ROTATION_MAX,u=t.DEBRIS_OPACITY_MIN+Math.random()*(t.DEBRIS_OPACITY_MAX-t.DEBRIS_OPACITY_MIN),d=this.createDebrisPiece(I,T,h,c,l,u);o.appendChild(d)}}return o}createDebrisPiece(e,r,i,a,s,n){const A=this.createGroup({transform:`translate(${e}, ${r}) rotate(${s})`,id:this.generateId(`debris_${a}`)});let _;const o="#666666",E="#999999";switch(a){case"hull_fragment":_=this.createPath(`M ${-i} ${-i*t.RATIO_SIZE_SMALL} L ${i*t.RATIO_SIZE_LARGE} ${-i} L ${i} ${i*t.RATIO_SIZE_SMALL} L ${-i*t.RATIO_SIZE_SMALL} ${i} Z`,{fill:o,stroke:E,"stroke-width":t.RATIO_SIZE_SMALL,opacity:n});break;case"engine_part":_=this.createGroup();const e=this.createRect(-i*t.RATIO_SIZE_SMALL,-i,i,i*t.FULL_CIRCLE,{fill:"#444444",stroke:"#777777","stroke-width":1,opacity:n}),r=this.createPath(`M ${-i*t.RATIO_SIZE_MID} ${i} L ${i*t.RATIO_SIZE_MID} ${i} L ${i*t.RATIO_SIZE_LARGE} ${i*t.GLOW_INTENSITY} L ${-i*t.RATIO_SIZE_LARGE} ${i*t.GLOW_INTENSITY} Z`,{fill:"#222222",stroke:"#555555","stroke-width":1,opacity:n});_.appendChild(e),_.appendChild(r);break;case"solar_panel":_=this.createGroup();const a=this.createRect(-i,-i*t.RATIO_SIZE_SMALL,i*t.FULL_CIRCLE,i,{fill:"#1a1a3a",stroke:"#4444aa","stroke-width":1,opacity:n});for(let e=0;e<t.COUNT_MEDIUM;e++){const r=this.createLine(-i+e*i*t.RATIO_SIZE_SMALL,-i*t.RATIO_SIZE_SMALL,-i+e*i*t.RATIO_SIZE_SMALL,i*t.RATIO_SIZE_LARGE,{stroke:"#333366","stroke-width":.5,opacity:n*t.RATIO_OPACITY_MID});_.appendChild(r)}_.appendChild(a);break;case"antenna":_=this.createGroup();const s=this.createCircle(0,0,i*t.RATIO_SIZE_SMALL,{fill:o,stroke:E,"stroke-width":1,opacity:n}),A=this.createLine(0,0,0,-i*t.FULL_CIRCLE,{stroke:"#888888","stroke-width":t.FULL_CIRCLE,opacity:n}),I=this.createCircle(0,-i*t.FULL_CIRCLE,i*t.RATIO_SIZE_SMALL*t.RATIO_SIZE_SMALL,{fill:"#ff4444",opacity:n});_.appendChild(A),_.appendChild(s),_.appendChild(I);break;case"fuel_tank":_=this.createGroup();const T=this.createElement("ellipse");T.setAttribute("cx",0),T.setAttribute("cy",0),T.setAttribute("rx",i),T.setAttribute("ry",i*t.RATIO_SIZE_MID),T.setAttribute("fill","#333333"),T.setAttribute("stroke","#666666"),T.setAttribute("stroke-width","1"),T.setAttribute("opacity",n);const c=this.createElement("ellipse");c.setAttribute("cx",0),c.setAttribute("cy",0),c.setAttribute("rx",i*t.RATIO_OPACITY_HIGH),c.setAttribute("ry",i*t.RATIO_SIZE_MID*t.RATIO_OPACITY_HIGH),c.setAttribute("fill","none"),c.setAttribute("stroke","#888888"),c.setAttribute("stroke-width","0.5"),c.setAttribute("opacity",n),_.appendChild(T),_.appendChild(c);break;default:_=this.createPath(`M ${-i} 0 L ${-i*t.RATIO_SIZE_SMALL} ${-i} L ${i*t.RATIO_SIZE_MID} ${-i*t.RATIO_SIZE_SMALL} L ${i} ${i*t.RATIO_SIZE_SMALL} L 0 ${i} Z`,{fill:o,stroke:E,"stroke-width":1,opacity:n})}if(A.appendChild(_),Math.random()<t.DEBRIS_DRIFT_CHANCE){const e=this.createElement("animateTransform");e.setAttribute("attributeName","transform"),e.setAttribute("type","rotate"),e.setAttribute("values",`${s};${s+t.ANGLE_90};${s}`),e.setAttribute("dur",`${t.DEBRIS_DRIFT_DURATION_MIN+Math.random()*(t.DEBRIS_DRIFT_DURATION_MAX-t.DEBRIS_DRIFT_DURATION_MIN)}s`),e.setAttribute("repeatCount","indefinite"),e.setAttribute("begin",Math.random()*t.COUNT_LARGE+"s"),A.appendChild(e)}return A}createElement(t){return document.createElementNS("http://www.w3.org/2000/svg",t)}generateId(t="element"){return`${t}_${++this.idCounter}`}setAttributes(t,e){return Object.entries(e).forEach(([e,r])=>{t.setAttribute(e,r)}),t}createLayer(t,e=0){const r=this.createElement("g");return r.setAttribute("id",`layer_${t}`),r.setAttribute("data-layer",t),r.style.zIndex=e,this.layers.set(t,r),this.svg.appendChild(r),r}getLayer(t){return this.layers.has(t)?this.layers.get(t):this.createLayer(t)}createCircle(t,e,r,i={}){if("number"!=typeof t||!isFinite(t))throw new Error("GraphicsEngine.createCircle: cx must be a finite number");if("number"!=typeof e||!isFinite(e))throw new Error("GraphicsEngine.createCircle: cy must be a finite number");if("number"!=typeof r||!isFinite(r)||r<0)throw new Error("GraphicsEngine.createCircle: r must be a non-negative finite number");if("object"!=typeof i||null===i)throw new Error("GraphicsEngine.createCircle: attributes must be an object");const a=this.createElement("circle");return a.setAttribute("cx",t),a.setAttribute("cy",e),a.setAttribute("r",r),this.setAttributes(a,i)}createRect(t,e,r,i,a={}){if("number"!=typeof t||!isFinite(t))throw new Error("GraphicsEngine.createRect: x must be a finite number");if("number"!=typeof e||!isFinite(e))throw new Error("GraphicsEngine.createRect: y must be a finite number");if("number"!=typeof r||!isFinite(r)||r<0)throw new Error("GraphicsEngine.createRect: width must be a non-negative finite number");if("number"!=typeof i||!isFinite(i)||i<0)throw new Error("GraphicsEngine.createRect: height must be a non-negative finite number");if("object"!=typeof a||null===a)throw new Error("GraphicsEngine.createRect: attributes must be an object");const s=this.createElement("rect");return s.setAttribute("x",t),s.setAttribute("y",e),s.setAttribute("width",r),s.setAttribute("height",i),this.setAttributes(s,a)}createLine(t,e,r,i,a={}){if("number"!=typeof t||!Number.isFinite(t))throw new Error("Invalid x1 parameter: must be a finite number");if("number"!=typeof e||!Number.isFinite(e))throw new Error("Invalid y1 parameter: must be a finite number");if("number"!=typeof r||!Number.isFinite(r))throw new Error("Invalid x2 parameter: must be a finite number");if("number"!=typeof i||!Number.isFinite(i))throw new Error("Invalid y2 parameter: must be a finite number");if(null!==a&&("object"!=typeof a||Array.isArray(a)))throw new Error("Invalid attributes parameter: must be an object");const s=this.createElement("line");return s.setAttribute("x1",t.toString()),s.setAttribute("y1",e.toString()),s.setAttribute("x2",r.toString()),s.setAttribute("y2",i.toString()),this.setAttributes(s,a)}createPath(t,e={}){if("string"!=typeof t||""===t.trim())throw new Error("Invalid d parameter: must be a non-empty string");if(null!==e&&("object"!=typeof e||Array.isArray(e)))throw new Error("Invalid attributes parameter: must be an object");const r=this.createElement("path");return r.setAttribute("d",t),this.setAttributes(r,e)}createGroup(t={}){const e=this.createElement("g");return this.setAttributes(e,t)}createText(t,e=0,r=0,i={}){if("string"!=typeof t)throw new Error("GraphicsEngine.createText: content must be a string");if("number"!=typeof e||!isFinite(e))throw new Error("GraphicsEngine.createText: x must be a finite number");if("number"!=typeof r||!isFinite(r))throw new Error("GraphicsEngine.createText: y must be a finite number");if("object"!=typeof i||null===i)throw new Error("GraphicsEngine.createText: attributes must be an object");const a=this.createElement("text");return a.setAttribute("x",e),a.setAttribute("y",r),a.textContent=t,this.setAttributes(a,i)}createGradient(t,e,r={}){const i=this.generateId("gradient"),a=this.createElement("radial"===t?"radialGradient":"linearGradient");return a.setAttribute("id",i),this.setAttributes(a,r),e.forEach(t=>{const e=this.createElement("stop");e.setAttribute("offset",t.offset),e.setAttribute("stop-color",t.color),void 0!==t.opacity&&e.setAttribute("stop-opacity",t.opacity),a.appendChild(e)}),this.defs.appendChild(a),i}createStarField(e,r={width:t.DEFAULT_CANVAS_WIDTH,height:t.DEFAULT_CANVAS_HEIGHT},i={}){if("number"!=typeof e||!isFinite(e)||e<0)throw new Error("GraphicsEngine.createStarField: count must be a non-negative finite number");if("object"!=typeof r||null===r)throw new Error("GraphicsEngine.createStarField: bounds must be an object");if("number"!=typeof r.width||!isFinite(r.width)||r.width<=0)throw new Error("GraphicsEngine.createStarField: bounds.width must be a positive finite number");if("number"!=typeof r.height||!isFinite(r.height)||r.height<=0)throw new Error("GraphicsEngine.createStarField: bounds.height must be a positive finite number");const{includeNebulae:a=!0,nebulaTypes:s=["purple","blue","red"]}=i,n=this.createGroup({id:"starField"});if(a&&Math.random()<t.NEBULA_CHANCE){const t=this.createNebulaBackground(r.width,r.height,s);n.appendChild(t)}for(let i=0;i<e;i++){const e=Math.random()*r.width,i=Math.random()*r.height,a=this.selectStarType(),s=t.STAR_TYPES[a],A=Math.random()*(t.STAR_SIZE_MAX-t.STAR_SIZE_MIN)+t.STAR_SIZE_MIN,_=A*s.sizeMultiplier,o=this.createStar(e,i,_,s.color,a);if(n.appendChild(o),Math.random()<t.STAR_BINARY_CHANCE){const r=this.selectStarType(),a=t.STAR_TYPES[r],s=A*t.STAR_COMPANION_SIZE_RATIO*a.sizeMultiplier,_=Math.random()*Math.PI*t.FULL_CIRCLE,o=e+Math.cos(_)*t.STAR_BINARY_SEPARATION,E=i+Math.sin(_)*t.STAR_BINARY_SEPARATION,I=this.createStar(o,E,s,a.color,r);n.appendChild(I)}}return n}selectStarType(){const e=Math.random()*t.STAR_CUMULATIVE_RARITY;let r=0;for(const[i,a]of Object.entries(t.STAR_TYPES))if(r+=a.rarity,e<=r)return i;return"M"}createStar(e,r,i,a,s){const n=Math.random()*(t.STAR_OPACITY_MAX-t.STAR_OPACITY_MIN)+t.STAR_OPACITY_MIN,A=this.createGroup({transform:`translate(${e}, ${r})`}),_=this.createCircle(0,0,i,{fill:a,opacity:n,"data-star-type":s});if(i>t.MATH_PI_MULTIPLIER||"O"===s||"B"===s){const e=this.createCircle(0,0,i*t.RATIO_BINARY_SEPARATION,{fill:a,opacity:n*t.RATIO_SIZE_SMALL,filter:"blur(1px)"});A.appendChild(e)}return A.appendChild(_),Math.random()<t.STAR_TWINKLE_CHANCE&&this.addTwinkleAnimation(_),A}addTwinkleAnimation(e){const r=this.createElement("animate");r.setAttribute("attributeName","opacity"),r.setAttribute("values",`${e.getAttribute("opacity")};${parseFloat(e.getAttribute("opacity"))*(1-t.STAR_TWINKLE_INTENSITY)};${e.getAttribute("opacity")}`),r.setAttribute("dur",`${t.STAR_TWINKLE_MIN_DURATION+Math.random()*t.STAR_TWINKLE_MAX_DURATION}s`),r.setAttribute("repeatCount","indefinite"),e.appendChild(r)}createAsteroidField(e,r={width:t.DEFAULT_CANVAS_WIDTH,height:t.DEFAULT_CANVAS_HEIGHT}){const i=this.createGroup({id:"asteroidField"});for(let a=0;a<e;a++){const e=Math.random()*r.width,a=Math.random()*r.height,s=Math.random()*t.ASTEROID_SIZE_RANGE+t.ASTEROID_SIZE_MIN,n=this.createAsteroid(e,a,s);i.appendChild(n)}return i}createAsteroid(e,r,i,a={}){if("number"!=typeof e||!isFinite(e))throw new Error("GraphicsEngine.createAsteroid: x must be a finite number");if("number"!=typeof r||!isFinite(r))throw new Error("GraphicsEngine.createAsteroid: y must be a finite number");if("number"!=typeof i||!isFinite(i)||i<=0)throw new Error("GraphicsEngine.createAsteroid: size must be a positive finite number");if("object"!=typeof a||null===a)throw new Error("GraphicsEngine.createAsteroid: attributes must be an object");const s=this.createGroup({transform:`translate(${e}, ${r})`,...a}),n=t.ASTEROID_VERTICES+Math.floor(Math.random()*t.ASTEROID_VERTEX_VARIANCE);let A="";for(let e=0;e<n;e++){const r=e/n*t.PI_TIMES_2,a=i*(t.ASTEROID_RADIUS_MIN+Math.random()*t.ASTEROID_RADIUS_MAX),s=Math.cos(r)*a,_=Math.sin(r)*a;A+=0===e?`M ${s} ${_}`:` L ${s} ${_}`}A+=" Z";const _=this.createPath(A,{fill:"#8b7355",stroke:"#654321","stroke-width":t.ASTEROID_STROKE_WIDTH,opacity:t.ASTEROID_OPACITY}),o=this.createPath(A,{fill:"none",stroke:"#a0926b","stroke-width":t.ASTEROID_HIGHLIGHT_WIDTH,opacity:t.ASTEROID_HIGHLIGHT_OPACITY,transform:`translate(-${i*t.ASTEROID_HIGHLIGHT_OFFSET}, -${i*t.ASTEROID_HIGHLIGHT_OFFSET})`});return s.appendChild(_),s.appendChild(o),s}createSpaceship(e,r,i=t.SPACESHIP_DEFAULT_SIZE,a={}){if("number"!=typeof e||!isFinite(e))throw new Error("GraphicsEngine.createSpaceship: x must be a finite number");if("number"!=typeof r||!isFinite(r))throw new Error("GraphicsEngine.createSpaceship: y must be a finite number");if("number"!=typeof i||!isFinite(i)||i<=0)throw new Error("GraphicsEngine.createSpaceship: size must be a positive finite number");if("object"!=typeof a||null===a)throw new Error("GraphicsEngine.createSpaceship: attributes must be an object");const s=this.createGroup({transform:`translate(${e}, ${r})`,...a}),n=this.createPath(`M 0 -${i} L ${i*t.SPACESHIP_HULL_WING_RATIO} ${i} L 0 ${i*t.SPACESHIP_HULL_BODY_RATIO} L -${i*t.SPACESHIP_HULL_WING_RATIO} ${i} Z`,{fill:"#4a90e2",stroke:"#ffffff","stroke-width":t.SPACESHIP_STROKE_WIDTH}),A=this.createCircle(0,i*t.SPACESHIP_ENGINE_RATIO,i*t.SPACESHIP_ENGINE_SIZE_RATIO,{fill:"#ff4444",opacity:.8}),_=this.createGroup({id:"mainThruster",opacity:0}),o=this.createPath(`M -${i*t.SPACESHIP_THRUSTER_MAIN_WIDTH} ${i*t.SPACESHIP_THRUSTER_OPACITY} L 0 ${i*t.SPACESHIP_THRUSTER_MAIN_HEIGHT} L ${i*t.SPACESHIP_THRUSTER_MAIN_WIDTH} ${i*t.SPACESHIP_THRUSTER_OPACITY} Z`,{fill:"#ff6600",opacity:t.SPACESHIP_THRUSTER_FLAME_OPACITY}),E=this.createPath(`M -${i*t.SPACESHIP_THRUSTER_CORE_WIDTH} ${i*t.SPACESHIP_THRUSTER_INNER_OPACITY} L 0 ${i*t.SPACESHIP_THRUSTER_CORE_HEIGHT} L ${i*t.SPACESHIP_THRUSTER_CORE_WIDTH} ${i*t.SPACESHIP_THRUSTER_INNER_OPACITY} Z`,{fill:"#ffaa00",opacity:t.SPACESHIP_THRUSTER_INNER_OPACITY}),I=this.createPath(`M -${Number(i)*t.SPACESHIP_THRUSTER_INNER_WIDTH} ${Number(i)*t.SPACESHIP_THRUSTER_CORE_HEIGHT_OFFSET} L 0 ${Number(i)*t.SPACESHIP_THRUSTER_INNER_HEIGHT} L ${Number(i)*t.SPACESHIP_THRUSTER_INNER_WIDTH} ${Number(i)*t.SPACESHIP_THRUSTER_CORE_HEIGHT_OFFSET} Z`,{fill:"#ffffff",opacity:t.SPACESHIP_THRUSTER_FLAME_OPACITY});_.appendChild(o),_.appendChild(E),_.appendChild(I);const T=this.createGroup({id:"leftThruster",opacity:0}),c=this.createPath(`M -${i*t.SPACESHIP_THRUSTER_SIDE_WIDTH} -${i*t.SPACESHIP_THRUSTER_SIDE_HEIGHT} L -${i*t.SPACESHIP_THRUSTER_SIDE_LENGTH} 0 L -${i*t.SPACESHIP_THRUSTER_SIDE_WIDTH} ${i*t.SPACESHIP_THRUSTER_SIDE_HEIGHT} Z`,{fill:"#0088ff",opacity:t.SPACESHIP_THRUSTER_SIDE_OPACITY});T.appendChild(c);const h=this.createGroup({id:"rightThruster",opacity:0}),l=this.createPath(`M ${i*t.SPACESHIP_THRUSTER_SIDE_WIDTH} -${i*t.SPACESHIP_THRUSTER_SIDE_HEIGHT} L ${i*t.SPACESHIP_THRUSTER_SIDE_LENGTH} 0 L ${i*t.SPACESHIP_THRUSTER_SIDE_WIDTH} ${i*t.SPACESHIP_THRUSTER_SIDE_HEIGHT} Z`,{fill:"#0088ff",opacity:t.SPACESHIP_THRUSTER_SIDE_OPACITY});return h.appendChild(l),s.appendChild(n),s.appendChild(A),s.appendChild(_),s.appendChild(T),s.appendChild(h),s}createOtherPlayerShip(e,r,i,a="#ff6b35",s=t.PLAYER_SHIP_DEFAULT_SIZE){if("number"!=typeof e||!isFinite(e))throw new Error("GraphicsEngine.createOtherPlayerShip: x must be a finite number");if("number"!=typeof r||!isFinite(r))throw new Error("GraphicsEngine.createOtherPlayerShip: y must be a finite number");if("string"!=typeof i||0===i.length)throw new Error("GraphicsEngine.createOtherPlayerShip: playerId must be a non-empty string");if("number"!=typeof s||!isFinite(s)||s<=0)throw new Error("GraphicsEngine.createOtherPlayerShip: size must be a positive finite number");if("string"!=typeof a||0===a.length)throw new Error("GraphicsEngine.createOtherPlayerShip: playerColor must be a non-empty string");const n=this.createGroup({id:`otherPlayer_${i}`,transform:`translate(${e}, ${r})`}),A=this.createPath(`M 0 -${s} L ${s*t.SPACESHIP_HULL_WING_RATIO} ${s} L 0 ${s*t.SPACESHIP_HULL_BODY_RATIO} L -${s*t.SPACESHIP_HULL_WING_RATIO} ${s} Z`,{fill:a,stroke:"#ffffff","stroke-width":t.SPACESHIP_STROKE_WIDTH,opacity:.8}),_=this.createCircle(0,s*t.SPACESHIP_ENGINE_RATIO,s*t.SPACESHIP_ENGINE_SIZE_RATIO,{fill:"#00ff88",opacity:.6}),o=this.createText(i,0,-s-t.PLAYER_NAME_LABEL_OFFSET,{"text-anchor":"middle",fill:"#ffffff","font-family":"monospace","font-size":"12px","font-weight":"bold","text-shadow":"0 0 2px #000000"});return n.appendChild(A),n.appendChild(_),n.appendChild(o),n}updateSpaceshipThrusters(e,r,i=!1){const a=e.querySelector("#mainThruster"),s=e.querySelector("#leftThruster"),n=e.querySelector("#rightThruster");if(!a||!s||!n)return;const A=i?t.SPACESHIP_THRUSTER_BOOST_OPACITY:t.SPACESHIP_THRUSTER_BASE_OPACITY,_=t.SPACESHIP_THRUSTER_FADE_SPEED;if(r.y>0)a.setAttribute("opacity",A);else{const t=parseFloat(a.getAttribute("opacity"))||0,e=Math.max(0,t-_);a.setAttribute("opacity",e)}if(r.x>0)s.setAttribute("opacity",A*t.SPACESHIP_THRUSTER_SIDE_OPACITY);else{const t=parseFloat(s.getAttribute("opacity"))||0,e=Math.max(0,t-_);s.setAttribute("opacity",e)}if(r.x<0)n.setAttribute("opacity",A*t.SPACESHIP_THRUSTER_SIDE_OPACITY);else{const t=parseFloat(n.getAttribute("opacity"))||0,e=Math.max(0,t-_);n.setAttribute("opacity",e)}}createPlanet(e,r,i,a={}){const s=this.createGroup({transform:`translate(${e}, ${r})`,...a}),n=a.surfaceColor||"#8b4513",A=a.coreColor||"#654321",_=a.atmosphereColor||"#4444ff",o=this.createGradient("radial",[{offset:"0%",color:n},{offset:"70%",color:A},{offset:"100%",color:"#2c1810"}],{cx:"30%",cy:"30%"}),E=this.createCircle(0,0,i,{fill:`url(#${o})`,stroke:_,"stroke-width":2,opacity:t.RATIO_OPACITY_HIGH});return s.appendChild(E),this.addPlanetCraters(s,i,n),this.addPlanetContinents(s,i,n),this.addPlanetAtmosphere(s,i,_),s}addPlanetCraters(e,r,i){const a=t.PLANET_CRATER_MIN+Math.floor(Math.random()*t.PLANET_CRATER_MAX);for(let s=0;s<a;s++){const a=Math.random()*Math.PI*t.FULL_CIRCLE,s=Math.random()*r*t.PLANET_CRATER_DISTANCE_MAX,n=Math.cos(a)*s,A=Math.sin(a)*s,_=Math.random()*r*t.PLANET_CRATER_SIZE_MAX+r*t.PLANET_CRATER_SIZE_MIN,o=this.createCircle(n,A,_,{fill:this.darkenColor(i,t.PLANET_DARKEN_FACTOR),opacity:.8}),E=this.createCircle(n,A,_*t.PLANET_CRATER_RIM_RATIO,{fill:"none",stroke:this.lightenColor(i,t.PLANET_LIGHTEN_FACTOR),"stroke-width":1,opacity:.6});e.appendChild(o),e.appendChild(E)}}addPlanetContinents(e,r,i){const a=t.PLANET_CONTINENT_MIN+Math.floor(Math.random()*t.PLANET_CONTINENT_MAX);for(let s=0;s<a;s++){const a=Math.random()*Math.PI*t.FULL_CIRCLE,s=Math.random()*r*t.PLANET_CONTINENT_DISTANCE_MAX,n=Math.cos(a)*s,A=Math.sin(a)*s,_=t.PLANET_CONTINENT_POINTS_MIN+Math.floor(Math.random()*t.PLANET_CONTINENT_POINTS_MAX);let o="";for(let e=0;e<_;e++){const i=e/_*t.PI_TIMES_2,a=r*(t.PLANET_CONTINENT_RADIUS_MIN+Math.random()*t.PLANET_CONTINENT_RADIUS_MAX),s=n+Math.cos(i)*a,E=A+Math.sin(i)*a;o+=0===e?`M ${s} ${E}`:` L ${s} ${E}`}o+=" Z";const E=this.createPath(o,{fill:this.lightenColor(i,t.PLANET_LIGHTEN_FACTOR),opacity:t.PLANET_CONTINENT_OPACITY,"clip-path":`circle(${r}px at 0px 0px)`});e.appendChild(E)}}addPlanetAtmosphere(e,r,i){const a=this.createGradient("radial",[{offset:"85%",color:i,opacity:0},{offset:"100%",color:i,opacity:.3}],{cx:"50%",cy:"50%"}),s=this.createCircle(0,0,r*t.GLOW_INTENSITY,{fill:`url(#${a})`,opacity:.6});e.appendChild(s)}darkenColor(e,r){if(e.startsWith("#")){const i=e.slice(1);return`rgb(${Math.floor(parseInt(i.slice(t.HEX_RED_START,t.HEX_RED_END),16)*(1-r))}, ${Math.floor(parseInt(i.slice(t.HEX_GREEN_START,t.HEX_GREEN_END),16)*(1-r))}, ${Math.floor(parseInt(i.slice(t.HEX_BLUE_START,t.HEX_BLUE_END),16)*(1-r))})`}return e}lightenColor(e,r){if(e.startsWith("#")){const i=e.slice(1);return`rgb(${Math.min(t.COLOR_MAX,Math.floor(parseInt(i.slice(t.HEX_RED_START,t.HEX_RED_END),16)*(1+r)))}, ${Math.min(t.COLOR_MAX,Math.floor(parseInt(i.slice(t.HEX_GREEN_START,t.HEX_GREEN_END),16)*(1+r)))}, ${Math.min(t.COLOR_MAX,Math.floor(parseInt(i.slice(t.HEX_BLUE_START,t.HEX_BLUE_END),16)*(1+r)))})`}return e}createSpaceStation(e,r,i=t.STATION_DEFAULT_SIZE,a={}){const s=this.createGroup({transform:`translate(${e}, ${r})`,...a}),n=this.createCircle(0,0,i*t.STATION_HUB_RATIO,{fill:"#666666",stroke:"#aaaaaa","stroke-width":2}),A=this.createCircle(0,0,i*t.STATION_RING_RATIO,{fill:"none",stroke:"#888888","stroke-width":i*t.STATION_RING_WIDTH,opacity:t.STATION_RING_OPACITY});for(let e=0;e<t.STATION_DOCKING_PORTS;e++){const r=e*t.ANGLE_90*Math.PI/t.ANGLE_180,a=Math.cos(r)*i,n=Math.sin(r)*i,A=this.createRect(a-i*t.STATION_PORT_WIDTH,n-i*t.STATION_PORT_HEIGHT,i*t.STATION_PORT_LENGTH,i*t.STATION_PORT_WIDTH,{fill:"#4a90e2",stroke:"#ffffff","stroke-width":1,transform:`rotate(${e*t.ANGLE_90}, ${a}, ${n})`});s.appendChild(A)}for(let e=0;e<t.STATION_SOLAR_PANELS;e++){const r=e*t.ANGLE_60*Math.PI/t.ANGLE_180,a=Math.cos(r)*i*t.STATION_PANEL_DISTANCE,n=Math.sin(r)*i*t.STATION_PANEL_DISTANCE,A=this.createRect(a-i*t.STATION_PANEL_WIDTH,n-i*t.STATION_PANEL_HEIGHT,i*t.STATION_PANEL_LENGTH,i*t.STATION_PANEL_WIDTH,{fill:"#1a1a3a",stroke:"#4444ff","stroke-width":1,opacity:t.STATION_PANEL_OPACITY,transform:`rotate(${e*t.ANGLE_60}, ${a}, ${n})`});s.appendChild(A)}const _=this.createRect(-i*t.STATION_COMM_WIDTH,-i*t.STATION_COMM_HEIGHT,i*t.STATION_COMM_LENGTH,i*t.STATION_COMM_WIDTH_RATIO,{fill:"#cccccc",stroke:"#ffffff","stroke-width":1});s.appendChild(n),s.appendChild(A),s.appendChild(_);const o=this.createCircle(-i*t.STATION_NAV_LIGHT_RATIO,0,i*t.STATION_NAV_LIGHT_SIZE,{fill:"#ff4444",opacity:t.STATION_NAV_LIGHT_OPACITY}),E=this.createCircle(i*t.STATION_NAV_LIGHT_RATIO,0,i*t.STATION_NAV_LIGHT_SIZE,{fill:"#44ff44",opacity:t.STATION_NAV_LIGHT_OPACITY});return s.appendChild(o),s.appendChild(E),s}createJumpGate(e,r,i=t.GATE_DEFAULT_SIZE,a={}){const s=this.createGroup({transform:`translate(${e}, ${r})`,...a}),n=this.createCircle(0,0,i,{fill:"none",stroke:"#00ffff","stroke-width":i*t.GATE_OUTER_STROKE_RATIO,opacity:t.GATE_OUTER_OPACITY,"stroke-dasharray":`${i*t.GATE_DASH_ARRAY_LONG} ${i*t.GATE_DASH_ARRAY_SHORT}`}),A=this.createCircle(0,0,i*t.GATE_INNER_RATIO,{fill:"none",stroke:"#ffffff","stroke-width":i*t.GATE_INNER_STROKE_RATIO,opacity:t.GATE_INNER_OPACITY}),_=this.createCircle(0,0,i*t.GATE_CORE_RATIO,{fill:"#00ffff",opacity:t.GATE_CORE_OPACITY,"fill-rule":"evenodd"});for(let e=0;e<t.GATE_STRUT_COUNT;e++){const r=e*t.ANGLE_90*Math.PI/t.ANGLE_180,a=Math.cos(r)*i*t.GATE_STRUT_INNER_RATIO,n=Math.sin(r)*i*t.GATE_STRUT_INNER_RATIO,A=Math.cos(r)*i*t.GATE_STRUT_OUTER_RATIO,_=Math.sin(r)*i*t.GATE_STRUT_OUTER_RATIO,o=this.createElement("line");o.setAttribute("x1",a),o.setAttribute("y1",n),o.setAttribute("x2",A),o.setAttribute("y2",_),o.setAttribute("stroke","#aaaaaa"),o.setAttribute("stroke-width",i*t.GATE_STRUT_WIDTH),s.appendChild(o)}const o=this.createGroup({id:`particles_${this.generateId("gate")}`});for(let e=0;e<t.GATE_PARTICLES;e++){const r=e*t.ANGLE_45*Math.PI/t.ANGLE_180,a=Math.cos(r)*i*t.GATE_PARTICLE_DISTANCE,s=Math.sin(r)*i*t.GATE_PARTICLE_DISTANCE,n=this.createCircle(a,s,i*t.GATE_PARTICLE_SIZE,{fill:"#00ffff",opacity:t.GATE_PARTICLE_OPACITY});o.appendChild(n)}const E=this.createElement("animateTransform");E.setAttribute("attributeName","transform"),E.setAttribute("type","rotate"),E.setAttribute("values","0 0 0;360 0 0"),E.setAttribute("dur",t.GATE_ANIMATION_DURATION_ROTATE),E.setAttribute("repeatCount","indefinite"),o.appendChild(E),s.appendChild(o),s.appendChild(_),s.appendChild(A),s.appendChild(n);const I=this.createElement("animate");I.setAttribute("attributeName","opacity"),I.setAttribute("values",`${t.GATE_PULSE_MIN};${t.GATE_PULSE_MAX};${t.GATE_PULSE_MIN}`),I.setAttribute("dur",t.GATE_ANIMATION_DURATION_PULSE),I.setAttribute("repeatCount","indefinite"),n.appendChild(I);const T=this.createElement("animate");return T.setAttribute("attributeName","opacity"),T.setAttribute("values",`${t.GATE_CORE_PULSE_MIN};${t.GATE_CORE_PULSE_MAX};${t.GATE_CORE_PULSE_MIN}`),T.setAttribute("dur",t.GATE_ANIMATION_DURATION_CORE),T.setAttribute("repeatCount","indefinite"),_.appendChild(T),s}addToLayer(t,e){return this.getLayer(t).appendChild(e),e}clear(){this.svg.innerHTML="",this.layers.clear(),this.defs=this.createDefs(),this.idCounter=0}remove(t){t.parentNode&&t.parentNode.removeChild(t)}createLaserBeam(e,r,i,a,s={}){const n=this.createGroup({id:this.generateId("laser"),...s}),A=this.createElement("line");A.setAttribute("x1",e),A.setAttribute("y1",r),A.setAttribute("x2",i),A.setAttribute("y2",a),A.setAttribute("stroke",s.color||"#ff0000"),A.setAttribute("stroke-width",s.width||t.LASER_DEFAULT_WIDTH),A.setAttribute("opacity",t.LASER_BEAM_OPACITY),A.setAttribute("stroke-linecap","round");const _=this.createElement("line");_.setAttribute("x1",e),_.setAttribute("y1",r),_.setAttribute("x2",i),_.setAttribute("y2",a),_.setAttribute("stroke",s.glowColor||"#ffaaaa"),_.setAttribute("stroke-width",(s.width||t.LASER_DEFAULT_WIDTH)*t.LASER_GLOW_MULTIPLIER),_.setAttribute("opacity",t.LASER_GLOW_OPACITY),_.setAttribute("stroke-linecap","round");const o=this.createElement("line");o.setAttribute("x1",e),o.setAttribute("y1",r),o.setAttribute("x2",i),o.setAttribute("y2",a),o.setAttribute("stroke","#ffffff"),o.setAttribute("stroke-width",1),o.setAttribute("opacity",t.LASER_CORE_OPACITY),o.setAttribute("stroke-linecap","round"),n.appendChild(_),n.appendChild(A),n.appendChild(o);const E=this.createElement("animate");return E.setAttribute("attributeName","opacity"),E.setAttribute("values","0;1;1;0"),E.setAttribute("dur",s.duration||"0.3s"),E.setAttribute("fill","freeze"),n.appendChild(E),setTimeout(()=>{this.remove(n)},parseFloat(s.duration||t.LASER_DEFAULT_DURATION)*t.SECONDS_TO_MS+t.LASER_CLEANUP_DELAY),n}createLaserImpact(e,r,i={}){const a=this.createGroup({id:this.generateId("impact"),transform:`translate(${e}, ${r})`}),s=this.createCircle(0,0,i.size||t.IMPACT_DEFAULT_SIZE,{fill:i.color||"#ffff00",opacity:t.RATIO_OPACITY_HIGH}),n=this.createCircle(0,0,(i.size||t.IMPACT_DEFAULT_SIZE)*t.IMPACT_RING_MULTIPLIER,{fill:"none",stroke:i.ringColor||"#ff8800","stroke-width":2,opacity:.7});for(let e=0;e<t.IMPACT_SPARKS;e++){const r=e*t.ANGLE_60*Math.PI/t.ANGLE_180,s=(i.size||t.IMPACT_DEFAULT_SIZE)*t.IMPACT_SPARK_DISTANCE,n=Math.cos(r)*s,A=Math.sin(r)*s,_=this.createElement("line");_.setAttribute("x1",0),_.setAttribute("y1",0),_.setAttribute("x2",n),_.setAttribute("y2",A),_.setAttribute("stroke","#ffffff"),_.setAttribute("stroke-width",1),_.setAttribute("opacity",t.IMPACT_SPARK_OPACITY),_.setAttribute("stroke-linecap","round"),a.appendChild(_)}a.appendChild(n),a.appendChild(s);const A=this.createElement("animateTransform");A.setAttribute("attributeName","transform"),A.setAttribute("type","scale"),A.setAttribute("values","0 0;1.5 1.5;0.5 0.5"),A.setAttribute("dur",i.duration||"0.4s"),A.setAttribute("fill","freeze"),A.setAttribute("additive","sum");const _=this.createElement("animate");return _.setAttribute("attributeName","opacity"),_.setAttribute("values","0;1;0"),_.setAttribute("dur",i.duration||"0.4s"),_.setAttribute("fill","freeze"),a.appendChild(A),a.appendChild(_),setTimeout(()=>{this.remove(a)},parseFloat(i.duration||t.IMPACT_DEFAULT_DURATION)*t.SECONDS_TO_MS+t.IMPACT_CLEANUP_DELAY),a}createWeaponChargeIndicator(t,r,i,a={}){const{maxRadius:s=e.CHARGE_INDICATOR_MAX_RADIUS,color:n="#00aaff",glowColor:A="#4488ff",id:_=this.generateId("weapon-charge")}=a,o=this.createGroup({id:_,transform:`translate(${t}, ${r})`}),E=Math.max(e.CHARGE_INDICATOR_MIN_RADIUS,s*i),I=Math.max(e.CHARGE_INDICATOR_MIN_OPACITY,i),T=this.createCircle(0,0,E+e.CHARGE_INDICATOR_GLOW_OFFSET,{fill:"none",stroke:A,"stroke-width":2,opacity:I*e.CHARGE_INDICATOR_GLOW_OPACITY,filter:"blur(2px)"}),c=this.createCircle(0,0,E,{fill:"none",stroke:n,"stroke-width":1.5,opacity:I,"stroke-dasharray":i<e.CHARGE_INDICATOR_DASH_THRESHOLD?"2,4":"none"});if(i>e.CHARGE_CORE_THRESHOLD){const t=this.createCircle(0,0,e.CHARGE_INDICATOR_MIN_RADIUS,{fill:"#ffffff",opacity:(i-e.CHARGE_CORE_THRESHOLD)/e.CHARGE_CORE_OPACITY_DIVISOR});o.appendChild(t)}if(i>e.CHARGE_PULSE_THRESHOLD){const t=this.createCircle(0,0,E,{fill:"none",stroke:"#ffffff","stroke-width":.5,opacity:0}),e=this.createElement("animate");e.setAttribute("attributeName","opacity"),e.setAttribute("values","0;0.8;0"),e.setAttribute("dur","1.5s"),e.setAttribute("repeatCount","indefinite"),t.appendChild(e),o.appendChild(t)}return o.appendChild(T),o.appendChild(c),o}updateWeaponChargeIndicator(t,r){if(!t)return;const i=e.CHARGE_INDICATOR_MAX_RADIUS,a=Math.max(e.CHARGE_INDICATOR_MIN_RADIUS,i*r),s=Math.max(e.CHARGE_INDICATOR_MIN_OPACITY,r),n=t.firstElementChild;n&&(n.setAttribute("r",a+e.CHARGE_INDICATOR_GLOW_OFFSET),n.setAttribute("opacity",s*e.CHARGE_INDICATOR_GLOW_OPACITY));const A=t.children[1];A&&(A.setAttribute("r",a),A.setAttribute("opacity",s),A.setAttribute("stroke-dasharray",r<e.CHARGE_INDICATOR_DASH_THRESHOLD?"2,4":"none"));const _=t.children.length>2&&"circle"===t.children[2].tagName&&"#ffffff"===t.children[2].getAttribute("fill");if(r>e.CHARGE_CORE_THRESHOLD&&!_){const i=this.createCircle(0,0,e.CHARGE_INDICATOR_MIN_RADIUS,{fill:"#ffffff",opacity:(r-e.CHARGE_CORE_THRESHOLD)/e.CHARGE_CORE_OPACITY_DIVISOR});t.appendChild(i)}else r<=e.CHARGE_CORE_THRESHOLD&&_?t.children[2].remove():_&&t.children[2].setAttribute("opacity",(r-e.CHARGE_CORE_THRESHOLD)/e.CHARGE_CORE_OPACITY_DIVISOR)}createProjectile(e,r,i="plasma",a={}){const s=this.createGroup({id:this.generateId("projectile"),transform:`translate(${e}, ${r})`,...a});if("plasma"===i){const e=this.createCircle(0,0,t.PROJECTILE_PLASMA_CORE,{fill:"#00ffff",opacity:t.RATIO_OPACITY_HIGH}),r=this.createCircle(0,0,t.PROJECTILE_PLASMA_GLOW,{fill:"#00aaff",opacity:t.PROJECTILE_PLASMA_GLOW_OPACITY}),i=this.createCircle(0,0,t.PROJECTILE_PLASMA_TRAIL,{fill:"none",stroke:"#0088ff","stroke-width":t.PROJECTILE_PLASMA_TRAIL_WIDTH,opacity:t.PROJECTILE_PLASMA_TRAIL_OPACITY});s.appendChild(i),s.appendChild(r),s.appendChild(e)}else if("missile"===i){const e=this.createPath("M -8 0 L 8 -2 L 10 0 L 8 2 Z",{fill:"#666666",stroke:"#aaaaaa","stroke-width":t.PROJECTILE_MISSILE_STROKE_WIDTH}),r=this.createCircle(t.PROJECTILE_MISSILE_WIDTH,0,t.PROJECTILE_MISSILE_WARHEAD,{fill:"#ff4444",opacity:t.PROJECTILE_MISSILE_WARHEAD_OPACITY}),i=this.createPath("M -8 0 L -15 -1 L -12 0 L -15 1 Z",{fill:"#ff8800",opacity:t.PROJECTILE_MISSILE_EXHAUST_OPACITY});s.appendChild(i),s.appendChild(e),s.appendChild(r)}else if("railgun"===i){const e=this.createRect(-t.PROJECTILE_RAILGUN_WIDTH/2,-t.PROJECTILE_RAILGUN_HEIGHT/2,t.PROJECTILE_RAILGUN_WIDTH,t.PROJECTILE_RAILGUN_HEIGHT,{fill:"#ffff00",opacity:t.RATIO_OPACITY_HIGH}),r=this.createRect(-t.PROJECTILE_RAILGUN_FIELD_WIDTH/2,-t.PROJECTILE_RAILGUN_FIELD_HEIGHT/2,t.PROJECTILE_RAILGUN_FIELD_WIDTH,t.PROJECTILE_RAILGUN_FIELD_HEIGHT,{fill:"none",stroke:"#ffff88","stroke-width":t.PROJECTILE_RAILGUN_FIELD_WIDTH_STROKE,opacity:t.PROJECTILE_RAILGUN_FIELD_OPACITY});s.appendChild(r),s.appendChild(e)}return s}createExplosion(e,r,i=t.EXPLOSION_DEFAULT_SIZE,a={}){const s=this.createGroup({id:this.generateId("explosion"),transform:`translate(${e}, ${r})`}),n=a.colors||["#ff4444","#ff8800","#ffff00","#ffffff"],A=t.EXPLOSION_RINGS;for(let e=0;e<A;e++){const r=this.createCircle(0,0,i*(t.EXPLOSION_RING_BASE+e*t.EXPLOSION_RING_INCREMENT),{fill:"none",stroke:n[e]||n[n.length-1],"stroke-width":i*t.EXPLOSION_STROKE_WIDTH,opacity:t.EXPLOSION_RING_OPACITY_BASE-e*t.EXPLOSION_RING_OPACITY_DECREMENT});s.appendChild(r)}const _=this.createCircle(0,0,i*t.EXPLOSION_FLASH_RATIO,{fill:"#ffffff",opacity:t.EXPLOSION_FLASH_OPACITY});for(let e=0;e<t.EXPLOSION_PARTICLES;e++){const r=e*t.ANGLE_30*Math.PI/t.ANGLE_180,a=i*t.EXPLOSION_PARTICLE_DISTANCE,n=Math.cos(r)*a,A=Math.sin(r)*a,_=this.createCircle(n,A,t.EXPLOSION_PARTICLE_SIZE,{fill:"#ffaa00",opacity:t.EXPLOSION_PARTICLE_OPACITY});s.appendChild(_)}s.appendChild(_);const o=this.createElement("animateTransform");o.setAttribute("attributeName","transform"),o.setAttribute("type","scale"),o.setAttribute("values","0 0;2 2;1 1"),o.setAttribute("dur",a.duration||t.EXPLOSION_DEFAULT_DURATION),o.setAttribute("fill","freeze"),o.setAttribute("additive","sum");const E=this.createElement("animate");return E.setAttribute("attributeName","opacity"),E.setAttribute("values","0;1;0"),E.setAttribute("dur",a.duration||t.EXPLOSION_DEFAULT_DURATION),E.setAttribute("fill","freeze"),s.appendChild(o),s.appendChild(E),setTimeout(()=>{this.remove(s)},parseFloat(a.duration||t.EXPLOSION_DEFAULT_DURATION)*t.SECONDS_TO_MS+t.EXPLOSION_CLEANUP_DELAY),s}createShieldEffect(e,r,i=t.SHIELD_DEFAULT_RADIUS,a={}){const s=this.createGroup({id:this.generateId("shield"),transform:`translate(${e}, ${r})`}),n=a.color||"#00aaff",A=this.createPath(`M ${i} 0 L ${i*t.SHIELD_HEX_RATIO} ${i*t.SHIELD_HEX_RATIO_LONG} L ${-i*t.SHIELD_HEX_RATIO} ${i*t.SHIELD_HEX_RATIO_LONG} \n             L ${-i} 0 L ${-i*t.SHIELD_HEX_RATIO} ${-i*t.SHIELD_HEX_RATIO_LONG} L ${i*t.SHIELD_HEX_RATIO} ${-i*t.SHIELD_HEX_RATIO_LONG} Z`,{fill:"none",stroke:n,"stroke-width":t.SHIELD_STROKE_WIDTH,opacity:t.SHIELD_HEX_OPACITY}),_=this.createCircle(0,0,i*t.SHIELD_FIELD_RATIO,{fill:n,opacity:t.SHIELD_FIELD_OPACITY});for(let e=0;e<t.SHIELD_LINES;e++){const r=e*t.ANGLE_60*Math.PI/t.ANGLE_180,a=Math.cos(r)*i*t.SHIELD_LINE_LENGTH,A=Math.sin(r)*i*t.SHIELD_LINE_LENGTH,_=this.createElement("line");_.setAttribute("x1",0),_.setAttribute("y1",0),_.setAttribute("x2",a),_.setAttribute("y2",A),_.setAttribute("stroke",n),_.setAttribute("stroke-width",t.SHIELD_LINE_WIDTH),_.setAttribute("opacity",t.SHIELD_LINE_OPACITY),s.appendChild(_)}s.appendChild(_),s.appendChild(A);const o=this.createElement("animate");return o.setAttribute("attributeName","opacity"),o.setAttribute("values",`${t.SHIELD_PULSE_MIN};${t.SHIELD_PULSE_MAX};${t.SHIELD_PULSE_MIN}`),o.setAttribute("dur",t.SHIELD_PULSE_DURATION),o.setAttribute("repeatCount","indefinite"),s.appendChild(o),s}animate(e,r,i=t.CLEANUP_DELAY_MS,a="ease-in-out"){const s=this.createElement("animateTransform");return s.setAttribute("attributeName","transform"),s.setAttribute("dur",`${i}ms`),s.setAttribute("fill","freeze"),r.transform&&(s.setAttribute("type",r.transform.type||"translate"),s.setAttribute("values",r.transform.values)),e.appendChild(s),new Promise(t=>{setTimeout(t,i)})}addProximityGlow(t,e="#00ffff"){if(!t)return;t.style.filter="url(#proximityGlow)",t.setAttribute("data-proximity-glow","true");const r=this.createElement("animate");if(r.setAttribute("attributeName","opacity"),r.setAttribute("values","0.4;0.8;0.4"),r.setAttribute("dur","1.5s"),r.setAttribute("repeatCount","indefinite"),r.setAttribute("id","proximityPulse"),t.appendChild(r),"g"===t.tagName){t.querySelectorAll("circle, path, rect, line").forEach(t=>{const r=t.getAttribute("stroke");t.setAttribute("data-original-stroke",r||"none"),t.setAttribute("stroke",e),t.setAttribute("stroke-width","2")})}}removeProximityGlow(t){if(!t)return;t.style.filter="",t.removeAttribute("data-proximity-glow");const e=t.querySelector("#proximityPulse");if(e&&t.removeChild(e),"g"===t.tagName){t.querySelectorAll("[data-original-stroke]").forEach(t=>{const e=t.getAttribute("data-original-stroke");"none"===e?t.removeAttribute("stroke"):t.setAttribute("stroke",e),t.removeAttribute("data-original-stroke")})}}createRadar(e,r,i,a={}){if("number"!=typeof e||!isFinite(e))throw new Error("GraphicsEngine.createRadar: cx must be a finite number");if("number"!=typeof r||!isFinite(r))throw new Error("GraphicsEngine.createRadar: cy must be a finite number");if("number"!=typeof i||!isFinite(i)||i<=0)throw new Error("GraphicsEngine.createRadar: radius must be a positive finite number");if("object"!=typeof a||null===a)throw new Error("GraphicsEngine.createRadar: options must be an object");const{backgroundColor:s="#001122",borderColor:n="#00ff88",gridColor:A="#004466",scanlineColor:_="#00ffaa",borderWidth:o=t.RADAR_BORDER_WIDTH,gridLines:E=t.RADAR_GRID_LINES,sweepAnimation:I=!0,id:T=this.generateId("radar")}=a,c=this.createElement("g");c.setAttribute("id",T),c.setAttribute("transform",`translate(${e}, ${r})`);const h=this.createCircle(0,0,i,{fill:s,stroke:n,"stroke-width":o,opacity:.8});c.appendChild(h);for(let t=1;t<=E;t++){const e=i/E*t,r=this.createCircle(0,0,e,{fill:"none",stroke:A,"stroke-width":1,opacity:.5});c.appendChild(r)}const l=this.createLine(-i,0,i,0,{stroke:A,"stroke-width":1,opacity:.5});c.appendChild(l);const u=this.createLine(0,-i,0,i,{stroke:A,"stroke-width":1,opacity:.5});if(c.appendChild(u),I){const e=this.createLine(0,0,0,-i,{stroke:_,"stroke-width":2,opacity:.8,id:`${T}_sweep`}),r=this.createElement("animateTransform");r.setAttribute("attributeName","transform"),r.setAttribute("type","rotate"),r.setAttribute("values","0;360;0"),r.setAttribute("dur","4s"),r.setAttribute("repeatCount","indefinite"),e.appendChild(r),c.appendChild(e);const a=t.RADAR_TRAIL_ARC_DEGREES,s=a*t.DEGREES_TO_RADIANS_FACTOR,n=i*Math.sin(s),A=-i*Math.cos(s),o=a>t.LARGE_ARC_THRESHOLD_DEGREES?1:0,E=this.createPath(`M 0,0 L 0,${-i} A ${i},${i} 0 ${o},1 ${n},${A}`,{fill:_,opacity:t.RADAR_TRAIL_OPACITY,id:`${T}_trail`}),I=this.createElement("animateTransform");I.setAttribute("attributeName","transform"),I.setAttribute("type","rotate"),I.setAttribute("values","0;360;0"),I.setAttribute("dur",t.RADAR_SWEEP_DURATION),I.setAttribute("begin",`${t.RADAR_TRAIL_ANIMATION_DELAY}s`),I.setAttribute("repeatCount","indefinite"),E.appendChild(I),c.appendChild(E)}const d=this.createElement("g");return d.setAttribute("id",`${T}_blips`),c.appendChild(d),c}}