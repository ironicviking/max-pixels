import{GRAPHICS as t}from"../constants.js";export class GraphicsEngine{constructor(t){this.svg=t,this.layers=new Map,this.defs=this.svg.querySelector("defs")||this.createDefs(),this.idCounter=0}createDefs(){const t=this.createElement("defs");return this.svg.appendChild(t),this.createProximityGlowFilter(),t}createProximityGlowFilter(){const t=this.createElement("filter");t.setAttribute("id","proximityGlow"),t.setAttribute("x","-50%"),t.setAttribute("y","-50%"),t.setAttribute("width","200%"),t.setAttribute("height","200%");const e=this.createElement("feGaussianBlur");e.setAttribute("stdDeviation","4"),e.setAttribute("result","coloredBlur");const r=this.createElement("feMerge"),i=this.createElement("feMergeNode");i.setAttribute("in","coloredBlur");const a=this.createElement("feMergeNode");a.setAttribute("in","SourceGraphic"),r.appendChild(i),r.appendChild(a),t.appendChild(e),t.appendChild(r),this.defs.appendChild(t)}createElement(t){return document.createElementNS("http://www.w3.org/2000/svg",t)}generateId(t="element"){return`${t}_${++this.idCounter}`}setAttributes(t,e){return Object.entries(e).forEach(([e,r])=>{t.setAttribute(e,r)}),t}createLayer(t,e=0){const r=this.createElement("g");return r.setAttribute("id",`layer_${t}`),r.setAttribute("data-layer",t),r.style.zIndex=e,this.layers.set(t,r),this.svg.appendChild(r),r}getLayer(t){return this.layers.has(t)?this.layers.get(t):this.createLayer(t)}createCircle(t,e,r,i={}){if("number"!=typeof t||!isFinite(t))throw new Error("GraphicsEngine.createCircle: cx must be a finite number");if("number"!=typeof e||!isFinite(e))throw new Error("GraphicsEngine.createCircle: cy must be a finite number");if("number"!=typeof r||!isFinite(r)||r<0)throw new Error("GraphicsEngine.createCircle: r must be a non-negative finite number");if("object"!=typeof i||null===i)throw new Error("GraphicsEngine.createCircle: attributes must be an object");const a=this.createElement("circle");return a.setAttribute("cx",t),a.setAttribute("cy",e),a.setAttribute("r",r),this.setAttributes(a,i)}createRect(t,e,r,i,a={}){if("number"!=typeof t||!isFinite(t))throw new Error("GraphicsEngine.createRect: x must be a finite number");if("number"!=typeof e||!isFinite(e))throw new Error("GraphicsEngine.createRect: y must be a finite number");if("number"!=typeof r||!isFinite(r)||r<0)throw new Error("GraphicsEngine.createRect: width must be a non-negative finite number");if("number"!=typeof i||!isFinite(i)||i<0)throw new Error("GraphicsEngine.createRect: height must be a non-negative finite number");if("object"!=typeof a||null===a)throw new Error("GraphicsEngine.createRect: attributes must be an object");const s=this.createElement("rect");return s.setAttribute("x",t),s.setAttribute("y",e),s.setAttribute("width",r),s.setAttribute("height",i),this.setAttributes(s,a)}createLine(t,e,r,i,a={}){if("number"!=typeof t||!Number.isFinite(t))throw new Error("Invalid x1 parameter: must be a finite number");if("number"!=typeof e||!Number.isFinite(e))throw new Error("Invalid y1 parameter: must be a finite number");if("number"!=typeof r||!Number.isFinite(r))throw new Error("Invalid x2 parameter: must be a finite number");if("number"!=typeof i||!Number.isFinite(i))throw new Error("Invalid y2 parameter: must be a finite number");if(null!==a&&("object"!=typeof a||Array.isArray(a)))throw new Error("Invalid attributes parameter: must be an object");const s=this.createElement("line");return s.setAttribute("x1",t.toString()),s.setAttribute("y1",e.toString()),s.setAttribute("x2",r.toString()),s.setAttribute("y2",i.toString()),this.setAttributes(s,a)}createPath(t,e={}){if("string"!=typeof t||""===t.trim())throw new Error("Invalid d parameter: must be a non-empty string");if(null!==e&&("object"!=typeof e||Array.isArray(e)))throw new Error("Invalid attributes parameter: must be an object");const r=this.createElement("path");return r.setAttribute("d",t),this.setAttributes(r,e)}createGroup(t={}){const e=this.createElement("g");return this.setAttributes(e,t)}createGradient(t,e,r={}){const i=this.generateId("gradient"),a=this.createElement("radial"===t?"radialGradient":"linearGradient");return a.setAttribute("id",i),this.setAttributes(a,r),e.forEach(t=>{const e=this.createElement("stop");e.setAttribute("offset",t.offset),e.setAttribute("stop-color",t.color),void 0!==t.opacity&&e.setAttribute("stop-opacity",t.opacity),a.appendChild(e)}),this.defs.appendChild(a),i}createStarField(e,r={width:t.DEFAULT_CANVAS_WIDTH,height:t.DEFAULT_CANVAS_HEIGHT}){const i=this.createGroup({id:"starField"});for(let a=0;a<e;a++){const e=Math.random()*r.width,a=Math.random()*r.height,s=this.selectStarType(),A=t.STAR_TYPES[s],_=Math.random()*(t.STAR_SIZE_MAX-t.STAR_SIZE_MIN)+t.STAR_SIZE_MIN,E=_*A.sizeMultiplier,n=this.createStar(e,a,E,A.color,s);if(i.appendChild(n),Math.random()<t.STAR_BINARY_CHANCE){const r=this.selectStarType(),s=t.STAR_TYPES[r],A=_*t.STAR_COMPANION_SIZE_RATIO*s.sizeMultiplier,E=Math.random()*Math.PI*t.FULL_CIRCLE,n=e+Math.cos(E)*t.STAR_BINARY_SEPARATION,o=a+Math.sin(E)*t.STAR_BINARY_SEPARATION,T=this.createStar(n,o,A,s.color,r);i.appendChild(T)}}return i}selectStarType(){const e=Math.random()*t.STAR_CUMULATIVE_RARITY;let r=0;for(const[i,a]of Object.entries(t.STAR_TYPES))if(r+=a.rarity,e<=r)return i;return"M"}createStar(e,r,i,a,s){const A=Math.random()*(t.STAR_OPACITY_MAX-t.STAR_OPACITY_MIN)+t.STAR_OPACITY_MIN,_=this.createGroup({transform:`translate(${e}, ${r})`}),E=this.createCircle(0,0,i,{fill:a,opacity:A,"data-star-type":s});if(i>t.MATH_PI_MULTIPLIER||"O"===s||"B"===s){const e=this.createCircle(0,0,i*t.RATIO_BINARY_SEPARATION,{fill:a,opacity:A*t.RATIO_SIZE_SMALL,filter:"blur(1px)"});_.appendChild(e)}return _.appendChild(E),Math.random()<t.STAR_TWINKLE_CHANCE&&this.addTwinkleAnimation(E),_}addTwinkleAnimation(e){const r=this.createElement("animate");r.setAttribute("attributeName","opacity"),r.setAttribute("values",`${e.getAttribute("opacity")};${parseFloat(e.getAttribute("opacity"))*(1-t.STAR_TWINKLE_INTENSITY)};${e.getAttribute("opacity")}`),r.setAttribute("dur",`${t.STAR_TWINKLE_MIN_DURATION+Math.random()*t.STAR_TWINKLE_MAX_DURATION}s`),r.setAttribute("repeatCount","indefinite"),e.appendChild(r)}createAsteroidField(e,r={width:t.DEFAULT_CANVAS_WIDTH,height:t.DEFAULT_CANVAS_HEIGHT}){const i=this.createGroup({id:"asteroidField"});for(let a=0;a<e;a++){const e=Math.random()*r.width,a=Math.random()*r.height,s=Math.random()*t.ASTEROID_SIZE_RANGE+t.ASTEROID_SIZE_MIN,A=this.createAsteroid(e,a,s);i.appendChild(A)}return i}createAsteroid(e,r,i,a={}){if("number"!=typeof e||!isFinite(e))throw new Error("GraphicsEngine.createAsteroid: x must be a finite number");if("number"!=typeof r||!isFinite(r))throw new Error("GraphicsEngine.createAsteroid: y must be a finite number");if("number"!=typeof i||!isFinite(i)||i<=0)throw new Error("GraphicsEngine.createAsteroid: size must be a positive finite number");if("object"!=typeof a||null===a)throw new Error("GraphicsEngine.createAsteroid: attributes must be an object");const s=this.createGroup({transform:`translate(${e}, ${r})`,...a}),A=t.ASTEROID_VERTICES+Math.floor(Math.random()*t.ASTEROID_VERTEX_VARIANCE);let _="";for(let e=0;e<A;e++){const r=e/A*t.PI_TIMES_2,a=i*(t.ASTEROID_RADIUS_MIN+Math.random()*t.ASTEROID_RADIUS_MAX),s=Math.cos(r)*a,E=Math.sin(r)*a;_+=0===e?`M ${s} ${E}`:` L ${s} ${E}`}_+=" Z";const E=this.createPath(_,{fill:"#8b7355",stroke:"#654321","stroke-width":t.ASTEROID_STROKE_WIDTH,opacity:t.ASTEROID_OPACITY}),n=this.createPath(_,{fill:"none",stroke:"#a0926b","stroke-width":t.ASTEROID_HIGHLIGHT_WIDTH,opacity:t.ASTEROID_HIGHLIGHT_OPACITY,transform:`translate(-${i*t.ASTEROID_HIGHLIGHT_OFFSET}, -${i*t.ASTEROID_HIGHLIGHT_OFFSET})`});return s.appendChild(E),s.appendChild(n),s}createSpaceship(e,r,i=t.SPACESHIP_DEFAULT_SIZE,a={}){const s=this.createGroup({transform:`translate(${e}, ${r})`,...a}),A=this.createPath(`M 0 -${i} L ${i*t.SPACESHIP_HULL_WING_RATIO} ${i} L 0 ${i*t.SPACESHIP_HULL_BODY_RATIO} L -${i*t.SPACESHIP_HULL_WING_RATIO} ${i} Z`,{fill:"#4a90e2",stroke:"#ffffff","stroke-width":t.SPACESHIP_STROKE_WIDTH}),_=this.createCircle(0,i*t.SPACESHIP_ENGINE_RATIO,i*t.SPACESHIP_ENGINE_SIZE_RATIO,{fill:"#ff4444",opacity:.8}),E=this.createGroup({id:"mainThruster",opacity:0}),n=this.createPath(`M -${i*t.SPACESHIP_THRUSTER_MAIN_WIDTH} ${i*t.SPACESHIP_THRUSTER_OPACITY} L 0 ${i*t.SPACESHIP_THRUSTER_MAIN_HEIGHT} L ${i*t.SPACESHIP_THRUSTER_MAIN_WIDTH} ${i*t.SPACESHIP_THRUSTER_OPACITY} Z`,{fill:"#ff6600",opacity:t.SPACESHIP_THRUSTER_FLAME_OPACITY}),o=this.createPath(`M -${i*t.SPACESHIP_THRUSTER_CORE_WIDTH} ${i*t.SPACESHIP_THRUSTER_INNER_OPACITY} L 0 ${i*t.SPACESHIP_THRUSTER_CORE_HEIGHT} L ${i*t.SPACESHIP_THRUSTER_CORE_WIDTH} ${i*t.SPACESHIP_THRUSTER_INNER_OPACITY} Z`,{fill:"#ffaa00",opacity:t.SPACESHIP_THRUSTER_INNER_OPACITY}),T=this.createPath(`M -${Number(i)*t.SPACESHIP_THRUSTER_INNER_WIDTH} ${Number(i)*t.SPACESHIP_THRUSTER_CORE_HEIGHT_OFFSET} L 0 ${Number(i)*t.SPACESHIP_THRUSTER_INNER_HEIGHT} L ${Number(i)*t.SPACESHIP_THRUSTER_INNER_WIDTH} ${Number(i)*t.SPACESHIP_THRUSTER_CORE_HEIGHT_OFFSET} Z`,{fill:"#ffffff",opacity:t.SPACESHIP_THRUSTER_FLAME_OPACITY});E.appendChild(n),E.appendChild(o),E.appendChild(T);const I=this.createGroup({id:"leftThruster",opacity:0}),l=this.createPath(`M -${i*t.SPACESHIP_THRUSTER_SIDE_WIDTH} -${i*t.SPACESHIP_THRUSTER_SIDE_HEIGHT} L -${i*t.SPACESHIP_THRUSTER_SIDE_LENGTH} 0 L -${i*t.SPACESHIP_THRUSTER_SIDE_WIDTH} ${i*t.SPACESHIP_THRUSTER_SIDE_HEIGHT} Z`,{fill:"#0088ff",opacity:t.SPACESHIP_THRUSTER_SIDE_OPACITY});I.appendChild(l);const c=this.createGroup({id:"rightThruster",opacity:0}),h=this.createPath(`M ${i*t.SPACESHIP_THRUSTER_SIDE_WIDTH} -${i*t.SPACESHIP_THRUSTER_SIDE_HEIGHT} L ${i*t.SPACESHIP_THRUSTER_SIDE_LENGTH} 0 L ${i*t.SPACESHIP_THRUSTER_SIDE_WIDTH} ${i*t.SPACESHIP_THRUSTER_SIDE_HEIGHT} Z`,{fill:"#0088ff",opacity:t.SPACESHIP_THRUSTER_SIDE_OPACITY});return c.appendChild(h),s.appendChild(A),s.appendChild(_),s.appendChild(E),s.appendChild(I),s.appendChild(c),s}updateSpaceshipThrusters(e,r,i=!1){const a=e.querySelector("#mainThruster"),s=e.querySelector("#leftThruster"),A=e.querySelector("#rightThruster");if(!a||!s||!A)return;const _=i?t.SPACESHIP_THRUSTER_BOOST_OPACITY:t.SPACESHIP_THRUSTER_BASE_OPACITY,E=t.SPACESHIP_THRUSTER_FADE_SPEED;if(r.y>0)a.setAttribute("opacity",_);else{const t=parseFloat(a.getAttribute("opacity"))||0,e=Math.max(0,t-E);a.setAttribute("opacity",e)}if(r.x>0)s.setAttribute("opacity",_*t.SPACESHIP_THRUSTER_SIDE_OPACITY);else{const t=parseFloat(s.getAttribute("opacity"))||0,e=Math.max(0,t-E);s.setAttribute("opacity",e)}if(r.x<0)A.setAttribute("opacity",_*t.SPACESHIP_THRUSTER_SIDE_OPACITY);else{const t=parseFloat(A.getAttribute("opacity"))||0,e=Math.max(0,t-E);A.setAttribute("opacity",e)}}createPlanet(e,r,i,a={}){const s=this.createGroup({transform:`translate(${e}, ${r})`,...a}),A=a.surfaceColor||"#8b4513",_=a.coreColor||"#654321",E=a.atmosphereColor||"#4444ff",n=this.createGradient("radial",[{offset:"0%",color:A},{offset:"70%",color:_},{offset:"100%",color:"#2c1810"}],{cx:"30%",cy:"30%"}),o=this.createCircle(0,0,i,{fill:`url(#${n})`,stroke:E,"stroke-width":2,opacity:t.RATIO_OPACITY_HIGH});return s.appendChild(o),this.addPlanetCraters(s,i,A),this.addPlanetContinents(s,i,A),this.addPlanetAtmosphere(s,i,E),s}addPlanetCraters(e,r,i){const a=t.PLANET_CRATER_MIN+Math.floor(Math.random()*t.PLANET_CRATER_MAX);for(let s=0;s<a;s++){const a=Math.random()*Math.PI*t.FULL_CIRCLE,s=Math.random()*r*t.PLANET_CRATER_DISTANCE_MAX,A=Math.cos(a)*s,_=Math.sin(a)*s,E=Math.random()*r*t.PLANET_CRATER_SIZE_MAX+r*t.PLANET_CRATER_SIZE_MIN,n=this.createCircle(A,_,E,{fill:this.darkenColor(i,t.PLANET_DARKEN_FACTOR),opacity:.8}),o=this.createCircle(A,_,E*t.PLANET_CRATER_RIM_RATIO,{fill:"none",stroke:this.lightenColor(i,t.PLANET_LIGHTEN_FACTOR),"stroke-width":1,opacity:.6});e.appendChild(n),e.appendChild(o)}}addPlanetContinents(e,r,i){const a=t.PLANET_CONTINENT_MIN+Math.floor(Math.random()*t.PLANET_CONTINENT_MAX);for(let s=0;s<a;s++){const a=Math.random()*Math.PI*t.FULL_CIRCLE,s=Math.random()*r*t.PLANET_CONTINENT_DISTANCE_MAX,A=Math.cos(a)*s,_=Math.sin(a)*s,E=t.PLANET_CONTINENT_POINTS_MIN+Math.floor(Math.random()*t.PLANET_CONTINENT_POINTS_MAX);let n="";for(let e=0;e<E;e++){const i=e/E*t.PI_TIMES_2,a=r*(t.PLANET_CONTINENT_RADIUS_MIN+Math.random()*t.PLANET_CONTINENT_RADIUS_MAX),s=A+Math.cos(i)*a,o=_+Math.sin(i)*a;n+=0===e?`M ${s} ${o}`:` L ${s} ${o}`}n+=" Z";const o=this.createPath(n,{fill:this.lightenColor(i,t.PLANET_LIGHTEN_FACTOR),opacity:t.PLANET_CONTINENT_OPACITY,"clip-path":`circle(${r}px at 0px 0px)`});e.appendChild(o)}}addPlanetAtmosphere(e,r,i){const a=this.createGradient("radial",[{offset:"85%",color:i,opacity:0},{offset:"100%",color:i,opacity:.3}],{cx:"50%",cy:"50%"}),s=this.createCircle(0,0,r*t.GLOW_INTENSITY,{fill:`url(#${a})`,opacity:.6});e.appendChild(s)}darkenColor(e,r){if(e.startsWith("#")){const i=e.slice(1);return`rgb(${Math.floor(parseInt(i.slice(t.HEX_RED_START,t.HEX_RED_END),16)*(1-r))}, ${Math.floor(parseInt(i.slice(t.HEX_GREEN_START,t.HEX_GREEN_END),16)*(1-r))}, ${Math.floor(parseInt(i.slice(t.HEX_BLUE_START,t.HEX_BLUE_END),16)*(1-r))})`}return e}lightenColor(e,r){if(e.startsWith("#")){const i=e.slice(1);return`rgb(${Math.min(t.COLOR_MAX,Math.floor(parseInt(i.slice(t.HEX_RED_START,t.HEX_RED_END),16)*(1+r)))}, ${Math.min(t.COLOR_MAX,Math.floor(parseInt(i.slice(t.HEX_GREEN_START,t.HEX_GREEN_END),16)*(1+r)))}, ${Math.min(t.COLOR_MAX,Math.floor(parseInt(i.slice(t.HEX_BLUE_START,t.HEX_BLUE_END),16)*(1+r)))})`}return e}createSpaceStation(e,r,i=t.STATION_DEFAULT_SIZE,a={}){const s=this.createGroup({transform:`translate(${e}, ${r})`,...a}),A=this.createCircle(0,0,i*t.STATION_HUB_RATIO,{fill:"#666666",stroke:"#aaaaaa","stroke-width":2}),_=this.createCircle(0,0,i*t.STATION_RING_RATIO,{fill:"none",stroke:"#888888","stroke-width":i*t.STATION_RING_WIDTH,opacity:t.STATION_RING_OPACITY});for(let e=0;e<t.STATION_DOCKING_PORTS;e++){const r=e*t.ANGLE_90*Math.PI/t.ANGLE_180,a=Math.cos(r)*i,A=Math.sin(r)*i,_=this.createRect(a-i*t.STATION_PORT_WIDTH,A-i*t.STATION_PORT_HEIGHT,i*t.STATION_PORT_LENGTH,i*t.STATION_PORT_WIDTH,{fill:"#4a90e2",stroke:"#ffffff","stroke-width":1,transform:`rotate(${e*t.ANGLE_90}, ${a}, ${A})`});s.appendChild(_)}for(let e=0;e<t.STATION_SOLAR_PANELS;e++){const r=e*t.ANGLE_60*Math.PI/t.ANGLE_180,a=Math.cos(r)*i*t.STATION_PANEL_DISTANCE,A=Math.sin(r)*i*t.STATION_PANEL_DISTANCE,_=this.createRect(a-i*t.STATION_PANEL_WIDTH,A-i*t.STATION_PANEL_HEIGHT,i*t.STATION_PANEL_LENGTH,i*t.STATION_PANEL_WIDTH,{fill:"#1a1a3a",stroke:"#4444ff","stroke-width":1,opacity:t.STATION_PANEL_OPACITY,transform:`rotate(${e*t.ANGLE_60}, ${a}, ${A})`});s.appendChild(_)}const E=this.createRect(-i*t.STATION_COMM_WIDTH,-i*t.STATION_COMM_HEIGHT,i*t.STATION_COMM_LENGTH,i*t.STATION_COMM_WIDTH_RATIO,{fill:"#cccccc",stroke:"#ffffff","stroke-width":1});s.appendChild(A),s.appendChild(_),s.appendChild(E);const n=this.createCircle(-i*t.STATION_NAV_LIGHT_RATIO,0,i*t.STATION_NAV_LIGHT_SIZE,{fill:"#ff4444",opacity:t.STATION_NAV_LIGHT_OPACITY}),o=this.createCircle(i*t.STATION_NAV_LIGHT_RATIO,0,i*t.STATION_NAV_LIGHT_SIZE,{fill:"#44ff44",opacity:t.STATION_NAV_LIGHT_OPACITY});return s.appendChild(n),s.appendChild(o),s}createJumpGate(e,r,i=t.GATE_DEFAULT_SIZE,a={}){const s=this.createGroup({transform:`translate(${e}, ${r})`,...a}),A=this.createCircle(0,0,i,{fill:"none",stroke:"#00ffff","stroke-width":i*t.GATE_OUTER_STROKE_RATIO,opacity:t.GATE_OUTER_OPACITY,"stroke-dasharray":`${i*t.GATE_DASH_ARRAY_LONG} ${i*t.GATE_DASH_ARRAY_SHORT}`}),_=this.createCircle(0,0,i*t.GATE_INNER_RATIO,{fill:"none",stroke:"#ffffff","stroke-width":i*t.GATE_INNER_STROKE_RATIO,opacity:t.GATE_INNER_OPACITY}),E=this.createCircle(0,0,i*t.GATE_CORE_RATIO,{fill:"#00ffff",opacity:t.GATE_CORE_OPACITY,"fill-rule":"evenodd"});for(let e=0;e<t.GATE_STRUT_COUNT;e++){const r=e*t.ANGLE_90*Math.PI/t.ANGLE_180,a=Math.cos(r)*i*t.GATE_STRUT_INNER_RATIO,A=Math.sin(r)*i*t.GATE_STRUT_INNER_RATIO,_=Math.cos(r)*i*t.GATE_STRUT_OUTER_RATIO,E=Math.sin(r)*i*t.GATE_STRUT_OUTER_RATIO,n=this.createElement("line");n.setAttribute("x1",a),n.setAttribute("y1",A),n.setAttribute("x2",_),n.setAttribute("y2",E),n.setAttribute("stroke","#aaaaaa"),n.setAttribute("stroke-width",i*t.GATE_STRUT_WIDTH),s.appendChild(n)}const n=this.createGroup({id:`particles_${this.generateId("gate")}`});for(let e=0;e<t.GATE_PARTICLES;e++){const r=e*t.ANGLE_45*Math.PI/t.ANGLE_180,a=Math.cos(r)*i*t.GATE_PARTICLE_DISTANCE,s=Math.sin(r)*i*t.GATE_PARTICLE_DISTANCE,A=this.createCircle(a,s,i*t.GATE_PARTICLE_SIZE,{fill:"#00ffff",opacity:t.GATE_PARTICLE_OPACITY});n.appendChild(A)}const o=this.createElement("animateTransform");o.setAttribute("attributeName","transform"),o.setAttribute("type","rotate"),o.setAttribute("values","0 0 0;360 0 0"),o.setAttribute("dur",t.GATE_ANIMATION_DURATION_ROTATE),o.setAttribute("repeatCount","indefinite"),n.appendChild(o),s.appendChild(n),s.appendChild(E),s.appendChild(_),s.appendChild(A);const T=this.createElement("animate");T.setAttribute("attributeName","opacity"),T.setAttribute("values",`${t.GATE_PULSE_MIN};${t.GATE_PULSE_MAX};${t.GATE_PULSE_MIN}`),T.setAttribute("dur",t.GATE_ANIMATION_DURATION_PULSE),T.setAttribute("repeatCount","indefinite"),A.appendChild(T);const I=this.createElement("animate");return I.setAttribute("attributeName","opacity"),I.setAttribute("values",`${t.GATE_CORE_PULSE_MIN};${t.GATE_CORE_PULSE_MAX};${t.GATE_CORE_PULSE_MIN}`),I.setAttribute("dur",t.GATE_ANIMATION_DURATION_CORE),I.setAttribute("repeatCount","indefinite"),E.appendChild(I),s}addToLayer(t,e){return this.getLayer(t).appendChild(e),e}clear(){this.svg.innerHTML="",this.layers.clear(),this.defs=this.createDefs(),this.idCounter=0}remove(t){t.parentNode&&t.parentNode.removeChild(t)}createLaserBeam(e,r,i,a,s={}){const A=this.createGroup({id:this.generateId("laser"),...s}),_=this.createElement("line");_.setAttribute("x1",e),_.setAttribute("y1",r),_.setAttribute("x2",i),_.setAttribute("y2",a),_.setAttribute("stroke",s.color||"#ff0000"),_.setAttribute("stroke-width",s.width||t.LASER_DEFAULT_WIDTH),_.setAttribute("opacity",t.LASER_BEAM_OPACITY),_.setAttribute("stroke-linecap","round");const E=this.createElement("line");E.setAttribute("x1",e),E.setAttribute("y1",r),E.setAttribute("x2",i),E.setAttribute("y2",a),E.setAttribute("stroke",s.glowColor||"#ffaaaa"),E.setAttribute("stroke-width",(s.width||t.LASER_DEFAULT_WIDTH)*t.LASER_GLOW_MULTIPLIER),E.setAttribute("opacity",t.LASER_GLOW_OPACITY),E.setAttribute("stroke-linecap","round");const n=this.createElement("line");n.setAttribute("x1",e),n.setAttribute("y1",r),n.setAttribute("x2",i),n.setAttribute("y2",a),n.setAttribute("stroke","#ffffff"),n.setAttribute("stroke-width",1),n.setAttribute("opacity",t.LASER_CORE_OPACITY),n.setAttribute("stroke-linecap","round"),A.appendChild(E),A.appendChild(_),A.appendChild(n);const o=this.createElement("animate");return o.setAttribute("attributeName","opacity"),o.setAttribute("values","0;1;1;0"),o.setAttribute("dur",s.duration||"0.3s"),o.setAttribute("fill","freeze"),A.appendChild(o),setTimeout(()=>{this.remove(A)},parseFloat(s.duration||t.LASER_DEFAULT_DURATION)*t.SECONDS_TO_MS+t.LASER_CLEANUP_DELAY),A}createLaserImpact(e,r,i={}){const a=this.createGroup({id:this.generateId("impact"),transform:`translate(${e}, ${r})`}),s=this.createCircle(0,0,i.size||t.IMPACT_DEFAULT_SIZE,{fill:i.color||"#ffff00",opacity:t.RATIO_OPACITY_HIGH}),A=this.createCircle(0,0,(i.size||t.IMPACT_DEFAULT_SIZE)*t.IMPACT_RING_MULTIPLIER,{fill:"none",stroke:i.ringColor||"#ff8800","stroke-width":2,opacity:.7});for(let e=0;e<t.IMPACT_SPARKS;e++){const r=e*t.ANGLE_60*Math.PI/t.ANGLE_180,s=(i.size||t.IMPACT_DEFAULT_SIZE)*t.IMPACT_SPARK_DISTANCE,A=Math.cos(r)*s,_=Math.sin(r)*s,E=this.createElement("line");E.setAttribute("x1",0),E.setAttribute("y1",0),E.setAttribute("x2",A),E.setAttribute("y2",_),E.setAttribute("stroke","#ffffff"),E.setAttribute("stroke-width",1),E.setAttribute("opacity",t.IMPACT_SPARK_OPACITY),E.setAttribute("stroke-linecap","round"),a.appendChild(E)}a.appendChild(A),a.appendChild(s);const _=this.createElement("animateTransform");_.setAttribute("attributeName","transform"),_.setAttribute("type","scale"),_.setAttribute("values","0 0;1.5 1.5;0.5 0.5"),_.setAttribute("dur",i.duration||"0.4s"),_.setAttribute("fill","freeze"),_.setAttribute("additive","sum");const E=this.createElement("animate");return E.setAttribute("attributeName","opacity"),E.setAttribute("values","0;1;0"),E.setAttribute("dur",i.duration||"0.4s"),E.setAttribute("fill","freeze"),a.appendChild(_),a.appendChild(E),setTimeout(()=>{this.remove(a)},parseFloat(i.duration||t.IMPACT_DEFAULT_DURATION)*t.SECONDS_TO_MS+t.IMPACT_CLEANUP_DELAY),a}createProjectile(e,r,i="plasma",a={}){const s=this.createGroup({id:this.generateId("projectile"),transform:`translate(${e}, ${r})`,...a});if("plasma"===i){const e=this.createCircle(0,0,t.PROJECTILE_PLASMA_CORE,{fill:"#00ffff",opacity:t.RATIO_OPACITY_HIGH}),r=this.createCircle(0,0,t.PROJECTILE_PLASMA_GLOW,{fill:"#00aaff",opacity:t.PROJECTILE_PLASMA_GLOW_OPACITY}),i=this.createCircle(0,0,t.PROJECTILE_PLASMA_TRAIL,{fill:"none",stroke:"#0088ff","stroke-width":t.PROJECTILE_PLASMA_TRAIL_WIDTH,opacity:t.PROJECTILE_PLASMA_TRAIL_OPACITY});s.appendChild(i),s.appendChild(r),s.appendChild(e)}else if("missile"===i){const e=this.createPath("M -8 0 L 8 -2 L 10 0 L 8 2 Z",{fill:"#666666",stroke:"#aaaaaa","stroke-width":t.PROJECTILE_MISSILE_STROKE_WIDTH}),r=this.createCircle(t.PROJECTILE_MISSILE_WIDTH,0,t.PROJECTILE_MISSILE_WARHEAD,{fill:"#ff4444",opacity:t.PROJECTILE_MISSILE_WARHEAD_OPACITY}),i=this.createPath("M -8 0 L -15 -1 L -12 0 L -15 1 Z",{fill:"#ff8800",opacity:t.PROJECTILE_MISSILE_EXHAUST_OPACITY});s.appendChild(i),s.appendChild(e),s.appendChild(r)}else if("railgun"===i){const e=this.createRect(-t.PROJECTILE_RAILGUN_WIDTH/2,-t.PROJECTILE_RAILGUN_HEIGHT/2,t.PROJECTILE_RAILGUN_WIDTH,t.PROJECTILE_RAILGUN_HEIGHT,{fill:"#ffff00",opacity:t.RATIO_OPACITY_HIGH}),r=this.createRect(-t.PROJECTILE_RAILGUN_FIELD_WIDTH/2,-t.PROJECTILE_RAILGUN_FIELD_HEIGHT/2,t.PROJECTILE_RAILGUN_FIELD_WIDTH,t.PROJECTILE_RAILGUN_FIELD_HEIGHT,{fill:"none",stroke:"#ffff88","stroke-width":t.PROJECTILE_RAILGUN_FIELD_WIDTH_STROKE,opacity:t.PROJECTILE_RAILGUN_FIELD_OPACITY});s.appendChild(r),s.appendChild(e)}return s}createExplosion(e,r,i=t.EXPLOSION_DEFAULT_SIZE,a={}){const s=this.createGroup({id:this.generateId("explosion"),transform:`translate(${e}, ${r})`}),A=a.colors||["#ff4444","#ff8800","#ffff00","#ffffff"],_=t.EXPLOSION_RINGS;for(let e=0;e<_;e++){const r=this.createCircle(0,0,i*(t.EXPLOSION_RING_BASE+e*t.EXPLOSION_RING_INCREMENT),{fill:"none",stroke:A[e]||A[A.length-1],"stroke-width":i*t.EXPLOSION_STROKE_WIDTH,opacity:t.EXPLOSION_RING_OPACITY_BASE-e*t.EXPLOSION_RING_OPACITY_DECREMENT});s.appendChild(r)}const E=this.createCircle(0,0,i*t.EXPLOSION_FLASH_RATIO,{fill:"#ffffff",opacity:t.EXPLOSION_FLASH_OPACITY});for(let e=0;e<t.EXPLOSION_PARTICLES;e++){const r=e*t.ANGLE_30*Math.PI/t.ANGLE_180,a=i*t.EXPLOSION_PARTICLE_DISTANCE,A=Math.cos(r)*a,_=Math.sin(r)*a,E=this.createCircle(A,_,t.EXPLOSION_PARTICLE_SIZE,{fill:"#ffaa00",opacity:t.EXPLOSION_PARTICLE_OPACITY});s.appendChild(E)}s.appendChild(E);const n=this.createElement("animateTransform");n.setAttribute("attributeName","transform"),n.setAttribute("type","scale"),n.setAttribute("values","0 0;2 2;1 1"),n.setAttribute("dur",a.duration||t.EXPLOSION_DEFAULT_DURATION),n.setAttribute("fill","freeze"),n.setAttribute("additive","sum");const o=this.createElement("animate");return o.setAttribute("attributeName","opacity"),o.setAttribute("values","0;1;0"),o.setAttribute("dur",a.duration||t.EXPLOSION_DEFAULT_DURATION),o.setAttribute("fill","freeze"),s.appendChild(n),s.appendChild(o),setTimeout(()=>{this.remove(s)},parseFloat(a.duration||t.EXPLOSION_DEFAULT_DURATION)*t.SECONDS_TO_MS+t.EXPLOSION_CLEANUP_DELAY),s}createShieldEffect(e,r,i=t.SHIELD_DEFAULT_RADIUS,a={}){const s=this.createGroup({id:this.generateId("shield"),transform:`translate(${e}, ${r})`}),A=a.color||"#00aaff",_=this.createPath(`M ${i} 0 L ${i*t.SHIELD_HEX_RATIO} ${i*t.SHIELD_HEX_RATIO_LONG} L ${-i*t.SHIELD_HEX_RATIO} ${i*t.SHIELD_HEX_RATIO_LONG} \n             L ${-i} 0 L ${-i*t.SHIELD_HEX_RATIO} ${-i*t.SHIELD_HEX_RATIO_LONG} L ${i*t.SHIELD_HEX_RATIO} ${-i*t.SHIELD_HEX_RATIO_LONG} Z`,{fill:"none",stroke:A,"stroke-width":t.SHIELD_STROKE_WIDTH,opacity:t.SHIELD_HEX_OPACITY}),E=this.createCircle(0,0,i*t.SHIELD_FIELD_RATIO,{fill:A,opacity:t.SHIELD_FIELD_OPACITY});for(let e=0;e<t.SHIELD_LINES;e++){const r=e*t.ANGLE_60*Math.PI/t.ANGLE_180,a=Math.cos(r)*i*t.SHIELD_LINE_LENGTH,_=Math.sin(r)*i*t.SHIELD_LINE_LENGTH,E=this.createElement("line");E.setAttribute("x1",0),E.setAttribute("y1",0),E.setAttribute("x2",a),E.setAttribute("y2",_),E.setAttribute("stroke",A),E.setAttribute("stroke-width",t.SHIELD_LINE_WIDTH),E.setAttribute("opacity",t.SHIELD_LINE_OPACITY),s.appendChild(E)}s.appendChild(E),s.appendChild(_);const n=this.createElement("animate");return n.setAttribute("attributeName","opacity"),n.setAttribute("values",`${t.SHIELD_PULSE_MIN};${t.SHIELD_PULSE_MAX};${t.SHIELD_PULSE_MIN}`),n.setAttribute("dur",t.SHIELD_PULSE_DURATION),n.setAttribute("repeatCount","indefinite"),s.appendChild(n),s}animate(e,r,i=t.CLEANUP_DELAY_MS,a="ease-in-out"){const s=this.createElement("animateTransform");return s.setAttribute("attributeName","transform"),s.setAttribute("dur",`${i}ms`),s.setAttribute("fill","freeze"),r.transform&&(s.setAttribute("type",r.transform.type||"translate"),s.setAttribute("values",r.transform.values)),e.appendChild(s),new Promise(t=>{setTimeout(t,i)})}addProximityGlow(t,e="#00ffff"){if(!t)return;t.style.filter="url(#proximityGlow)",t.setAttribute("data-proximity-glow","true");const r=this.createElement("animate");if(r.setAttribute("attributeName","opacity"),r.setAttribute("values","0.4;0.8;0.4"),r.setAttribute("dur","1.5s"),r.setAttribute("repeatCount","indefinite"),r.setAttribute("id","proximityPulse"),t.appendChild(r),"g"===t.tagName){t.querySelectorAll("circle, path, rect, line").forEach(t=>{const r=t.getAttribute("stroke");t.setAttribute("data-original-stroke",r||"none"),t.setAttribute("stroke",e),t.setAttribute("stroke-width","2")})}}removeProximityGlow(t){if(!t)return;t.style.filter="",t.removeAttribute("data-proximity-glow");const e=t.querySelector("#proximityPulse");if(e&&t.removeChild(e),"g"===t.tagName){t.querySelectorAll("[data-original-stroke]").forEach(t=>{const e=t.getAttribute("data-original-stroke");"none"===e?t.removeAttribute("stroke"):t.setAttribute("stroke",e),t.removeAttribute("data-original-stroke")})}}}