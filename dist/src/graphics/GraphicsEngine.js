import{GRAPHICS as t}from"../constants.js";export class GraphicsEngine{constructor(t){this.svg=t,this.layers=new Map,this.defs=this.svg.querySelector("defs")||this.createDefs(),this.idCounter=0}createDefs(){const t=this.createElement("defs");return this.svg.appendChild(t),t}createElement(t){return document.createElementNS("http://www.w3.org/2000/svg",t)}generateId(t="element"){return`${t}_${++this.idCounter}`}setAttributes(t,e){return Object.entries(e).forEach(([e,r])=>{t.setAttribute(e,r)}),t}createLayer(t,e=0){const r=this.createElement("g");return r.setAttribute("id",`layer_${t}`),r.setAttribute("data-layer",t),r.style.zIndex=e,this.layers.set(t,r),this.svg.appendChild(r),r}getLayer(t){return this.layers.has(t)?this.layers.get(t):this.createLayer(t)}createCircle(t,e,r,i={}){const a=this.createElement("circle");return a.setAttribute("cx",t),a.setAttribute("cy",e),a.setAttribute("r",r),this.setAttributes(a,i)}createRect(t,e,r,i,a={}){const _=this.createElement("rect");return _.setAttribute("x",t),_.setAttribute("y",e),_.setAttribute("width",r),_.setAttribute("height",i),this.setAttributes(_,a)}createPath(t,e={}){const r=this.createElement("path");return r.setAttribute("d",t),this.setAttributes(r,e)}createGroup(t={}){const e=this.createElement("g");return this.setAttributes(e,t)}createGradient(t,e,r={}){const i=this.generateId("gradient"),a=this.createElement("radial"===t?"radialGradient":"linearGradient");return a.setAttribute("id",i),this.setAttributes(a,r),e.forEach(t=>{const e=this.createElement("stop");e.setAttribute("offset",t.offset),e.setAttribute("stop-color",t.color),void 0!==t.opacity&&e.setAttribute("stop-opacity",t.opacity),a.appendChild(e)}),this.defs.appendChild(a),i}createStarField(e,r={width:t.DEFAULT_CANVAS_WIDTH,height:t.DEFAULT_CANVAS_HEIGHT}){const i=this.createGroup({id:"starField"});for(let a=0;a<e;a++){const e=Math.random()*r.width,a=Math.random()*r.height,_=this.selectStarType(),s=t.STAR_TYPES[_],A=Math.random()*(t.STAR_SIZE_MAX-t.STAR_SIZE_MIN)+t.STAR_SIZE_MIN,T=A*s.sizeMultiplier,E=this.createStar(e,a,T,s.color,_);if(i.appendChild(E),Math.random()<t.STAR_BINARY_CHANCE){const r=this.selectStarType(),_=t.STAR_TYPES[r],s=A*t.STAR_COMPANION_SIZE_RATIO*_.sizeMultiplier,T=Math.random()*Math.PI*t.FULL_CIRCLE,E=e+Math.cos(T)*t.STAR_BINARY_SEPARATION,I=a+Math.sin(T)*t.STAR_BINARY_SEPARATION,o=this.createStar(E,I,s,_.color,r);i.appendChild(o)}}return i}selectStarType(){const e=Math.random()*t.STAR_CUMULATIVE_RARITY;let r=0;for(const[i,a]of Object.entries(t.STAR_TYPES))if(r+=a.rarity,e<=r)return i;return"M"}createStar(e,r,i,a,_){const s=Math.random()*(t.STAR_OPACITY_MAX-t.STAR_OPACITY_MIN)+t.STAR_OPACITY_MIN,A=this.createGroup({transform:`translate(${e}, ${r})`}),T=this.createCircle(0,0,i,{fill:a,opacity:s,"data-star-type":_});if(i>t.MATH_PI_MULTIPLIER||"O"===_||"B"===_){const e=this.createCircle(0,0,i*t.RATIO_BINARY_SEPARATION,{fill:a,opacity:s*t.RATIO_SIZE_SMALL,filter:"blur(1px)"});A.appendChild(e)}return A.appendChild(T),Math.random()<t.STAR_TWINKLE_CHANCE&&this.addTwinkleAnimation(T),A}addTwinkleAnimation(e){const r=this.createElement("animate");r.setAttribute("attributeName","opacity"),r.setAttribute("values",`${e.getAttribute("opacity")};${parseFloat(e.getAttribute("opacity"))*(1-t.STAR_TWINKLE_INTENSITY)};${e.getAttribute("opacity")}`),r.setAttribute("dur",`${t.STAR_TWINKLE_MIN_DURATION+Math.random()*t.STAR_TWINKLE_MAX_DURATION}s`),r.setAttribute("repeatCount","indefinite"),e.appendChild(r)}createAsteroidField(e,r={width:t.DEFAULT_CANVAS_WIDTH,height:t.DEFAULT_CANVAS_HEIGHT}){const i=this.createGroup({id:"asteroidField"});for(let a=0;a<e;a++){const e=Math.random()*r.width,a=Math.random()*r.height,_=Math.random()*t.ASTEROID_SIZE_RANGE+t.ASTEROID_SIZE_MIN,s=this.createAsteroid(e,a,_);i.appendChild(s)}return i}createAsteroid(e,r,i,a={}){const _=this.createGroup({transform:`translate(${e}, ${r})`,...a}),s=t.ASTEROID_VERTICES+Math.floor(Math.random()*t.ASTEROID_VERTEX_VARIANCE);let A="";for(let e=0;e<s;e++){const r=e/s*2*Math.PI,a=i*(t.ASTEROID_RADIUS_MIN+Math.random()*t.ASTEROID_RADIUS_MAX),_=Math.cos(r)*a,T=Math.sin(r)*a;A+=0===e?`M ${_} ${T}`:` L ${_} ${T}`}A+=" Z";const T=this.createPath(A,{fill:"#8b7355",stroke:"#654321","stroke-width":t.ASTEROID_STROKE_WIDTH,opacity:t.ASTEROID_OPACITY}),E=this.createPath(A,{fill:"none",stroke:"#a0926b","stroke-width":t.ASTEROID_HIGHLIGHT_WIDTH,opacity:t.ASTEROID_HIGHLIGHT_OPACITY,transform:`translate(-${i*t.ASTEROID_HIGHLIGHT_OFFSET}, -${i*t.ASTEROID_HIGHLIGHT_OFFSET})`});return _.appendChild(T),_.appendChild(E),_}createSpaceship(e,r,i=t.SPACESHIP_DEFAULT_SIZE,a={}){const _=this.createGroup({transform:`translate(${e}, ${r})`,...a}),s=this.createPath(`M 0 -${i} L ${i*t.SPACESHIP_HULL_WING_RATIO} ${i} L 0 ${i*t.SPACESHIP_HULL_BODY_RATIO} L -${i*t.SPACESHIP_HULL_WING_RATIO} ${i} Z`,{fill:"#4a90e2",stroke:"#ffffff","stroke-width":t.SPACESHIP_STROKE_WIDTH}),A=this.createCircle(0,i*t.SPACESHIP_ENGINE_RATIO,i*t.SPACESHIP_ENGINE_SIZE_RATIO,{fill:"#ff4444",opacity:.8}),T=this.createGroup({id:"mainThruster",opacity:0}),E=this.createPath(`M -${i*t.SPACESHIP_THRUSTER_MAIN_WIDTH} ${i*t.SPACESHIP_THRUSTER_OPACITY} L 0 ${i*t.SPACESHIP_THRUSTER_MAIN_HEIGHT} L ${i*t.SPACESHIP_THRUSTER_MAIN_WIDTH} ${i*t.SPACESHIP_THRUSTER_OPACITY} Z`,{fill:"#ff6600",opacity:t.SPACESHIP_THRUSTER_FLAME_OPACITY}),I=this.createPath(`M -${i*t.SPACESHIP_THRUSTER_CORE_WIDTH} ${i*t.SPACESHIP_THRUSTER_INNER_OPACITY} L 0 ${i*t.SPACESHIP_THRUSTER_CORE_HEIGHT} L ${i*t.SPACESHIP_THRUSTER_CORE_WIDTH} ${i*t.SPACESHIP_THRUSTER_INNER_OPACITY} Z`,{fill:"#ffaa00",opacity:t.SPACESHIP_THRUSTER_INNER_OPACITY}),o=this.createPath(`M -${Number(i)*t.SPACESHIP_THRUSTER_INNER_WIDTH} ${Number(i)*t.SPACESHIP_THRUSTER_CORE_HEIGHT_OFFSET} L 0 ${Number(i)*t.SPACESHIP_THRUSTER_INNER_HEIGHT} L ${Number(i)*t.SPACESHIP_THRUSTER_INNER_WIDTH} ${Number(i)*t.SPACESHIP_THRUSTER_CORE_HEIGHT_OFFSET} Z`,{fill:"#ffffff",opacity:t.SPACESHIP_THRUSTER_FLAME_OPACITY});T.appendChild(E),T.appendChild(I),T.appendChild(o);const n=this.createGroup({id:"leftThruster",opacity:0}),l=this.createPath(`M -${i*t.SPACESHIP_THRUSTER_SIDE_WIDTH} -${i*t.SPACESHIP_THRUSTER_SIDE_HEIGHT} L -${i*t.SPACESHIP_THRUSTER_SIDE_LENGTH} 0 L -${i*t.SPACESHIP_THRUSTER_SIDE_WIDTH} ${i*t.SPACESHIP_THRUSTER_SIDE_HEIGHT} Z`,{fill:"#0088ff",opacity:t.SPACESHIP_THRUSTER_SIDE_OPACITY});n.appendChild(l);const S=this.createGroup({id:"rightThruster",opacity:0}),c=this.createPath(`M ${i*t.SPACESHIP_THRUSTER_SIDE_WIDTH} -${i*t.SPACESHIP_THRUSTER_SIDE_HEIGHT} L ${i*t.SPACESHIP_THRUSTER_SIDE_LENGTH} 0 L ${i*t.SPACESHIP_THRUSTER_SIDE_WIDTH} ${i*t.SPACESHIP_THRUSTER_SIDE_HEIGHT} Z`,{fill:"#0088ff",opacity:t.SPACESHIP_THRUSTER_SIDE_OPACITY});return S.appendChild(c),_.appendChild(s),_.appendChild(A),_.appendChild(T),_.appendChild(n),_.appendChild(S),_}updateSpaceshipThrusters(e,r,i=!1){const a=e.querySelector("#mainThruster"),_=e.querySelector("#leftThruster"),s=e.querySelector("#rightThruster");if(!a||!_||!s)return;const A=i?t.SPACESHIP_THRUSTER_BOOST_OPACITY:t.SPACESHIP_THRUSTER_BASE_OPACITY,T=t.SPACESHIP_THRUSTER_FADE_SPEED;if(r.y>0)a.setAttribute("opacity",A);else{const t=parseFloat(a.getAttribute("opacity"))||0,e=Math.max(0,t-T);a.setAttribute("opacity",e)}if(r.x>0)_.setAttribute("opacity",A*t.SPACESHIP_THRUSTER_SIDE_OPACITY);else{const t=parseFloat(_.getAttribute("opacity"))||0,e=Math.max(0,t-T);_.setAttribute("opacity",e)}if(r.x<0)s.setAttribute("opacity",A*t.SPACESHIP_THRUSTER_SIDE_OPACITY);else{const t=parseFloat(s.getAttribute("opacity"))||0,e=Math.max(0,t-T);s.setAttribute("opacity",e)}}createPlanet(e,r,i,a={}){const _=this.createGroup({transform:`translate(${e}, ${r})`,...a}),s=a.surfaceColor||"#8b4513",A=a.coreColor||"#654321",T=a.atmosphereColor||"#4444ff",E=this.createGradient("radial",[{offset:"0%",color:s},{offset:"70%",color:A},{offset:"100%",color:"#2c1810"}],{cx:"30%",cy:"30%"}),I=this.createCircle(0,0,i,{fill:`url(#${E})`,stroke:T,"stroke-width":2,opacity:t.RATIO_OPACITY_HIGH});return _.appendChild(I),this.addPlanetCraters(_,i,s),this.addPlanetContinents(_,i,s),this.addPlanetAtmosphere(_,i,T),_}addPlanetCraters(e,r,i){const a=t.PLANET_CRATER_MIN+Math.floor(Math.random()*t.PLANET_CRATER_MAX);for(let _=0;_<a;_++){const a=Math.random()*Math.PI*t.FULL_CIRCLE,_=Math.random()*r*t.PLANET_CRATER_DISTANCE_MAX,s=Math.cos(a)*_,A=Math.sin(a)*_,T=Math.random()*r*t.PLANET_CRATER_SIZE_MAX+r*t.PLANET_CRATER_SIZE_MIN,E=this.createCircle(s,A,T,{fill:this.darkenColor(i,t.PLANET_DARKEN_FACTOR),opacity:.8}),I=this.createCircle(s,A,T*t.PLANET_CRATER_RIM_RATIO,{fill:"none",stroke:this.lightenColor(i,t.PLANET_LIGHTEN_FACTOR),"stroke-width":1,opacity:.6});e.appendChild(E),e.appendChild(I)}}addPlanetContinents(e,r,i){const a=t.PLANET_CONTINENT_MIN+Math.floor(Math.random()*t.PLANET_CONTINENT_MAX);for(let _=0;_<a;_++){const a=Math.random()*Math.PI*t.FULL_CIRCLE,_=Math.random()*r*t.PLANET_CONTINENT_DISTANCE_MAX,s=Math.cos(a)*_,A=Math.sin(a)*_,T=t.PLANET_CONTINENT_POINTS_MIN+Math.floor(Math.random()*t.PLANET_CONTINENT_POINTS_MAX);let E="";for(let e=0;e<T;e++){const i=e/T*2*Math.PI,a=r*(t.PLANET_CONTINENT_RADIUS_MIN+Math.random()*t.PLANET_CONTINENT_RADIUS_MAX),_=s+Math.cos(i)*a,I=A+Math.sin(i)*a;E+=0===e?`M ${_} ${I}`:` L ${_} ${I}`}E+=" Z";const I=this.createPath(E,{fill:this.lightenColor(i,t.PLANET_LIGHTEN_FACTOR),opacity:t.PLANET_CONTINENT_OPACITY,"clip-path":`circle(${r}px at 0px 0px)`});e.appendChild(I)}}addPlanetAtmosphere(e,r,i){const a=this.createGradient("radial",[{offset:"85%",color:i,opacity:0},{offset:"100%",color:i,opacity:.3}],{cx:"50%",cy:"50%"}),_=this.createCircle(0,0,r*t.GLOW_INTENSITY,{fill:`url(#${a})`,opacity:.6});e.appendChild(_)}darkenColor(e,r){if(e.startsWith("#")){const i=e.slice(1);return`rgb(${Math.floor(parseInt(i.slice(t.HEX_RED_START,t.HEX_RED_END),16)*(1-r))}, ${Math.floor(parseInt(i.slice(t.HEX_GREEN_START,t.HEX_GREEN_END),16)*(1-r))}, ${Math.floor(parseInt(i.slice(t.HEX_BLUE_START,t.HEX_BLUE_END),16)*(1-r))})`}return e}lightenColor(e,r){if(e.startsWith("#")){const i=e.slice(1);return`rgb(${Math.min(t.COLOR_MAX,Math.floor(parseInt(i.slice(t.HEX_RED_START,t.HEX_RED_END),16)*(1+r)))}, ${Math.min(t.COLOR_MAX,Math.floor(parseInt(i.slice(t.HEX_GREEN_START,t.HEX_GREEN_END),16)*(1+r)))}, ${Math.min(t.COLOR_MAX,Math.floor(parseInt(i.slice(t.HEX_BLUE_START,t.HEX_BLUE_END),16)*(1+r)))})`}return e}createSpaceStation(e,r,i=t.STATION_DEFAULT_SIZE,a={}){const _=this.createGroup({transform:`translate(${e}, ${r})`,...a}),s=this.createCircle(0,0,i*t.STATION_HUB_RATIO,{fill:"#666666",stroke:"#aaaaaa","stroke-width":2}),A=this.createCircle(0,0,i*t.STATION_RING_RATIO,{fill:"none",stroke:"#888888","stroke-width":i*t.STATION_RING_WIDTH,opacity:t.STATION_RING_OPACITY});for(let e=0;e<t.STATION_DOCKING_PORTS;e++){const r=e*t.ANGLE_90*Math.PI/t.ANGLE_180,a=Math.cos(r)*i,s=Math.sin(r)*i,A=this.createRect(a-i*t.STATION_PORT_WIDTH,s-i*t.STATION_PORT_HEIGHT,i*t.STATION_PORT_LENGTH,i*t.STATION_PORT_WIDTH,{fill:"#4a90e2",stroke:"#ffffff","stroke-width":1,transform:`rotate(${e*t.ANGLE_90}, ${a}, ${s})`});_.appendChild(A)}for(let e=0;e<t.STATION_SOLAR_PANELS;e++){const r=e*t.ANGLE_60*Math.PI/t.ANGLE_180,a=Math.cos(r)*i*t.STATION_PANEL_DISTANCE,s=Math.sin(r)*i*t.STATION_PANEL_DISTANCE,A=this.createRect(a-i*t.STATION_PANEL_WIDTH,s-i*t.STATION_PANEL_HEIGHT,i*t.STATION_PANEL_LENGTH,i*t.STATION_PANEL_WIDTH,{fill:"#1a1a3a",stroke:"#4444ff","stroke-width":1,opacity:t.STATION_PANEL_OPACITY,transform:`rotate(${e*t.ANGLE_60}, ${a}, ${s})`});_.appendChild(A)}const T=this.createRect(-i*t.STATION_COMM_WIDTH,-i*t.STATION_COMM_HEIGHT,i*t.STATION_COMM_LENGTH,i*t.STATION_COMM_WIDTH_RATIO,{fill:"#cccccc",stroke:"#ffffff","stroke-width":1});_.appendChild(s),_.appendChild(A),_.appendChild(T);const E=this.createCircle(-i*t.STATION_NAV_LIGHT_RATIO,0,i*t.STATION_NAV_LIGHT_SIZE,{fill:"#ff4444",opacity:t.STATION_NAV_LIGHT_OPACITY}),I=this.createCircle(i*t.STATION_NAV_LIGHT_RATIO,0,i*t.STATION_NAV_LIGHT_SIZE,{fill:"#44ff44",opacity:t.STATION_NAV_LIGHT_OPACITY});return _.appendChild(E),_.appendChild(I),_}createJumpGate(e,r,i=t.GATE_DEFAULT_SIZE,a={}){const _=this.createGroup({transform:`translate(${e}, ${r})`,...a}),s=this.createCircle(0,0,i,{fill:"none",stroke:"#00ffff","stroke-width":i*t.GATE_OUTER_STROKE_RATIO,opacity:t.GATE_OUTER_OPACITY,"stroke-dasharray":`${i*t.GATE_DASH_ARRAY_LONG} ${i*t.GATE_DASH_ARRAY_SHORT}`}),A=this.createCircle(0,0,i*t.GATE_INNER_RATIO,{fill:"none",stroke:"#ffffff","stroke-width":i*t.GATE_INNER_STROKE_RATIO,opacity:t.GATE_INNER_OPACITY}),T=this.createCircle(0,0,i*t.GATE_CORE_RATIO,{fill:"#00ffff",opacity:t.GATE_CORE_OPACITY,"fill-rule":"evenodd"});for(let e=0;e<t.GATE_STRUT_COUNT;e++){const r=e*t.ANGLE_90*Math.PI/t.ANGLE_180,a=Math.cos(r)*i*t.GATE_STRUT_INNER_RATIO,s=Math.sin(r)*i*t.GATE_STRUT_INNER_RATIO,A=Math.cos(r)*i*t.GATE_STRUT_OUTER_RATIO,T=Math.sin(r)*i*t.GATE_STRUT_OUTER_RATIO,E=this.createElement("line");E.setAttribute("x1",a),E.setAttribute("y1",s),E.setAttribute("x2",A),E.setAttribute("y2",T),E.setAttribute("stroke","#aaaaaa"),E.setAttribute("stroke-width",i*t.GATE_STRUT_WIDTH),_.appendChild(E)}const E=this.createGroup({id:`particles_${this.generateId("gate")}`});for(let e=0;e<t.GATE_PARTICLES;e++){const r=e*t.ANGLE_45*Math.PI/t.ANGLE_180,a=Math.cos(r)*i*t.GATE_PARTICLE_DISTANCE,_=Math.sin(r)*i*t.GATE_PARTICLE_DISTANCE,s=this.createCircle(a,_,i*t.GATE_PARTICLE_SIZE,{fill:"#00ffff",opacity:t.GATE_PARTICLE_OPACITY});E.appendChild(s)}const I=this.createElement("animateTransform");I.setAttribute("attributeName","transform"),I.setAttribute("type","rotate"),I.setAttribute("values","0 0 0;360 0 0"),I.setAttribute("dur",t.GATE_ANIMATION_DURATION_ROTATE),I.setAttribute("repeatCount","indefinite"),E.appendChild(I),_.appendChild(E),_.appendChild(T),_.appendChild(A),_.appendChild(s);const o=this.createElement("animate");o.setAttribute("attributeName","opacity"),o.setAttribute("values",`${t.GATE_PULSE_MIN};${t.GATE_PULSE_MAX};${t.GATE_PULSE_MIN}`),o.setAttribute("dur",t.GATE_ANIMATION_DURATION_PULSE),o.setAttribute("repeatCount","indefinite"),s.appendChild(o);const n=this.createElement("animate");return n.setAttribute("attributeName","opacity"),n.setAttribute("values",`${t.GATE_CORE_PULSE_MIN};${t.GATE_CORE_PULSE_MAX};${t.GATE_CORE_PULSE_MIN}`),n.setAttribute("dur",t.GATE_ANIMATION_DURATION_CORE),n.setAttribute("repeatCount","indefinite"),T.appendChild(n),_}addToLayer(t,e){return this.getLayer(t).appendChild(e),e}clear(){this.svg.innerHTML="",this.layers.clear(),this.defs=this.createDefs(),this.idCounter=0}remove(t){t.parentNode&&t.parentNode.removeChild(t)}createLaserBeam(e,r,i,a,_={}){const s=this.createGroup({id:this.generateId("laser"),..._}),A=this.createElement("line");A.setAttribute("x1",e),A.setAttribute("y1",r),A.setAttribute("x2",i),A.setAttribute("y2",a),A.setAttribute("stroke",_.color||"#ff0000"),A.setAttribute("stroke-width",_.width||t.LASER_DEFAULT_WIDTH),A.setAttribute("opacity",t.LASER_BEAM_OPACITY),A.setAttribute("stroke-linecap","round");const T=this.createElement("line");T.setAttribute("x1",e),T.setAttribute("y1",r),T.setAttribute("x2",i),T.setAttribute("y2",a),T.setAttribute("stroke",_.glowColor||"#ffaaaa"),T.setAttribute("stroke-width",(_.width||t.LASER_DEFAULT_WIDTH)*t.LASER_GLOW_MULTIPLIER),T.setAttribute("opacity",t.LASER_GLOW_OPACITY),T.setAttribute("stroke-linecap","round");const E=this.createElement("line");E.setAttribute("x1",e),E.setAttribute("y1",r),E.setAttribute("x2",i),E.setAttribute("y2",a),E.setAttribute("stroke","#ffffff"),E.setAttribute("stroke-width",1),E.setAttribute("opacity",t.LASER_CORE_OPACITY),E.setAttribute("stroke-linecap","round"),s.appendChild(T),s.appendChild(A),s.appendChild(E);const I=this.createElement("animate");return I.setAttribute("attributeName","opacity"),I.setAttribute("values","0;1;1;0"),I.setAttribute("dur",_.duration||"0.3s"),I.setAttribute("fill","freeze"),s.appendChild(I),setTimeout(()=>{this.remove(s)},parseFloat(_.duration||t.LASER_DEFAULT_DURATION)*t.SECONDS_TO_MS+t.LASER_CLEANUP_DELAY),s}createLaserImpact(e,r,i={}){const a=this.createGroup({id:this.generateId("impact"),transform:`translate(${e}, ${r})`}),_=this.createCircle(0,0,i.size||t.IMPACT_DEFAULT_SIZE,{fill:i.color||"#ffff00",opacity:t.RATIO_OPACITY_HIGH}),s=this.createCircle(0,0,(i.size||t.IMPACT_DEFAULT_SIZE)*t.IMPACT_RING_MULTIPLIER,{fill:"none",stroke:i.ringColor||"#ff8800","stroke-width":2,opacity:.7});for(let e=0;e<t.IMPACT_SPARKS;e++){const r=e*t.ANGLE_60*Math.PI/t.ANGLE_180,_=(i.size||t.IMPACT_DEFAULT_SIZE)*t.IMPACT_SPARK_DISTANCE,s=Math.cos(r)*_,A=Math.sin(r)*_,T=this.createElement("line");T.setAttribute("x1",0),T.setAttribute("y1",0),T.setAttribute("x2",s),T.setAttribute("y2",A),T.setAttribute("stroke","#ffffff"),T.setAttribute("stroke-width",1),T.setAttribute("opacity",t.IMPACT_SPARK_OPACITY),T.setAttribute("stroke-linecap","round"),a.appendChild(T)}a.appendChild(s),a.appendChild(_);const A=this.createElement("animateTransform");A.setAttribute("attributeName","transform"),A.setAttribute("type","scale"),A.setAttribute("values","0 0;1.5 1.5;0.5 0.5"),A.setAttribute("dur",i.duration||"0.4s"),A.setAttribute("fill","freeze"),A.setAttribute("additive","sum");const T=this.createElement("animate");return T.setAttribute("attributeName","opacity"),T.setAttribute("values","0;1;0"),T.setAttribute("dur",i.duration||"0.4s"),T.setAttribute("fill","freeze"),a.appendChild(A),a.appendChild(T),setTimeout(()=>{this.remove(a)},parseFloat(i.duration||t.IMPACT_DEFAULT_DURATION)*t.SECONDS_TO_MS+t.IMPACT_CLEANUP_DELAY),a}createProjectile(e,r,i="plasma",a={}){const _=this.createGroup({id:this.generateId("projectile"),transform:`translate(${e}, ${r})`,...a});if("plasma"===i){const e=this.createCircle(0,0,t.PROJECTILE_PLASMA_CORE,{fill:"#00ffff",opacity:t.RATIO_OPACITY_HIGH}),r=this.createCircle(0,0,t.PROJECTILE_PLASMA_GLOW,{fill:"#00aaff",opacity:t.PROJECTILE_PLASMA_GLOW_OPACITY}),i=this.createCircle(0,0,t.PROJECTILE_PLASMA_TRAIL,{fill:"none",stroke:"#0088ff","stroke-width":t.PROJECTILE_PLASMA_TRAIL_WIDTH,opacity:t.PROJECTILE_PLASMA_TRAIL_OPACITY});_.appendChild(i),_.appendChild(r),_.appendChild(e)}else if("missile"===i){const e=this.createPath("M -8 0 L 8 -2 L 10 0 L 8 2 Z",{fill:"#666666",stroke:"#aaaaaa","stroke-width":t.PROJECTILE_MISSILE_STROKE_WIDTH}),r=this.createCircle(t.PROJECTILE_MISSILE_WIDTH,0,t.PROJECTILE_MISSILE_WARHEAD,{fill:"#ff4444",opacity:t.PROJECTILE_MISSILE_WARHEAD_OPACITY}),i=this.createPath("M -8 0 L -15 -1 L -12 0 L -15 1 Z",{fill:"#ff8800",opacity:t.PROJECTILE_MISSILE_EXHAUST_OPACITY});_.appendChild(i),_.appendChild(e),_.appendChild(r)}else if("railgun"===i){const e=this.createRect(-t.PROJECTILE_RAILGUN_WIDTH/2,-t.PROJECTILE_RAILGUN_HEIGHT/2,t.PROJECTILE_RAILGUN_WIDTH,t.PROJECTILE_RAILGUN_HEIGHT,{fill:"#ffff00",opacity:t.RATIO_OPACITY_HIGH}),r=this.createRect(-t.PROJECTILE_RAILGUN_FIELD_WIDTH/2,-t.PROJECTILE_RAILGUN_FIELD_HEIGHT/2,t.PROJECTILE_RAILGUN_FIELD_WIDTH,t.PROJECTILE_RAILGUN_FIELD_HEIGHT,{fill:"none",stroke:"#ffff88","stroke-width":t.PROJECTILE_RAILGUN_FIELD_WIDTH_STROKE,opacity:t.PROJECTILE_RAILGUN_FIELD_OPACITY});_.appendChild(r),_.appendChild(e)}return _}createExplosion(e,r,i=t.EXPLOSION_DEFAULT_SIZE,a={}){const _=this.createGroup({id:this.generateId("explosion"),transform:`translate(${e}, ${r})`}),s=a.colors||["#ff4444","#ff8800","#ffff00","#ffffff"],A=t.EXPLOSION_RINGS;for(let e=0;e<A;e++){const r=this.createCircle(0,0,i*(t.EXPLOSION_RING_BASE+e*t.EXPLOSION_RING_INCREMENT),{fill:"none",stroke:s[e]||s[s.length-1],"stroke-width":i*t.EXPLOSION_STROKE_WIDTH,opacity:t.EXPLOSION_RING_OPACITY_BASE-e*t.EXPLOSION_RING_OPACITY_DECREMENT});_.appendChild(r)}const T=this.createCircle(0,0,i*t.EXPLOSION_FLASH_RATIO,{fill:"#ffffff",opacity:t.EXPLOSION_FLASH_OPACITY});for(let e=0;e<t.EXPLOSION_PARTICLES;e++){const r=e*t.ANGLE_30*Math.PI/t.ANGLE_180,a=i*t.EXPLOSION_PARTICLE_DISTANCE,s=Math.cos(r)*a,A=Math.sin(r)*a,T=this.createCircle(s,A,t.EXPLOSION_PARTICLE_SIZE,{fill:"#ffaa00",opacity:t.EXPLOSION_PARTICLE_OPACITY});_.appendChild(T)}_.appendChild(T);const E=this.createElement("animateTransform");E.setAttribute("attributeName","transform"),E.setAttribute("type","scale"),E.setAttribute("values","0 0;2 2;1 1"),E.setAttribute("dur",a.duration||t.EXPLOSION_DEFAULT_DURATION),E.setAttribute("fill","freeze"),E.setAttribute("additive","sum");const I=this.createElement("animate");return I.setAttribute("attributeName","opacity"),I.setAttribute("values","0;1;0"),I.setAttribute("dur",a.duration||t.EXPLOSION_DEFAULT_DURATION),I.setAttribute("fill","freeze"),_.appendChild(E),_.appendChild(I),setTimeout(()=>{this.remove(_)},parseFloat(a.duration||t.EXPLOSION_DEFAULT_DURATION)*t.SECONDS_TO_MS+t.EXPLOSION_CLEANUP_DELAY),_}createShieldEffect(e,r,i=t.SHIELD_DEFAULT_RADIUS,a={}){const _=this.createGroup({id:this.generateId("shield"),transform:`translate(${e}, ${r})`}),s=a.color||"#00aaff",A=this.createPath(`M ${i} 0 L ${i*t.SHIELD_HEX_RATIO} ${i*t.SHIELD_HEX_RATIO_LONG} L ${-i*t.SHIELD_HEX_RATIO} ${i*t.SHIELD_HEX_RATIO_LONG} \n             L ${-i} 0 L ${-i*t.SHIELD_HEX_RATIO} ${-i*t.SHIELD_HEX_RATIO_LONG} L ${i*t.SHIELD_HEX_RATIO} ${-i*t.SHIELD_HEX_RATIO_LONG} Z`,{fill:"none",stroke:s,"stroke-width":t.SHIELD_STROKE_WIDTH,opacity:t.SHIELD_HEX_OPACITY}),T=this.createCircle(0,0,i*t.SHIELD_FIELD_RATIO,{fill:s,opacity:t.SHIELD_FIELD_OPACITY});for(let e=0;e<t.SHIELD_LINES;e++){const r=e*t.ANGLE_60*Math.PI/t.ANGLE_180,a=Math.cos(r)*i*t.SHIELD_LINE_LENGTH,A=Math.sin(r)*i*t.SHIELD_LINE_LENGTH,T=this.createElement("line");T.setAttribute("x1",0),T.setAttribute("y1",0),T.setAttribute("x2",a),T.setAttribute("y2",A),T.setAttribute("stroke",s),T.setAttribute("stroke-width",t.SHIELD_LINE_WIDTH),T.setAttribute("opacity",t.SHIELD_LINE_OPACITY),_.appendChild(T)}_.appendChild(T),_.appendChild(A);const E=this.createElement("animate");return E.setAttribute("attributeName","opacity"),E.setAttribute("values",`${t.SHIELD_PULSE_MIN};${t.SHIELD_PULSE_MAX};${t.SHIELD_PULSE_MIN}`),E.setAttribute("dur",t.SHIELD_PULSE_DURATION),E.setAttribute("repeatCount","indefinite"),_.appendChild(E),_}animate(e,r,i=t.CLEANUP_DELAY_MS,a="ease-in-out"){const _=this.createElement("animateTransform");return _.setAttribute("attributeName","transform"),_.setAttribute("dur",`${i}ms`),_.setAttribute("fill","freeze"),r.transform&&(_.setAttribute("type",r.transform.type||"translate"),_.setAttribute("values",r.transform.values)),e.appendChild(_),new Promise(t=>{setTimeout(t,i)})}}